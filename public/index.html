<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åƒçº¸é›é¸¢-åœ¨çº¿ç­”é¢˜ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --primary-color: #667eea;
            --text-main: #2d3748;
            --text-secondary: #718096;
            --bg-color: #f0f2f5;
            --success-color: #48bb78;
            --error-color: #f56565;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius-lg: 16px;
            --radius-md: 8px;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        @media (max-width: 600px) {
            body::before {
                background-attachment: scroll;
            }
        }
        
        body.has-background::before {
            opacity: 1;
        }

        body { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            margin: 0; padding: 0; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            min-height: 100vh;
            display: flex; flex-direction: column;
            position: relative;
        }
        
        body.has-background .header,
        body.has-background .content-box,
        body.has-background .quiz-sidebar,
        body.has-background .challenge-sidebar,
        body.has-background .exam-card,
        body.has-background .background-settings-content {
            background: rgba(255, 255, 255, 0.85) !important;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        body.has-background .content-box {
            background: rgba(255, 255, 255, 0.9) !important;
        }

        body.has-background .quiz-sidebar,
        body.has-background .challenge-sidebar {
            background: rgba(255, 255, 255, 0.9) !important;
        }

        body.has-background .exam-card {
            background: rgba(255, 255, 255, 0.88) !important;
        }
        
        .main-wrapper { flex: 1; padding: 20px; max-width: 1200px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 30px; padding: 20px; background: white; 
            border-radius: var(--radius-lg); box-shadow: var(--card-shadow);
            transition: background 0.3s ease, backdrop-filter 0.3s ease;
        }
        .brand { 
            font-size: 1.5rem; font-weight: 800; 
            background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            cursor: pointer;
        }

        .progress-container { display: flex; align-items: center; gap: 15px; font-size: 0.9rem; color: var(--text-secondary); font-weight: 500; }
        .progress-bar { width: 120px; height: 8px; background: #edf2f7; border-radius: 999px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary-gradient); width: 0%; transition: width 0.3s; border-radius: 999px; }

        .content-box { 
            background: white; 
            border-radius: var(--radius-lg); 
            padding: 30px; 
            box-shadow: var(--card-shadow); 
            animation: fadeIn 0.3s;
            transition: background 0.3s ease, backdrop-filter 0.3s ease;
        }
        
        .background-settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .background-settings-modal.open {
            display: flex;
        }
        .background-settings-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .background-preview {
            width: 100%;
            height: 200px;
            border-radius: var(--radius-md);
            object-fit: cover;
            margin-bottom: 15px;
            border: 2px solid #e2e8f0;
        }
        .background-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .background-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }
        .background-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .background-item.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
        }
        .background-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .background-item-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            font-size: 0.75rem;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .background-upload-zone {
            border: 2px dashed #cbd5e0;
            padding: 20px;
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 15px;
        }
        .background-upload-zone:hover {
            border-color: var(--primary-color);
            background: #f7fafc;
        }

        .quiz-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            position: relative;
        }
        .quiz-main {
            flex: 1;
            min-width: 0;
        }
        .quiz-sidebar {
            width: 280px;
            background: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            z-index: 1001; /* æé«˜åˆ°é®ç½©å±‚ä»¥ä¸Š */
            transition: transform 0.3s ease;
        }

        .sidebar-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 1001;
            border: none;
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(2px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .sidebar-overlay.open {
            display: block;
            opacity: 1;
        }

        .question-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .question-dot {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            border: 1px solid #e2e8f0;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
            background: white;
            color: var(--text-secondary);
        }
        .question-dot:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        .question-dot.active {
            background: #f3f0ff;
            border-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-color);
        }
        .question-dot.answered {
            background: #f0fdf4;
            border-color: var(--success-color);
            color: var(--success-color);
        }
        .question-dot.status-correct {
            background: #f0fdf4;
            border-color: var(--success-color);
            color: var(--success-color);
        }
        .question-dot.status-wrong {
            background: #fff5f5;
            border-color: var(--error-color);
            color: var(--error-color);
        }
        
        .question-dot.active {
            background: #f3f0ff !important;
            border-color: var(--primary-color) !important;
            color: var(--primary-color) !important;
            box-shadow: 0 0 0 1px var(--primary-color);
        }

        .exam-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .exam-card { 
            background: #ffffff; 
            border: 1px solid #e2e8f0; 
            border-radius: 12px; 
            padding: 22px; 
            transition: all 0.25s ease; 
            cursor: pointer; 
            position: relative; 
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .exam-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.12); 
            border-color: #cbd5e0; 
        }
        .exam-card::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 3px; 
            height: 100%; 
            background: var(--primary-gradient); 
            opacity: 0; 
            transition: opacity 0.25s; 
        }
        .exam-card:hover::before { opacity: 1; }
        
        .exam-card::after {
            content: 'åƒçº¸é›é¸¢';
            position: absolute;
            bottom: 25px;
            right: 20px;
            font-size: 70px;
            font-weight: 900;
            color: rgba(47, 182, 58, 0.04);
            line-height: 1;
            pointer-events: none;
            -webkit-user-select: none;
            user-select: none;
            transform: rotate(-12deg);
            font-family: 'Microsoft YaHei', 'SimHei', sans-serif;
            letter-spacing: 4px;
            opacity: 0.6;
        }
        
        .exam-title { 
            font-size: 1.25rem; 
            font-weight: 700; 
            color: var(--text-main); 
            margin-bottom: 10px; 
            line-height: 1.4; 
            position: relative;
            z-index: 1;
        }
        .exam-meta { 
            font-size: 0.85rem; 
            color: var(--text-secondary); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: 12px; 
            position: relative;
            z-index: 1;
        }
        .user-tag { 
            background: #f1f5f9; 
            padding: 4px 10px; 
            border-radius: 6px; 
            font-weight: 600; 
            font-size: 0.8rem; 
            color: #475569; 
        }

        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-title { font-size: 1.5rem; font-weight: 700; margin: 0; }

        .form-group { margin-bottom: 20px; text-align: left; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        .form-input { 
            width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: var(--radius-md); 
            font-size: 1rem; transition: border-color 0.2s; box-sizing: border-box;
        }
        .form-input:focus { border-color: var(--primary-color); outline: none; }
        
        .file-drop-zone { 
            border: 2px dashed #cbd5e0; padding: 40px; border-radius: var(--radius-md); 
            text-align: center; cursor: pointer; transition: all 0.2s; background: #f8fafc; margin-top: 10px;
        }
        .file-drop-zone:hover { border-color: var(--primary-color); background: #ebf8ff; }

        .question-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; line-height: 1.6; }
        .options { list-style: none; padding: 0; }
        .option-item { margin-bottom: 12px; }
        .option-item label { 
            display: flex; align-items: center; padding: 16px; border: 2px solid #e2e8f0; 
            border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; background: white;
        }
        .option-item label:hover { background: #f7fafc; border-color: #cbd5e0; }
        .option-item label.selected { border-color: var(--primary-color); background: #ebf8ff; }
        .option-item label.correct { border-color: var(--success-color); background: #f0fff4; }
        .option-item label.wrong { border-color: var(--error-color); background: #fff5f5; }
        .option-item input { margin-right: 15px; width: 18px; height: 18px; accent-color: var(--primary-color); }

        textarea { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: var(--radius-md); min-height: 100px; font-family: inherit; resize: vertical; box-sizing: border-box; }
        
        /* æŒ‰é’® */
        .btn { padding: 10px 20px; border-radius: var(--radius-md); border: none; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 4px 6px rgba(102, 126, 234, 0.25); }
        .btn-outline { background: white; border: 2px solid #e2e8f0; color: var(--text-main); }
        .btn-secondary { background: #edf2f7; color: var(--text-main); }

        /* è§£ææ¡† */
        .explanation-box { background: #fffaf0; border-left: 4px solid #ed8936; padding: 15px; border-radius: 4px; margin-top: 20px; }
        
        /* ç»“æœé¡µ */
        .result-box { text-align: center; padding: 40px 0; }
        .score-circle { width: 120px; height: 120px; background: var(--primary-gradient); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: 800; margin: 0 auto 20px; }

        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .footer { text-align: center; color: var(--text-secondary); font-size: 0.8rem; padding: 20px; }

        @media (max-width: 600px) {
            .main-wrapper { 
                padding: 8px; 
                max-width: 100%;
            }
            
            /* é¡¶éƒ¨æ ä¼˜åŒ– */
            .header { 
                padding: 12px; 
                margin-bottom: 12px; 
                flex-direction: column; 
                align-items: stretch; 
                gap: 12px; 
            }
            .header > div {
                display: flex;
                align-items: center;
                gap: 8px;
                flex-wrap: wrap;
            }
            .header > div:first-child {
                justify-content: space-between;
            }
            .brand { 
                font-size: 1rem; 
                flex: 1;
                min-width: 0;
            }
            .header .btn {
                padding: 8px 12px;
                font-size: 0.85rem;
                white-space: nowrap;
                flex-shrink: 0;
            }
            .progress-container { 
                width: 100%; 
                justify-content: space-between; 
                font-size: 0.8rem;
            }
            .progress-bar { 
                flex: 1; 
                max-width: none; 
                height: 6px;
            }
            
            /* å†…å®¹åŒºåŸŸä¼˜åŒ– */
            .content-box { 
                padding: 16px; 
                border-radius: 12px;
            }
            .question-title { 
                font-size: 1rem; 
                line-height: 1.5;
                margin-bottom: 16px;
            }
            .option-item label { 
                padding: 14px; 
                font-size: 0.9rem; 
                min-height: 44px; /* ç¡®ä¿è§¦æ‘¸ç›®æ ‡è¶³å¤Ÿå¤§ */
            }
            
            /* æ“ä½œæ ä¼˜åŒ– */
            .action-bar { 
                flex-wrap: wrap; 
                gap: 8px; 
                margin-bottom: 16px;
            }
            .action-bar > div {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                width: 100%;
            }
            .section-title { 
                font-size: 1.1rem; 
                margin-bottom: 0;
            }
            .action-bar .btn {
                padding: 10px 14px;
                font-size: 0.85rem;
                flex: 1;
                min-width: 0;
            }
            
            /* è¯•å·å¡ç‰‡ä¼˜åŒ– */
            .exam-grid { 
                grid-template-columns: 1fr; 
                gap: 12px;
                margin-top: 12px;
            }
            .exam-card { 
                padding: 16px; 
                border-radius: 10px;
            }
            .exam-card::after {
                font-size: 40px;
                bottom: 10px;
                right: 10px;
                opacity: 0.3;
            }
            .exam-title { 
                font-size: 1.05rem; 
                margin-bottom: 8px;
            }
            .exam-meta { 
                font-size: 0.8rem; 
                margin-top: 8px;
            }
            .user-tag {
                font-size: 0.75rem;
                padding: 3px 8px;
            }
            
            /* ç§»åŠ¨ç«¯æŠ½å±‰å¼å¯¼èˆª */
            .sidebar-toggle { 
                display: flex; 
                width: 44px;
                height: 44px;
            }
            .quiz-sidebar {
                position: fixed;
                top: 0;
                right: 0;
                bottom: 0;
                width: 85%;
                max-width: 320px;
                border-radius: 0;
                margin: 0;
                transform: translateX(100%);
                box-shadow: -4px 0 12px rgba(0,0,0,0.1);
                padding-top: env(safe-area-inset-top, 20px);
                padding: env(safe-area-inset-top, 20px) 16px 16px 16px;
            }
            .quiz-sidebar.open {
                transform: translateX(0);
            }
            .sidebar-overlay.open {
                display: block;
            }

            /* é¢˜ç›®å¯¼èˆªç½‘æ ¼ä¼˜åŒ– */
            .question-grid { 
                grid-template-columns: repeat(5, 1fr); 
                gap: 6px; 
                margin-top: 12px;
            }
            .question-dot { 
                font-size: 0.7rem; 
                min-height: 36px;
                padding: 4px;
                font-weight: 600;
            }

            /* æŒ‰é’®ä¼˜åŒ– */
            .controls { 
                flex-direction: column; 
                gap: 10px; 
            }
            .btn { 
                min-height: 44px; /* ç¡®ä¿è§¦æ‘¸ç›®æ ‡è¶³å¤Ÿå¤§ */
                padding: 12px 16px;
                font-size: 0.9rem;
            }
            .btn-primary, .btn-outline, .btn-secondary {
                width: 100%;
            }
            
            /* è¡¨å•ä¼˜åŒ– */
            .form-group {
                margin-bottom: 16px;
            }
            .form-label {
                font-size: 0.9rem;
                margin-bottom: 6px;
            }
            .form-input {
                padding: 12px;
                font-size: 0.9rem;
                min-height: 44px;
            }
            
            /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸä¼˜åŒ– */
            .file-drop-zone {
                padding: 24px 16px;
                min-height: 120px;
            }
            .file-drop-zone > div:first-child {
                font-size: 1.5rem;
            }
            .file-drop-zone > div:last-child {
                font-size: 0.85rem;
            }
            
            /* ä¸Šä¼ è¿›åº¦æ¡ä¼˜åŒ– */
            #upload-progress-box {
                padding: 16px;
            }
            #upload-logs {
                height: 60px;
                font-size: 0.75rem;
            }
            
            /* JSONæ¨¡æ¿åŒºåŸŸä¼˜åŒ– */
            #json-upload-group .file-drop-zone {
                padding: 20px 12px;
            }
            #json-template-pre {
                font-size: 0.7rem;
                padding: 10px;
                max-height: 200px;
            }
            
            /* èƒŒæ™¯è®¾ç½®å¼¹çª—ä¼˜åŒ– */
            .background-settings-modal {
                padding: 10px;
            }
            .background-settings-content {
                width: 100%;
                max-width: none;
                padding: 20px 16px;
                max-height: 90vh;
                margin: 0;
            }
            .background-settings-content h2 {
                font-size: 1.2rem;
            }
            .background-settings-content .btn-secondary {
                min-width: 44px;
                min-height: 44px;
                padding: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .background-preview {
                height: 150px;
            }
            .background-list {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
            .background-item {
                min-height: 80px;
            }
            .background-item-label {
                font-size: 0.7rem;
                padding: 4px;
            }
            .background-upload-zone {
                padding: 16px;
                min-height: 100px;
            }
            .background-upload-zone > div {
                font-size: 0.85rem;
            }
            
            /* æŒ‘æˆ˜æ¨¡å¼ä¾§è¾¹æ ä¼˜åŒ– */
            .challenge-sidebar {
                width: 85%;
                max-width: 320px;
            }
            
            /* é¡µè„šä¼˜åŒ– */
            .footer {
                padding: 16px;
                font-size: 0.75rem;
            }
            
            /* ç»“æœé¡µä¼˜åŒ– */
            .result-box {
                padding: 30px 0;
            }
            .score-circle {
                width: 100px;
                height: 100px;
                font-size: 2.5rem;
            }
        }

        @media (max-width: 900px) and (min-width: 601px) {
            .main-wrapper {
                padding: 15px;
            }
            .quiz-layout { 
                flex-direction: column; 
            }
            .quiz-sidebar { 
                width: 100%; 
                position: static; 
                max-height: none; 
                box-sizing: border-box; 
            }
            .exam-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .action-bar .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
        }
        
            /* è¶…å°å±å¹•ä¼˜åŒ– (å°äº400px) */
        @media (max-width: 400px) {
            .main-wrapper {
                padding: 6px;
            }
            .header {
                padding: 10px;
            }
            .brand {
                font-size: 0.9rem;
            }
            .header .btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            .content-box {
                padding: 12px;
            }
            .section-title {
                font-size: 1rem;
            }
            .action-bar .btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            .exam-card {
                padding: 12px;
            }
            .exam-title {
                font-size: 0.95rem;
            }
            .background-list {
                grid-template-columns: repeat(2, 1fr);
            }
            .question-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            .question-dot {
                font-size: 0.65rem;
                min-height: 32px;
            }
        }
        
        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (max-width: 900px) and (orientation: landscape) {
            .main-wrapper {
                padding: 10px;
            }
            .header {
                padding: 10px 15px;
                flex-direction: row;
                justify-content: space-between;
            }
            .header > div {
                flex: 1;
            }
            .content-box {
                padding: 16px;
            }
            .background-settings-content {
                max-height: 95vh;
            }
        }
    </style>
</head>
<body>

<div class="main-wrapper">
    <!-- é¡¶éƒ¨ -->
    <div class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="brand" onclick="toggleView('home')">åƒçº¸é›é¸¢Â·é¢˜åº“ç³»ç»ŸÂ·Online Quiz System</div>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <button class="btn btn-outline" style="padding: 8px;" onclick="toggleChallengeSidebar(true)">å†å²è®°å½•</button>
            <button class="btn btn-outline" style="padding: 8px;" onclick="openBackgroundSettings()">èƒŒæ™¯è®¾ç½®</button>
            <div class="progress-container" id="progress-container" style="display:none;">
                <span id="progress-text"></span>
                <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
            </div>
        </div>
    </div>
    
    <!-- èƒŒæ™¯è®¾ç½®å¼¹çª— -->
    <div id="background-settings-modal" class="background-settings-modal" onclick="if(event.target.id === 'background-settings-modal') closeBackgroundSettings()">
        <div class="background-settings-content" onclick="event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 1.5rem;">èƒŒæ™¯è®¾ç½®</h2>
                <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="closeBackgroundSettings()" title="å…³é—­">âœ•</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">å½“å‰èƒŒæ™¯é¢„è§ˆ</label>
                <img id="background-preview" class="background-preview" src="" alt="èƒŒæ™¯é¢„è§ˆ" style="display: none;">
                <div id="background-preview-placeholder" style="width: 100%; height: 200px; background: var(--bg-color); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                    æ— èƒŒæ™¯
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">é€‰æ‹©èƒŒæ™¯</label>
                <div class="background-list" id="background-list">
                    <div class="background-item" data-bg="default" onclick="selectBackground('default')">
                        <div style="width: 100%; height: 100%; background: var(--bg-color); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-weight: 600;">
                            é»˜è®¤
                        </div>
                        <div class="background-item-label">é»˜è®¤ï¼ˆæ— èƒŒæ™¯ï¼‰</div>
                    </div>
                    <!-- åŠ¨æ€åŠ è½½èƒŒæ™¯åˆ—è¡¨ -->
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">ä¸Šä¼ æ–°èƒŒæ™¯</label>
                <div class="background-upload-zone" onclick="document.getElementById('background-file-input').click()">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“·</div>
                    <div style="color: #4a5568; font-weight: 500;">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</div>
                    <input type="file" id="background-file-input" accept="image/*" style="display:none" onchange="handleBackgroundUpload()">
                </div>
                <input type="text" id="background-name-input" class="form-input" placeholder="ä¸ºèƒŒæ™¯å‘½åï¼ˆå¯é€‰ï¼‰" style="margin-top: 10px;">
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeBackgroundSettings()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- 1. é¦–é¡µï¼šè¯•å·åˆ—è¡¨ -->
    <div id="view-home">
        <div class="action-bar">
            <h2 class="section-title">é¢˜åº“åˆ—è¡¨</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-outline" style="border-color: #9333ea; color: #9333ea;" onclick="openChallengeConfig()">æŒ‘æˆ˜æ¨¡å¼</button>
                <button class="btn btn-outline" onclick="toggleView('api')">API æ–‡æ¡£</button>
                <button class="btn btn-primary" onclick="toggleView('upload')">+ ä¸Šä¼ æ–°é¢˜ç›®</button>
            </div>
        </div>
        
        <div id="exam-list" class="exam-grid">
            <!-- åŠ¨æ€æ¸²æŸ“ -->
            <p style="color: #718096; grid-column: 1/-1; text-align: center; padding: 40px;">æ­£åœ¨åŠ è½½é¢˜åº“...</p>
        </div>
    </div>

    <!-- 2. ä¸Šä¼ é¡µ -->
    <div id="view-upload" class="content-box hidden">
        <div class="action-bar">
            <h2 class="section-title">ä¸Šä¼ æ–°é¢˜ç›®</h2>
        </div>
        
        <div class="form-group">
            <label class="form-label">ä¸Šä¼ è€…å§“å</label>
            <input type="text" id="uploaderName" class="form-input" placeholder="ä¾‹å¦‚ï¼šyxyå¤§å¸…æ¯”">
        </div>
        
        <div class="form-group">
            <label class="form-label">ç§‘ç›®åç§° / è¯•å·æ ‡é¢˜</label>
            <input type="text" id="subjectName" class="form-input" placeholder="ä¾‹å¦‚ï¼š2024æœŸæœ«å¤ä¹ é¢˜">
        </div>

        <div class="form-group" id="docx-upload-group">
            <label class="form-label">é¢˜ç›®æ–‡æ¡£ (.docx)</label>
            <div class="file-drop-zone" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“„</div>
                <div id="fileName" style="color: #4a5568; font-weight: 500;">ç‚¹å‡»é€‰æ‹© Word æ–‡æ¡£</div>
                <input type="file" id="fileInput" accept=".docx" style="display:none" onchange="handleFileSelect()">
            </div>
        </div>

        <div class="form-group hidden" id="json-upload-group">
            <label class="form-label">JSON å¯¼å…¥</label>
            <div style="display: flex; gap: 16px; align-items: flex-start;">
                <!-- å·¦ä¾§ï¼šé€‰æ‹©æ–‡ä»¶ / ç²˜è´´ JSON -->
                <div style="flex: 1; min-width: 0;">
                    <div class="file-drop-zone" onclick="document.getElementById('jsonFileInput').click()">
                        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ§¾</div>
                        <div id="jsonFileName" style="color: #4a5568; font-weight: 500;">ç‚¹å‡»é€‰æ‹© JSON æ–‡ä»¶ï¼ˆ.jsonï¼‰</div>
                        <input type="file" id="jsonFileInput" accept=".json,application/json" style="display:none" onchange="handleJsonFileSelect()">
                    </div>

                    <div style="margin-top: 12px; font-size: 0.9rem; color: #718096; font-weight: 600;">æˆ–ç›´æ¥ç²˜è´´ JSONï¼š</div>
                    <textarea id="jsonTextInput" placeholder="ç²˜è´´ JSONï¼ˆæ”¯æŒï¼š[é¢˜ç›®æ•°ç»„] æˆ– {questions:[...] }ï¼‰" style="min-height: 160px;"></textarea>
                </div>

                <!-- å³ä¾§ï¼šæ ¼å¼è¯´æ˜ -->
                <div style="width: 420px; max-width: 45%; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 14px; box-sizing: border-box;">
                    <div style="display:flex; align-items:center; justify-content: space-between; gap: 10px; margin-bottom: 10px;">
                        <div style="font-weight: 800; color: #2d3748;">æœ¬ç³»ç»Ÿ JSON æ ¼å¼ç¤ºä¾‹ï¼ˆå¯ç…§æŠ„ï¼‰</div>
                        <button class="btn btn-outline" type="button" style="padding: 6px 10px; font-size: 0.8rem;" onclick="copyJsonTemplate()">ä¸€é”®å¤åˆ¶</button>
                    </div>
                    <div style="font-size: 0.85rem; color: #718096; line-height: 1.5; margin-bottom: 10px;">
                        é¡¶å±‚å»ºè®®ä¸ºæ•°ç»„ï¼š<code>[{...},{...}]</code>ã€‚æ¯é¢˜å­—æ®µï¼š<code>title</code> / <code>type</code> / <code>options</code> / <code>answer</code> / <code>explanation</code>
                    </div>
                    <pre id="json-template-pre" style="margin:0; white-space: pre-wrap; font-size: 0.8rem; line-height: 1.45; color: #2d3748; background: white; border: 1px solid #edf2f7; border-radius: 10px; padding: 12px; overflow:auto; max-height: 360px;">[
  {
    "type": "å•é€‰é¢˜",
    "title": "æ´»åŠ¨å›¾å¯ä»¥ç”¨æ¥åšä»€ä¹ˆï¼Ÿ",
    "options": [
      { "label": "A", "content": "å¯¹ä¸šåŠ¡æµç¨‹å»ºæ¨¡" },
      { "label": "B", "content": "å¯¹ç”¨ä¾‹äº¤äº’å»ºæ¨¡" },
      { "label": "C", "content": "ä»¥ä¸Šéƒ½æ˜¯" }
    ],
    "answer": "C",
    "explanation": "æ´»åŠ¨å›¾å¸¸ç”¨äºä¸šåŠ¡æµç¨‹å»ºæ¨¡ä¸ç”¨ä¾‹äº¤äº’å»ºæ¨¡ã€‚"
  },
  {
    "type": "å¤šé€‰é¢˜",
    "title": "å¯¹ä¸šåŠ¡æµç¨‹å»ºæ¨¡æ—¶å¯ä»¥å°è¯•åº”ç”¨å“ªäº›æ­¥éª¤ï¼Ÿ",
    "options": [
      { "label": "A", "content": "é€‰æ‹©æè¿°è¿‡ç¨‹" },
      { "label": "B", "content": "æå–æ´»åŠ¨èŠ‚ç‚¹" },
      { "label": "C", "content": "æ·»åŠ å¼€å§‹å’Œç»“æŸèŠ‚ç‚¹" }
    ],
    "answer": "ABC",
    "explanation": ""
  },
  {
    "type": "åˆ¤æ–­é¢˜",
    "title": "æ´»åŠ¨å›¾åªèƒ½ç”¨äºä¸šåŠ¡æµç¨‹å»ºæ¨¡ã€‚",
    "options": [],
    "answer": "é”™è¯¯",
    "explanation": "æ´»åŠ¨å›¾è¿˜å¯ç”¨äºç”¨ä¾‹äº¤äº’å»ºæ¨¡ã€‚"
  },
  {
    "type": "ç®€ç­”é¢˜",
    "title": "ç®€è¿°æ´»åŠ¨å›¾çš„å»ºæ¨¡æŠ€æœ¯ã€‚",
    "options": [],
    "answer": "æ´»åŠ¨å›¾å¯ç”¨äºä¸šåŠ¡æµç¨‹å»ºæ¨¡ä¸ç”¨ä¾‹äº¤äº’å»ºæ¨¡â€¦â€¦",
    "explanation": ""
  }
]</pre>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">è§£ææ¨¡å¼</label>
            <div style="display: flex; gap: 15px;">
                <label style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; display: flex; align-items: center;">
                    <input type="radio" name="uploadMode" value="normal" checked style="margin-right: 10px;" onchange="onUploadModeChange()">
                    <div>
                        <div style="font-weight: 600;">æ™®é€šä¸Šä¼ </div>
                        <div style="font-size: 0.8rem; color: #718096;">ä½¿ç”¨æ­£åˆ™è§£æï¼Œå…è´¹ï¼Œé€‚åˆæ ‡å‡†æ ¼å¼</div>
                    </div>
                </label>
                <label style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; display: flex; align-items: center;">
                    <input type="radio" name="uploadMode" value="ai" style="margin-right: 10px;" onchange="onUploadModeChange()">
                    <div>
                        <div style="font-weight: 600; color: #667eea;">AI æé€Ÿè§£æ</div>
                        <div style="font-size: 0.8rem; color: #718096;">ä½¿ç”¨ AI å¤§æ¨¡å‹ï¼Œç²¾å‡†è¯†åˆ«å¤æ‚æ ¼å¼</div>
                    </div>
                </label>
                <label style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; display: flex; align-items: center;">
                    <input type="radio" name="uploadMode" value="json" style="margin-right: 10px;" onchange="onUploadModeChange()">
                    <div>
                        <div style="font-weight: 600; color: #9333ea;">JSON å¯¼å…¥</div>
                        <div style="font-size: 0.8rem; color: #718096;">è·³è¿‡è§£æï¼ŒæŒ‰æ¨¡æ¿ç›´æ¥å…¥åº“ï¼ˆæœ€ç¨³ï¼‰</div>
                    </div>
                </label>
            </div>
        </div>

        <div style="text-align: right; margin-top: 30px;">
            <button class="btn btn-secondary" onclick="toggleView('home')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="uploadFile()">ç¡®è®¤ä¸Šä¼ </button>
        </div>
        
        <!-- ä¸Šä¼ è¿›åº¦æ¡ -->
        <div id="upload-progress-box" style="display:none; margin-top: 25px; padding: 20px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.95rem; font-weight: 600; color: #2d3748;">
                <span id="upload-status-text">å‡†å¤‡ä¸Šä¼ ...</span>
                <span id="upload-percent" style="color: var(--primary-color);">0%</span>
            </div>
            
            <!-- è¿›åº¦æ¡è½¨é“ -->
            <div style="width:100%; height:12px; background:#edf2f7; border-radius:999px; overflow:hidden; position: relative; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);">
                <div id="upload-progress-bar" style="width:0%; height:100%; background:var(--primary-gradient); border-radius: 999px; position: relative; box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);">
                    <!-- æµå…‰åŠ¨ç”»å±‚ -->
                    <div style="position: absolute; top: 0; left: 0; bottom: 0; right: 0; background-image: linear-gradient(45deg,rgba(255,255,255,.2) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.2) 50%,rgba(255,255,255,.2) 75%,transparent 75%,transparent); background-size: 20px 20px; animation: progress-stripes 0.5s linear infinite;"></div>
                </div>
            </div>

            <!-- å®æ—¶æ—¥å¿—åŒºåŸŸ -->
            <div id="upload-logs" style="margin-top: 15px; height: 80px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; color: #718096; background: white; padding: 10px; border-radius: 6px; border: 1px solid #edf2f7; scroll-behavior: smooth;">
                <div style="color: #a0aec0;">ç­‰å¾…ä»»åŠ¡å¼€å§‹...</div>
            </div>
        </div>
        
        <p id="uploadStatus" style="text-align: center; margin-top: 15px; font-weight: 500; display:none;"></p>
    </div>

    <style>
        @keyframes progress-stripes {
            from { background-position: 20px 0; }
            to { background-position: 0 0; }
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        #upload-logs::-webkit-scrollbar { width: 4px; }
        #upload-logs::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
        .log-item { margin-bottom: 4px; animation: fadeIn 0.2s; }
        .log-item.highlight { color: var(--primary-color); font-weight: bold; }
        
        /* æŒ‘æˆ˜æ¨¡å¼ç›¸å…³ */
        .challenge-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 300px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1100;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .challenge-sidebar.open { transform: translateX(0); }
        .challenge-history-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .history-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .history-card:hover { border-color: var(--primary-color); background: #f0f7ff; }
        .history-score { font-size: 1.2rem; font-weight: 800; color: var(--primary-color); }
        
        .multi-select-list {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
        }
        .select-item {
            display: flex;
            align-items: center;
            padding: 8px;
            gap: 10px;
            cursor: pointer;
        }
        .select-item:hover { background: #f7fafc; }

        /* AI åŠ©æ‰‹ç›¸å…³ */
        .ai-btn {
            background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%);
            color: white;
            margin-top: 15px;
            font-size: 0.85rem;
            padding: 8px 16px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.2s;
        }
        .ai-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3); }
        /* æ€è€ƒä¸­çš„åŠ¨ç”» */
        .ai-btn.thinking {
            background: linear-gradient(90deg, #a855f7, #d946ef, #a855f7);
            background-size: 200% 100%;
            animation: ai-thinking 1.5s linear infinite;
            cursor: not-allowed;
        }
        @keyframes ai-thinking {
            0% { background-position: 100% 0; }
            100% { background-position: -100% 0; }
        }

        .ai-box {
            margin-top: 15px;
            background: #fdf4ff;
            border: 1px solid #f0abfc;
            border-radius: 8px;
            padding: 15px;
            animation: fadeIn 0.3s;
        }
        .ai-title {
            font-weight: 700;
            color: #9333ea;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ai-content {
            font-size: 0.95rem;
            color: #4a5568;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* --- æŒ‘æˆ˜æ¨¡å¼æ ·å¼ --- */
        .challenge-layout {
            display: flex;
            gap: 24px;
            height: calc(100vh - 140px);
            min-height: 500px;
        }
        .challenge-main {
            flex: 1;
            background: white;
            border-radius: var(--radius-lg);
            padding: 30px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .challenge-sidebar {
            width: 320px;
            background: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
        }
        .history-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 15px;
            padding-right: 5px;
        }
        .history-item {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }
        .history-item:hover {
            border-color: #cbd5e0;
            background: #f7fafc;
            border-left-color: var(--primary-color);
        }
        .history-meta {
            font-size: 0.8rem;
            color: #718096;
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
        }
        .history-score {
            font-weight: 800;
            color: var(--primary-color);
        }
        .score-badge {
            background: #ebf4ff;
            color: #4299e1;
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        .challenge-select {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 20px;
            background: white;
        }
        
        @media (max-width: 768px) {
            .challenge-layout { 
                flex-direction: column; 
                height: auto; 
                gap: 16px;
            }
            .challenge-sidebar { 
                width: 100%; 
                max-height: 400px; 
            }
            .challenge-main {
                padding: 20px;
            }
        }
        
        /* ç§»åŠ¨ç«¯æŒ‘æˆ˜æ¨¡å¼ä¼˜åŒ– */
        @media (max-width: 600px) {
            .challenge-layout {
                gap: 12px;
            }
            .challenge-main {
                padding: 16px;
            }
            .challenge-sidebar {
                padding: 16px;
            }
            .challenge-select {
                font-size: 0.9rem;
                padding: 10px;
            }
            .multi-select-list {
                max-height: 250px;
            }
            .select-item {
                padding: 10px;
                min-height: 44px;
            }
        }
    </style>

    <!-- 3. ç­”é¢˜é¡µ -->
    <div id="view-quiz" class="hidden">
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar(false)"></div>
        <button class="sidebar-toggle" onclick="toggleSidebar(true)">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
        <div class="quiz-layout">
            <div class="quiz-main content-box">
                <div class="action-bar" style="align-items: flex-start;">
                    <div style="display: flex; flex-direction: column;">
                        <h3 id="quiz-subject-title" style="margin:0; font-size:1.1rem; word-break: break-all; padding-right: 10px;">æ­£åœ¨ç­”é¢˜</h3>
                        <div id="quiz-mode-tag" style="font-size: 0.75rem; margin-top: 4px; display: none;">
                            <span style="background: #fdf2f8; color: #db2777; padding: 2px 6px; border-radius: 4px; font-weight: 700; border: 1px solid #fbcfe8;">æŒ‘æˆ˜æ¨¡å¼</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem; flex-shrink: 0;" onclick="exitQuiz()">é€€å‡º</button>
                </div>
                
                <div id="question-container"></div>
                
                <div style="display: flex; justify-content: flex-end; margin-top: 30px; border-top: 1px solid #edf2f7; padding-top: 20px;">
                    <button class="btn btn-primary" id="btn-action" onclick="handleAction()">æäº¤æœ¬é¢˜</button>
                </div>
            </div>
            
            <div class="quiz-sidebar" id="quiz-sidebar">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0; font-size: 1rem; color: var(--text-main);">é¢˜ç›®å¯¼èˆª</h4>
                    <button class="btn-secondary" style="border:none; background:none; cursor:pointer; display:none;" id="mobile-close-sidebar" onclick="toggleSidebar(false)">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">
                    å·²ç­”: <span id="answered-count">0</span> / <span id="total-count">0</span>
                </div>
                <div id="question-nav-grid" class="question-grid">
                    <!-- åŠ¨æ€ç”Ÿæˆé¢˜å· -->
                </div>
            </div>
        </div>
    </div>

    <!-- æŒ‘æˆ˜è®°å½•ä¾§è¾¹æ  -->
    <div id="challenge-sidebar" class="challenge-sidebar">
        <div style="padding: 20px; border-bottom: 1px solid #edf2f7; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 1.2rem;">æŒ‘æˆ˜å†å²è®°å½•</h3>
            <button class="btn-secondary" style="border:none; background:none; cursor:pointer;" onclick="toggleChallengeSidebar(false)">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div id="challenge-history-list" class="challenge-history-list">
            <!-- å†å²è®°å½• -->
        </div>
    </div>
    <div class="sidebar-overlay" id="challenge-overlay" onclick="toggleChallengeSidebar(false)"></div>

    <!-- 6. æŒ‘æˆ˜æ¨¡å¼é…ç½®é¡µ -->
    <div id="view-challenge" class="content-box hidden">
        <div class="action-bar">
            <h2 class="section-title">å¼€å¯æŒ‘æˆ˜</h2>
            <button class="btn btn-secondary" onclick="toggleView('home')">è¿”å›</button>
        </div>
        
        <p style="color: var(--text-secondary); margin-bottom: 30px;">é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªé¢˜åº“ï¼Œç³»ç»Ÿå°†ä»ä¸­éšæœºæŠ½å–é¢˜ç›®ç»„æˆæŒ‘æˆ˜ã€‚</p>

        <div class="form-group">
            <label class="form-label">é€‰æ‹©é¢˜åº“ (å¯å¤šé€‰)</label>
            <div id="challenge-exam-list" class="multi-select-list">
                <!-- é¢˜åº“åˆ—è¡¨ -->
            </div>
        </div>

        <div class="form-group" style="margin-top: 25px;">
            <label class="form-label">é€‰æ‹©é¢˜å‹ (å¯å¤šé€‰)</label>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <input type="checkbox" name="challenge-types" value="å•é€‰é¢˜" checked style="width: 18px; height: 18px;">
                    <span>å•é€‰é¢˜</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <input type="checkbox" name="challenge-types" value="å¤šé€‰é¢˜" checked style="width: 18px; height: 18px;">
                    <span>å¤šé€‰é¢˜</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <input type="checkbox" name="challenge-types" value="åˆ¤æ–­é¢˜" checked style="width: 18px; height: 18px;">
                    <span>åˆ¤æ–­é¢˜</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <input type="checkbox" name="challenge-types" value="ç®€ç­”é¢˜" checked style="width: 18px; height: 18px;">
                    <span>ç®€ç­”é¢˜</span>
                </label>
            </div>
        </div>

        <div class="form-group" style="margin-top: 25px;">
            <label class="form-label">æŠ½å–é¢˜ç›®æ•°é‡</label>
            <div style="display: flex; align-items: center; gap: 15px;">
                <input type="number" id="challenge-count" class="form-input" value="10" min="1" max="100" style="width: 120px;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">(å»ºè®® 10-50 é¢˜)</span>
            </div>
        </div>

        <div style="margin-top: 40px; padding: 20px; background: #fffbeb; border-radius: 12px; border: 1px solid #fef3c7;">
            <div style="display: flex; gap: 12px; align-items: flex-start;">
                <div style="font-size: 0.9rem; color: #92400e; line-height: 1.6;">
                    <strong>æŒ‘æˆ˜æ¨¡å¼è§„åˆ™ï¼š</strong><br>
                    1. é¢˜ç›®å°†ä»æ‰€é€‰é¢˜åº“ä¸­å…¨éšæœºæŠ½å–ã€‚<br>
                    2. æŒ‘æˆ˜ç»“æœå°†ä¿å­˜åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å†å²è®°å½•ä¸­ã€‚<br>
                    3. æŒ‘æˆ˜è¿‡ç¨‹ä¸­é€€å‡ºä¸ä¼šä¿å­˜è¿›åº¦ã€‚
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 40px;">
            <button class="btn btn-primary" style="padding: 15px 60px; font-size: 1.1rem;" onclick="startChallenge()">ç«‹å³å¼€å§‹æŒ‘æˆ˜</button>
        </div>
    </div>

    <!-- 4. ç»“æœé¡µ -->
    <div id="view-result" class="content-box hidden result-box">
        <h2>ç»ƒä¹ å®Œæˆ</h2>
        <div class="score-circle" id="score-display">0</div>
        <p id="score-detail" style="font-size: 1.1rem; color: var(--text-secondary);">--</p>
        <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
            <button class="btn btn-outline" onclick="toggleView('home')">è¿”å›é¦–é¡µ</button>
            <button class="btn btn-primary" onclick="restartQuiz()">å†ç»ƒä¸€æ¬¡</button>
        </div>
    </div>

    <!-- 5. API æ–‡æ¡£é¡µ -->
    <div id="view-api" class="content-box hidden">
        <div class="action-bar">
            <h2 class="section-title">API æ¥å£æ–‡æ¡£</h2>
            <button class="btn btn-secondary" onclick="toggleView('home')">è¿”å›</button>
        </div>
        <div style="background:#f7fafc; padding:20px; border-radius:8px; margin-bottom:20px;">
            <strong>POST /api/upload</strong>
            <p style="font-size:0.9rem; color:#4a5568;">å‚æ•°: file (docx), uploader (string), subject (string)</p>
        </div>
        <div style="background:#f7fafc; padding:20px; border-radius:8px;">
            <strong>GET /api/questions?exam_id=ID</strong>
            <p style="font-size:0.9rem; color:#4a5568;">è·å–æŒ‡å®šè¯•å·çš„é¢˜ç›®</p>
        </div>
    </div>
</div>

<div class="footer">&copy; åƒçº¸é›é¸¢ Â· Online Quiz System</div>

<script>
    let examList = [];
    let currentQuestions = [];
    let currentIndex = 0;
    let score = 0;
    let currentStep = 'answering'; // answering | reviewed
    let currentExamId = null;
    let answeredIndices = new Set(); // è®°å½•å·²ä½œç­”çš„é¢˜ç›®ç´¢å¼•
    let userAnswersMap = {}; // è®°å½•æ¯ä¸€é¢˜çš„ç”¨æˆ·ç­”æ¡ˆ
    let questionStatusMap = {}; // è®°å½•æ¯ä¸€é¢˜çš„å¯¹é”™çŠ¶æ€ { index: 'correct'|'wrong' }
    let isChallengeMode = false; // æ˜¯å¦ä¸ºæŒ‘æˆ˜æ¨¡å¼
    let challengeRecord = null; // å½“å‰æŒ‘æˆ˜è®°å½•

    let backgroundList = [];
    let currentBackground = null;

    window.onload = () => {
        loadExamList();
        loadChallengeHistory(); // åŠ è½½å†å²è®°å½•
        initBackground(); // åˆå§‹åŒ–èƒŒæ™¯
        loadBackgroundList(); // åŠ è½½èƒŒæ™¯åˆ—è¡¨
        setTimeout(() => {
            if (typeof onUploadModeChange === 'function') onUploadModeChange();
        }, 0);
    };

    function initBackground() {
        const savedBg = localStorage.getItem('selected_background');
        if (savedBg) {
            currentBackground = savedBg;
        } else {
            currentBackground = 'Nahida.png';
            localStorage.setItem('selected_background', currentBackground);
        }
        applyBackground(currentBackground);
    }

    function applyBackground(bgName) {
        const body = document.body;
        const previewImg = document.getElementById('background-preview');
        const previewPlaceholder = document.getElementById('background-preview-placeholder');
        
        if (bgName === 'default' || !bgName) {
            body.classList.remove('has-background');
            const existingStyle = document.getElementById('dynamic-background-style');
            if (existingStyle) existingStyle.remove();
            if (previewImg) previewImg.style.display = 'none';
            if (previewPlaceholder) previewPlaceholder.style.display = 'flex';
        } else {
            const bgUrl = `/uploads/${bgName}`;
            body.classList.add('has-background');
            
            const style = document.createElement('style');
            style.id = 'dynamic-background-style';
            const existingStyle = document.getElementById('dynamic-background-style');
            if (existingStyle) existingStyle.remove();
            style.textContent = `body.has-background::before { background-image: url(${bgUrl}); }`;
            document.head.appendChild(style);
            
            if (previewImg) {
                previewImg.src = bgUrl;
                previewImg.style.display = 'block';
            }
            if (previewPlaceholder) previewPlaceholder.style.display = 'none';
        }
        
        currentBackground = bgName;
    }

    async function loadBackgroundList() {
        try {
            console.log('å¼€å§‹åŠ è½½èƒŒæ™¯åˆ—è¡¨...');
            const res = await fetch('/api/backgrounds');
            const result = await res.json();
            console.log('èƒŒæ™¯åˆ—è¡¨APIè¿”å›:', result);
            backgroundList = result.data || [];
            console.log('è§£æåçš„èƒŒæ™¯åˆ—è¡¨:', backgroundList);
            renderBackgroundList();
        } catch (e) {
            console.error('åŠ è½½èƒŒæ™¯åˆ—è¡¨å¤±è´¥:', e);
        }
    }

    function renderBackgroundList() {
        const container = document.getElementById('background-list');
        if (!container) {
            console.warn('èƒŒæ™¯åˆ—è¡¨å®¹å™¨ä¸å­˜åœ¨');
            return;
        }
        
        console.log('æ¸²æŸ“èƒŒæ™¯åˆ—è¡¨ï¼Œå½“å‰èƒŒæ™¯:', currentBackground);
        console.log('å¯ç”¨èƒŒæ™¯æ•°é‡:', backgroundList.length);
        
        const defaultHtml = `
            <div class="background-item ${currentBackground === 'default' ? 'selected' : ''}" data-bg="default" onclick="selectBackground('default')">
                <div style="width: 100%; height: 100%; background: var(--bg-color); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-weight: 600;">
                    é»˜è®¤
                </div>
                <div class="background-item-label">é»˜è®¤ï¼ˆæ— èƒŒæ™¯ï¼‰</div>
            </div>
        `;
        
        const backgroundsHtml = backgroundList.map(bg => {
            const isSelected = currentBackground === bg.name;
            console.log(`æ¸²æŸ“èƒŒæ™¯é¡¹: ${bg.name}, æ˜¯å¦é€‰ä¸­: ${isSelected}`);
            return `
                <div class="background-item ${isSelected ? 'selected' : ''}" data-bg="${bg.name}" onclick="selectBackground('${bg.name}')">
                    <img src="${bg.url}" alt="${bg.name}" onerror="console.error('èƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥:', '${bg.url}'); this.parentElement.style.display='none'">
                    <div class="background-item-label">${bg.name}</div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = defaultHtml + backgroundsHtml;
        console.log('èƒŒæ™¯åˆ—è¡¨æ¸²æŸ“å®Œæˆ');
    }

    function selectBackground(bgName) {
        applyBackground(bgName);
        localStorage.setItem('selected_background', bgName);
        renderBackgroundList(); // æ›´æ–°é€‰ä¸­çŠ¶æ€
    }

    function openBackgroundSettings() {
        const modal = document.getElementById('background-settings-modal');
        if (modal) {
            modal.classList.add('open');
            loadBackgroundList(); // åˆ·æ–°èƒŒæ™¯åˆ—è¡¨
            if (currentBackground && currentBackground !== 'default') {
                const previewImg = document.getElementById('background-preview');
                const previewPlaceholder = document.getElementById('background-preview-placeholder');
                if (previewImg) {
                    previewImg.src = `/uploads/${currentBackground}`;
                    previewImg.style.display = 'block';
                }
                if (previewPlaceholder) previewPlaceholder.style.display = 'none';
            } else {
                const previewImg = document.getElementById('background-preview');
                const previewPlaceholder = document.getElementById('background-preview-placeholder');
                if (previewImg) previewImg.style.display = 'none';
                if (previewPlaceholder) previewPlaceholder.style.display = 'flex';
            }
        }
    }

    function closeBackgroundSettings() {
        const modal = document.getElementById('background-settings-modal');
        if (modal) {
            modal.classList.remove('open');
        }
    }

    async function handleBackgroundUpload() {
        const fileInput = document.getElementById('background-file-input');
        const nameInput = document.getElementById('background-name-input');
        
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
            alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
            return;
        }
        
        const file = fileInput.files[0];
        const customName = nameInput.value.trim();
        
        if (!file.type.startsWith('image/')) {
            alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
            return;
        }
        
        try {
            const formData = new FormData();
            formData.append('background', file);
            if (customName) {
                formData.append('name', customName);
            }
            
            const res = await fetch('/api/upload/background', {
                method: 'POST',
                body: formData
            });
            
            const result = await res.json();
            
            if (res.ok && result.success) {
                alert('ä¸Šä¼ æˆåŠŸï¼');
                // è‡ªåŠ¨é€‰æ‹©æ–°ä¸Šä¼ çš„èƒŒæ™¯
                selectBackground(result.filename);
                // åˆ·æ–°èƒŒæ™¯åˆ—è¡¨
                await loadBackgroundList();
                // æ¸…ç©ºè¾“å…¥
                fileInput.value = '';
                nameInput.value = '';
            } else {
                alert('ä¸Šä¼ å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (e) {
            alert('ä¸Šä¼ å¤±è´¥: ' + e.message);
        }
    }

    // --- æŒ‘æˆ˜æ¨¡å¼é€»è¾‘ ---
    function toggleChallengeSidebar(show) {
        const sidebar = document.getElementById('challenge-sidebar');
        const overlay = document.getElementById('challenge-overlay');
        if (show) {
            sidebar.classList.add('open');
            overlay.classList.add('open');
            renderChallengeHistory();
        } else {
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
        }
    }

    async function openChallengeConfig() {
        toggleView('challenge');
        const container = document.getElementById('challenge-exam-list');
        
        // å¦‚æœé¢˜åº“åˆ—è¡¨ä¸ºç©ºï¼Œå…ˆåŠ è½½
        if (examList.length === 0) {
            container.innerHTML = '<div style="padding:20px; color:#a0aec0; text-align:center;">æ­£åœ¨åŠ è½½é¢˜åº“...</div>';
            await loadExamList();
        }
        
        // å†æ¬¡æ£€æŸ¥ï¼ˆé˜²æ­¢åŠ è½½åä»ä¸ºç©ºï¼‰
        if (examList.length === 0) {
            container.innerHTML = '<div style="padding:20px; color:#a0aec0; text-align:center;">æš‚æ— é¢˜åº“å¯ç”¨ï¼Œè¯·å…ˆä¸Šä¼ é¢˜ç›®</div>';
            return;
        }
        
        container.innerHTML = examList.map(exam => `
            <div class="select-item" onclick="this.querySelector('input').click()">
                <input type="checkbox" value="${exam.id}" data-name="${escapeHTML(exam.subject_name)}" onclick="event.stopPropagation()">
                <span>${escapeHTML(exam.subject_name)} (${exam.question_count}é¢˜)</span>
            </div>
        `).join('');
    }

    async function startChallenge() {
        const selectedExams = Array.from(document.querySelectorAll('#challenge-exam-list input:checked'));
        if (selectedExams.length === 0) return alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé¢˜åº“');
        
        // è·å–ç”¨æˆ·é€‰æ‹©çš„é¢˜å‹
        const selectedTypes = Array.from(document.querySelectorAll('input[name="challenge-types"]:checked')).map(cb => cb.value);
        if (selectedTypes.length === 0) return alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§é¢˜å‹');
        
        const count = parseInt(document.getElementById('challenge-count').value);
        if (isNaN(count) || count <= 0) return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é¢˜ç›®æ•°é‡');

        try {
            console.log('æ­£åœ¨å‡†å¤‡æŒ‘æˆ˜é¢˜ç›®...');
            let allAvailableQuestions = [];
            
            // é€ä¸ªè·å–æ‰€é€‰é¢˜åº“çš„é¢˜ç›®
            for (const input of selectedExams) {
                const res = await fetch(`/api/questions?exam_id=${input.value}`);
                const result = await res.json();
                allAvailableQuestions = allAvailableQuestions.concat(result.data || []);
            }

            if (allAvailableQuestions.length === 0) return alert('æ‰€é€‰é¢˜åº“ä¸­æ²¡æœ‰é¢˜ç›®');

            // æ ¹æ®é€‰æ‹©çš„é¢˜å‹è¿‡æ»¤é¢˜ç›®
            allAvailableQuestions = allAvailableQuestions.filter(q => {
                const qType = q.type || 'æœªçŸ¥';
                return selectedTypes.includes(qType);
            });

            if (allAvailableQuestions.length === 0) {
                return alert(`æ‰€é€‰é¢˜åº“ä¸­æ²¡æœ‰ ${selectedTypes.join('ã€')} ç±»å‹çš„é¢˜ç›®`);
            }

            // éšæœºæ´—ç‰Œå¹¶æˆªå–
            allAvailableQuestions.sort(() => Math.random() - 0.5);
            currentQuestions = allAvailableQuestions.slice(0, count);
            
            // åˆå§‹åŒ–æŒ‘æˆ˜çŠ¶æ€
            isChallengeMode = true;
            currentIndex = 0;
            score = 0;
            answeredIndices.clear();
            userAnswersMap = {};
            questionStatusMap = {};
            
            // ä¿å­˜æŒ‘æˆ˜é…ç½®ä¿¡æ¯ï¼ˆç”¨äºè®°å½•ï¼‰
            challengeRecord = {
                selectedTypes: selectedTypes,
                subjectNames: selectedExams.map(i => i.dataset.name).join(', ')
            };
            
            // æ›´æ–° UI æ ‡è¯†
            document.getElementById('quiz-mode-tag').style.display = 'block';
            document.getElementById('quiz-subject-title').innerText = `éšæœºæŒ‘æˆ˜ (${currentQuestions.length}é¢˜)`;
            
            toggleView('quiz');
            document.getElementById('progress-container').style.display = 'flex';
            renderNavGrid();
            loadQuestion();
            
        } catch (e) {
            alert('å¼€å¯æŒ‘æˆ˜å¤±è´¥: ' + e.message);
        }
    }

    function saveChallengeResult() {
        if (!isChallengeMode) return;
        
        const history = JSON.parse(localStorage.getItem('challenge_history') || '[]');
        const record = {
            id: Date.now(),
            date: new Date().toISOString(),
            questions: currentQuestions,
            userAnswers: userAnswersMap,
            statusMap: questionStatusMap,
            score: score,
            total: currentQuestions.length,
            subjectNames: challengeRecord?.subjectNames || 'æœªçŸ¥é¢˜åº“',
            selectedTypes: challengeRecord?.selectedTypes || []
        };
        
        history.unshift(record); // æœ€æ–°è®°å½•åœ¨å‰
        localStorage.setItem('challenge_history', JSON.stringify(history.slice(0, 50))); // åªä¿ç•™æœ€è¿‘50æ¡
        loadChallengeHistory();
    }

    function loadChallengeHistory() {
        // é¢„åŠ è½½é€»è¾‘ï¼Œå¯ä»¥ä¸ºç©º
    }

    function renderChallengeHistory() {
        const history = JSON.parse(localStorage.getItem('challenge_history') || '[]');
        const list = document.getElementById('challenge-history-list');
        
        if (history.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:40px; color:#a0aec0;">æš‚æ— è®°å½•</div>';
            return;
        }

        list.innerHTML = history.map(rec => `
            <div class="history-card" onclick="viewHistoryRecord(${rec.id})">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                    <div style="font-weight:700; font-size:0.95rem; color:var(--text-main); flex:1;">${escapeHTML(rec.subjectNames || 'éšæœºæŒ‘æˆ˜')}</div>
                    <div class="history-score">${rec.score}/${rec.total}</div>
                </div>
                ${rec.selectedTypes && rec.selectedTypes.length > 0 ? 
                    `<div style="font-size:0.75rem; color:#718096; margin-bottom:4px;">
                        ${rec.selectedTypes.map(t => escapeHTML(t)).join('ã€')}
                    </div>` : ''}
                <div style="font-size:0.8rem; color:var(--text-secondary);">
                    ${new Date(rec.date).toLocaleString()}
                </div>
            </div>
        `).join('');
    }

    function viewHistoryRecord(id) {
        const history = JSON.parse(localStorage.getItem('challenge_history') || '[]');
        const rec = history.find(r => r.id === id);
        if (!rec) return;

        // åŠ è½½å†å²æ•°æ®
        currentQuestions = rec.questions;
        userAnswersMap = rec.userAnswers;
        questionStatusMap = rec.statusMap;
        score = rec.score;
        isChallengeMode = true; // è®¾ä¸ºæŒ‘æˆ˜æ¨¡å¼ä»¥ä¾¿å›æ˜¾
        answeredIndices = new Set(Object.keys(userAnswersMap).map(k => parseInt(k)));
        
        // æ¢å¤æŒ‘æˆ˜é…ç½®ä¿¡æ¯
        challengeRecord = {
            subjectNames: rec.subjectNames || 'æœªçŸ¥é¢˜åº“',
            selectedTypes: rec.selectedTypes || []
        };
        
        currentIndex = 0;
        
        document.getElementById('quiz-mode-tag').style.display = 'block';
        document.getElementById('quiz-subject-title').innerText = `å†å²å›é¡¾: ${new Date(rec.date).toLocaleDateString()}`;
        
        toggleChallengeSidebar(false);
        toggleView('quiz');
        document.getElementById('progress-container').style.display = 'flex';
        renderNavGrid();
        loadQuestion();
    }

    function exitQuiz() {
        if (isChallengeMode && answeredIndices.size < currentQuestions.length) {
            if (!confirm('æŒ‘æˆ˜å°šæœªå®Œæˆï¼Œé€€å‡ºå°†ä¸ä¼šä¿å­˜è®°å½•ã€‚ç¡®å®šé€€å‡ºå—ï¼Ÿ')) return;
        }
        toggleView('home');
        isChallengeMode = false;
        challengeRecord = null;
        document.getElementById('quiz-mode-tag').style.display = 'none';
    }

    // --- æœ¬åœ°ç¼“å­˜ç›¸å…³ ---
    function getStorageKey() {
        return `quiz_progress_${currentExamId}`;
    }

    function saveProgress() {
        if (!currentExamId) return;
        const data = {
            currentIndex,
            score,
            answeredIndices: Array.from(answeredIndices),
            userAnswersMap,
            questionStatusMap
        };
        localStorage.setItem(getStorageKey(), JSON.stringify(data));
    }

    function loadProgress() {
        if (!currentExamId) return false;
        const raw = localStorage.getItem(getStorageKey());
        if (!raw) return false;
        
        try {
            const data = JSON.parse(raw);
            if (data.currentIndex === undefined) return false;
            
            currentIndex = data.currentIndex;
            score = data.score || 0;
            answeredIndices = new Set(data.answeredIndices || []);
            userAnswersMap = data.userAnswersMap || {};
            questionStatusMap = data.questionStatusMap || {};

            // å…³é”®ä¿®å¤ï¼šé˜²æ­¢ç´¢å¼•è¶Šç•Œ (æ¯”å¦‚ç¼“å­˜äº†ç¬¬10é¢˜ï¼Œä½†æ–°è¯•å·åªæœ‰4é¢˜)
            if (currentIndex >= currentQuestions.length) {
                console.warn('ç¼“å­˜ç´¢å¼•è¶Šç•Œï¼Œé‡ç½®è¿›åº¦');
                currentIndex = 0;
            }

            return true;
        } catch (e) {
            console.error("è¯»å–ç¼“å­˜å¤±è´¥", e);
            return false;
        }
    }

    function clearProgress() {
        if (currentExamId) {
            localStorage.removeItem(getStorageKey());
        }
    }

    function toggleView(viewId) {
        ['view-home', 'view-upload', 'view-quiz', 'view-result', 'view-api', 'view-challenge'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        });
        document.getElementById('progress-container').style.display = 'none';

        if(viewId === 'home') {
            document.getElementById('view-home').classList.remove('hidden');
            loadExamList();
        } else {
            const el = document.getElementById('view-' + viewId);
            if (el) el.classList.remove('hidden');
        }
    }

    // --- é¦–é¡µé€»è¾‘ ---
    async function loadExamList() {
        try {
            const res = await fetch('/api/exams');
            const result = await res.json();
            const list = result.data || [];
            examList = list;
            
            const container = document.getElementById('exam-list');
            if(list.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#a0aec0;">æš‚æ— è¯•å·ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ä¸Šä¼ </div>';
                return;
            }

            container.innerHTML = list.map(exam => `
                <div class="exam-card" onclick="startExam(${exam.id}, '${escapeHTML(exam.subject_name)}')">
                    <div class="exam-title">${escapeHTML(exam.subject_name)}</div>
                    <div class="exam-meta">
                        <span class="user-tag">ğŸ‘¤ ${escapeHTML(exam.uploader_name)}</span>
                        <span>ğŸ“š ${exam.question_count} é¢˜</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.8rem; color: #a0aec0;">
                        ${new Date(exam.created_at).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
        } catch(e) {
            console.error(e);
        }
    }

    // --- ä¸Šä¼ é€»è¾‘ ---
    let progressTimer = null;
    let targetPercentVal = 0;
    let currentPercentVal = 0;

    function handleFileSelect() {
        const file = document.getElementById('fileInput').files[0];
        if(file) document.getElementById('fileName').innerText = file.name;
    }

    function handleJsonFileSelect() {
        const file = document.getElementById('jsonFileInput').files[0];
        if (file) document.getElementById('jsonFileName').innerText = file.name;
    }

    async function copyJsonTemplate() {
        const pre = document.getElementById('json-template-pre');
        if (!pre) return alert('æœªæ‰¾åˆ°æ¨¡æ¿å†…å®¹');
        const text = pre.innerText || pre.textContent || '';
        if (!text.trim()) return alert('æ¨¡æ¿å†…å®¹ä¸ºç©º');

        // ä¼˜å…ˆä½¿ç”¨ Clipboard API
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
                alert('å·²å¤åˆ¶ JSON æ¨¡æ¿åˆ°å‰ªè´´æ¿');
                return;
            }
        } catch (e) {
            // ç»§ç»­èµ°é™çº§æ–¹æ¡ˆ
        }

        // é™çº§ï¼šä½¿ç”¨ä¸´æ—¶ textarea + execCommand
        try {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            ta.style.top = '0';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            if (ok) alert('å·²å¤åˆ¶ JSON æ¨¡æ¿åˆ°å‰ªè´´æ¿');
            else alert('å¤åˆ¶å¤±è´¥ï¼šæµè§ˆå™¨ä¸æ”¯æŒè‡ªåŠ¨å¤åˆ¶ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
        } catch (e) {
            alert('å¤åˆ¶å¤±è´¥ï¼š' + e.message);
        }
    }

    function onUploadModeChange() {
        const mode = document.querySelector('input[name="uploadMode"]:checked')?.value || 'normal';
        const docxGroup = document.getElementById('docx-upload-group');
        const jsonGroup = document.getElementById('json-upload-group');
        if (!docxGroup || !jsonGroup) return;

        if (mode === 'json') {
            docxGroup.classList.add('hidden');
            jsonGroup.classList.remove('hidden');
        } else {
            jsonGroup.classList.add('hidden');
            docxGroup.classList.remove('hidden');
        }
    }

    function normalizeQuestionsPayload(raw) {
        if (Array.isArray(raw)) return raw;
        if (raw && typeof raw === 'object') {
            if (Array.isArray(raw.questions)) return raw.questions;
            if (Array.isArray(raw.data)) return raw.data;
        }
        return null;
    }

    function addLog(message, isHighlight = false) {
        const logs = document.getElementById('upload-logs');
        const div = document.createElement('div');
        div.className = 'log-item' + (isHighlight ? ' highlight' : '');
        div.innerText = `> ${message}`;
        logs.appendChild(div);
        logs.scrollTop = logs.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    }

    async function uploadFile() {
        const uploader = document.getElementById('uploaderName').value.trim();
        const subject = document.getElementById('subjectName').value.trim();
        const fileInput = document.getElementById('fileInput');
        const statusText = document.getElementById('uploadStatus');
        const mode = document.querySelector('input[name="uploadMode"]:checked').value;
        const jsonFileInput = document.getElementById('jsonFileInput');
        const jsonTextInput = document.getElementById('jsonTextInput');
        
        // è¿›åº¦æ¡å…ƒç´ 
        const progressBox = document.getElementById('upload-progress-box');
        const progressBar = document.getElementById('upload-progress-bar');
        const progressStatus = document.getElementById('upload-status-text');
        const progressPercent = document.getElementById('upload-percent');
        const logsDiv = document.getElementById('upload-logs');

        if(!uploader || !subject) {
            alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼ˆå§“åã€ç§‘ç›®ï¼‰');
            return;
        }

        // JSON å¯¼å…¥ï¼šæ— éœ€ docx
        if (mode === 'json') {
            const hasJsonFile = jsonFileInput && jsonFileInput.files && jsonFileInput.files.length > 0;
            const hasJsonText = jsonTextInput && jsonTextInput.value && jsonTextInput.value.trim().length > 0;
            if (!hasJsonFile && !hasJsonText) {
                alert('è¯·æä¾› JSON æ–‡ä»¶æˆ–ç²˜è´´ JSON å†…å®¹');
                return;
            }
        } else {
            if (!fileInput || fileInput.files.length === 0) {
                alert('è¯·ä¸Šä¼  Word æ–‡æ¡£ï¼ˆ.docxï¼‰');
                return;
            }
        }

        // åˆå§‹åŒ–ç•Œé¢çŠ¶æ€
        statusText.style.display = 'none';
        progressBox.style.display = 'block';
        
        // é‡ç½®è¿›åº¦çŠ¶æ€
        currentPercentVal = 0;
        targetPercentVal = 0;
        progressBar.style.width = '0%';
        progressPercent.innerText = '0%';
        
        // å¯åŠ¨å¹³æ»‘è¿›åº¦åŠ¨ç”»å¾ªç¯
        if (progressTimer) clearInterval(progressTimer);
        progressTimer = setInterval(() => {
            // ç­–ç•¥ï¼š
            // 1. å¦‚æœå½“å‰ < ç›®æ ‡ï¼šå¿«é€Ÿè¿½èµ¶ (Lerp)
            // 2. å¦‚æœå½“å‰ >= ç›®æ ‡ ä¸” ç›®æ ‡ < 95 (AIå¤„ç†ä¸­)ï¼šæ…¢é€Ÿè •åŠ¨ (Fake Progress)ï¼Œè®©ç”¨æˆ·è§‰å¾—æ²¡å¡æ­»
            
            if (currentPercentVal < targetPercentVal) {
                // è¿½èµ¶æ¨¡å¼ï¼šæ¯æ¬¡è¿½ 10% çš„å·®è·ï¼Œè‡³å°‘ +0.5
                const diff = targetPercentVal - currentPercentVal;
                const step = Math.max(0.5, diff * 0.1);
                currentPercentVal = Math.min(targetPercentVal, currentPercentVal + step);
            } else if ((mode === 'ai' || mode === 'json') && targetPercentVal > 0 && targetPercentVal < 95) {
                // è •åŠ¨æ¨¡å¼ï¼šæ¯å¸§ +0.05% (çº¦æ¯ç§’ +1-2%)ï¼Œä¸Šé™æ˜¯ target + 15 æˆ– 98
                const limit = Math.min(98, targetPercentVal + 20);
                if (currentPercentVal < limit) {
                    currentPercentVal += 0.05;
                }
            }
            
            // æ¸²æŸ“
            const pctStr = currentPercentVal.toFixed(1) + '%';
            progressBar.style.width = pctStr;
            progressPercent.innerText = Math.floor(currentPercentVal) + '%';
            
        }, 50); // 20FPS

        progressStatus.innerText = mode === 'ai' ? 'ğŸ¤– AI å¼•æ“å¯åŠ¨ä¸­...' : (mode === 'json' ? 'ğŸ§¾ JSON å¯¼å…¥å‡†å¤‡ä¸­...' : 'æ­£åœ¨ä¸Šä¼ ...');
        logsDiv.innerHTML = ''; // æ¸…ç©ºæ—¥å¿—
        addLog('ä»»åŠ¡å·²æäº¤ï¼Œå‡†å¤‡å¼€å§‹å¤„ç†...');

        // JSON å¯¼å…¥åˆ†æ”¯ï¼ˆä¸èµ° FormDataï¼‰
        if (mode === 'json') {
            try {
                targetPercentVal = 20;
                addLog('æ­£åœ¨è¯»å– JSON...', true);

                let rawJsonText = '';
                if (jsonFileInput && jsonFileInput.files && jsonFileInput.files[0]) {
                    rawJsonText = await jsonFileInput.files[0].text();
                } else {
                    rawJsonText = (jsonTextInput?.value || '').trim();
                }

                targetPercentVal = 45;
                addLog('æ­£åœ¨è§£æ JSON...', true);
                let parsed;
                try {
                    parsed = JSON.parse(rawJsonText);
                } catch (e) {
                    throw new Error('JSON æ ¼å¼ä¸åˆæ³•ï¼š' + e.message);
                }

                const questions = normalizeQuestionsPayload(parsed);
                if (!questions || !Array.isArray(questions) || questions.length === 0) {
                    throw new Error('JSON ä¸­æœªæ‰¾åˆ°é¢˜ç›®æ•°ç»„ï¼ˆéœ€è¦ [é¢˜ç›®æ•°ç»„] æˆ– {questions:[...]}ï¼‰');
                }

                targetPercentVal = 70;
                addLog(`å·²è¯†åˆ« ${questions.length} é¢˜ï¼Œå¼€å§‹å…¥åº“...`, true);

                targetPercentVal = 90;
                const response = await fetch('/api/upload/json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uploader, subject, questions })
                });
                const data = await response.json();

                if (response.ok && !data.error) {
                    targetPercentVal = 100;
                    currentPercentVal = 100;
                    progressBar.style.width = '100%';
                    progressPercent.innerText = '100%';
                    addLog('å¯¼å…¥å®Œæˆï¼', true);
                    finishUpload(true, data.message || 'å¯¼å…¥æˆåŠŸï¼');
                } else {
                    throw new Error(data.error || data.message || 'å¯¼å…¥å¤±è´¥');
                }
                return;
            } catch (e) {
                finishUpload(false, e.message);
                return;
            }
        }

        const formData = new FormData();
        formData.append('uploader', uploader);
        formData.append('subject', subject);
        formData.append('file', fileInput.files[0]);

        const apiEndpoint = mode === 'ai' ? '/api/upload/ai' : '/api/upload';

        try {
            const response = await fetch(apiEndpoint, { method: 'POST', body: formData });
            
            // å¦‚æœæ˜¯æ™®é€šä¸Šä¼ ï¼Œä¸æ”¯æŒæµå¼
            if (mode !== 'ai') {
                const data = await response.json();
                if(response.ok && !data.error) {
                    targetPercentVal = 100;
                    currentPercentVal = 100; // ç«‹å³å®Œæˆ
                    progressBar.style.width = '100%';
                    progressPercent.innerText = '100%';
                    addLog('ä¸Šä¼ å®Œæˆï¼', true);
                    finishUpload(true, 'ä¸Šä¼ æˆåŠŸï¼');
                } else {
                    addLog('ä¸Šä¼ å¤±è´¥: ' + (data.error || data.message));
                    finishUpload(false, data.error || data.message);
                }
                return;
            }

            // AI æ¨¡å¼ï¼šå¤„ç†æµå¼å“åº”
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); 
                
                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const msg = JSON.parse(line);
                        
                        if (msg.type === 'progress') {
                            // æ›´æ–°ç›®æ ‡è¿›åº¦ï¼Œè®©å®šæ—¶å™¨å»è¿½èµ¶
                            targetPercentVal = msg.percent;
                            
                            progressStatus.innerText = 'æ­£åœ¨å¤„ç†...';
                            // è®°å½•æ—¥å¿—
                            addLog(msg.message, msg.percent % 10 === 0); 
                        } else if (msg.type === 'complete') {
                            addLog('âœ… ' + msg.message, true);
                            finishUpload(true, msg.message);
                            return;
                        } else if (msg.type === 'error') {
                            addLog('âŒ ' + msg.message);
                            throw new Error(msg.message);
                        }
                    } catch (e) {
                        console.error('è§£ææµæ•°æ®å¤±è´¥:', e);
                    }
                }
            }

        } catch(e) {
            finishUpload(false, e.message);
        }
    }

    function finishUpload(success, message) {
        // åœæ­¢åŠ¨ç”»
        if (progressTimer) clearInterval(progressTimer);
        
        const statusText = document.getElementById('uploadStatus');
        const progressBox = document.getElementById('upload-progress-box');
        
        if (success) {
            statusText.innerText = 'âœ… ' + message;
            statusText.style.color = 'var(--success-color)';
            statusText.style.display = 'block';
            
            setTimeout(() => {
                // æ¸…ç©ºè¡¨å•
                document.getElementById('subjectName').value = '';
                document.getElementById('fileInput').value = '';
                document.getElementById('fileName').innerText = 'ç‚¹å‡»é€‰æ‹© Word æ–‡æ¡£';
                statusText.innerText = '';
                statusText.style.display = 'none';
                progressBox.style.display = 'none'; // éšè—è¿›åº¦æ¡
                toggleView('home');
            }, 2000);
        } else {
            statusText.innerText = 'âŒ å¤±è´¥: ' + message;
            statusText.style.color = 'var(--error-color)';
            statusText.style.display = 'block';
            document.getElementById('upload-progress-bar').style.background = '#f56565';
        }
    }

    // --- ç­”é¢˜é€»è¾‘ ---
    
    /**
     * è§„èŒƒåŒ–åˆ¤æ–­é¢˜ç­”æ¡ˆï¼šç»Ÿä¸€è½¬æ¢ä¸º"æ­£ç¡®"æˆ–"é”™è¯¯"
     * @param {string} answer - åŸå§‹ç­”æ¡ˆ
     * @returns {string} - "æ­£ç¡®" æˆ– "é”™è¯¯"
     */
    function normalizeJudgementAnswer(answer) {
        if (!answer || typeof answer !== 'string') return 'é”™è¯¯';
        
        const normalized = answer.trim();
        
        // æ­£ç¡®ç›¸å…³çš„æ‰€æœ‰å˜ä½“
        if (/^(æ­£ç¡®|å¯¹|æ˜¯|âˆš|âœ“|T|True|Y|Yes|1)$/i.test(normalized)) {
            return 'æ­£ç¡®';
        }
        
        // é”™è¯¯ç›¸å…³çš„æ‰€æœ‰å˜ä½“
        if (/^(é”™è¯¯|é”™|å¦|Ã—|âœ—|F|False|N|No|0)$/i.test(normalized)) {
            return 'é”™è¯¯';
        }
        
        // é»˜è®¤è¿”å›é”™è¯¯ï¼ˆä¿å®ˆç­–ç•¥ï¼‰
        return 'é”™è¯¯';
    }

    function escapeHTML(str) {
        if (!str || typeof str !== 'string') return str || '';
        return str.replace(/[&<>"']/g, function(m) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m];
        });
    }

    async function startExam(examId, subjectName) {
        currentExamId = examId;
        document.getElementById('quiz-subject-title').innerText = subjectName;
        
        try {
            const res = await fetch(`/api/questions?exam_id=${examId}`);
            const result = await res.json();
            
            if(result.data && result.data.length > 0) {
                currentQuestions = result.data;
                
                // å°è¯•åŠ è½½ç¼“å­˜
                const hasCache = loadProgress();
                if (!hasCache) {
                    // æ— ç¼“å­˜ï¼Œåˆå§‹åŒ–
                    currentIndex = 0;
                    score = 0;
                    answeredIndices.clear();
                    userAnswersMap = {};
                    questionStatusMap = {};
                }

                toggleView('quiz');
                document.getElementById('progress-container').style.display = 'flex';
                
                // æ¸²æŸ“
                renderNavGrid();
                loadQuestion();
            } else {
                alert('è¯¥è¯•å·æš‚æ— é¢˜ç›®');
            }
        } catch(e) {
            alert('åŠ è½½é¢˜ç›®å‡ºé”™: ' + e.message);
            console.error(e);
        }
    }

    function renderNavGrid() {
        const grid = document.getElementById('question-nav-grid');
        document.getElementById('total-count').innerText = currentQuestions.length;
        document.getElementById('answered-count').innerText = answeredIndices.size;
        
        grid.innerHTML = currentQuestions.map((_, i) => {
            let classes = 'question-dot';
            
            // çŠ¶æ€æ ·å¼
            if (questionStatusMap[i] === 'correct') classes += ' status-correct';
            else if (questionStatusMap[i] === 'wrong') classes += ' status-wrong';
            else if (answeredIndices.has(i)) classes += ' answered'; // å…¼å®¹æ—§æ•°æ®
            
            // å½“å‰é€‰ä¸­é«˜äº®
            if (i === currentIndex) classes += ' active';
            
            return `<div class="${classes}" onclick="jumpToQuestion(${i}); toggleSidebar(false);">${i + 1}</div>`;
        }).join('');
    }

    // åˆ‡æ¢ä¾§è¾¹æ 
    function toggleSidebar(show) {
        const sidebar = document.getElementById('quiz-sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        if (show) {
            sidebar.classList.add('open');
            overlay.classList.add('open');
        } else {
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
        }
    }

    function jumpToQuestion(index) {
        if (index === currentIndex) return;
        currentIndex = index;
        loadQuestion();
    }

    function loadQuestion() {
        // å®‰å…¨æ£€æŸ¥
        if (!currentQuestions || currentQuestions.length === 0) return;
        if (currentIndex >= currentQuestions.length) currentIndex = 0;

        // åˆ¤æ–­å½“å‰é¢˜æ˜¯å¦å·²ç­”
        const isAnswered = answeredIndices.has(currentIndex);
        currentStep = isAnswered ? 'reviewed' : 'answering';
        
        const q = currentQuestions[currentIndex];
        
        // åŒé‡ä¿é™©
        if (!q) {
            console.error('é¢˜ç›®æ•°æ®å¼‚å¸¸', currentIndex, currentQuestions);
            document.getElementById('question-container').innerHTML = '<p style="color:red">é¢˜ç›®åŠ è½½å‡ºé”™ï¼Œè¯·åˆ·æ–°é‡è¯•</p>';
            return;
        }

        const container = document.getElementById('question-container');
        const btn = document.getElementById('btn-action');

        // æ›´æ–°å¯¼èˆªé«˜äº®
        renderNavGrid();

        // è¿›åº¦
        document.getElementById('progress-text').innerText = `${currentIndex + 1} / ${currentQuestions.length}`;
        document.getElementById('progress-fill').style.width = `${((currentIndex + 1) / currentQuestions.length) * 100}%`;
        
        // æŒ‰é’®çŠ¶æ€
        if (isAnswered) {
            btn.innerText = (currentIndex === currentQuestions.length - 1) ? 'æŸ¥çœ‹ç»“æœ' : 'ä¸‹ä¸€é¢˜';
        } else {
            btn.innerText = 'æäº¤æœ¬é¢˜';
        }

        let html = `<div class="question-title">${currentIndex + 1}. <span class="tag" style="vertical-align:middle; margin-right:8px;">${escapeHTML(q.type || 'æœªçŸ¥')}</span>${escapeHTML(q.title)}</div>`;

        // è¾…åŠ©ï¼šè·å–å›æ˜¾çš„ç­”æ¡ˆ
        const savedAns = userAnswersMap[currentIndex] || '';

        if(q.options && q.options.length > 0) {
            // é€‰æ‹©é¢˜
            const inputType = (q.type === 'å¤šé€‰é¢˜') ? 'checkbox' : 'radio';
            html += `<ul class="options">`;
            q.options.forEach(opt => {
                // å›æ˜¾é€‰ä¸­çŠ¶æ€
                let checkedAttr = '';
                let labelClass = '';
                if (inputType === 'radio' && savedAns === opt.label) {
                    checkedAttr = 'checked';
                    labelClass = 'selected';
                } else if (inputType === 'checkbox' && savedAns.includes(opt.label)) {
                    checkedAttr = 'checked';
                    labelClass = 'selected';
                }

                html += `
                    <li class="option-item">
                        <label class="${labelClass}" onclick="selectOption(this, '${inputType}')">
                            <input type="${inputType}" name="q" value="${escapeHTML(opt.label)}" ${checkedAttr}>
                            <span><strong style="color:var(--primary-color)">${escapeHTML(opt.label)}.</strong> ${escapeHTML(opt.content)}</span>
                        </label>
                    </li>`;
            });
            html += `</ul>`;
        } else if (q.type === 'åˆ¤æ–­é¢˜' || q.answer === 'æ­£ç¡®' || q.answer === 'é”™è¯¯' || 
                   q.answer === 'å¯¹' || q.answer === 'é”™' || q.answer === 'æ˜¯' || q.answer === 'å¦') {
            // è§„èŒƒåŒ–ä¿å­˜çš„ç­”æ¡ˆç”¨äºå›æ˜¾ï¼ˆåªæœ‰å·²ä¿å­˜ç­”æ¡ˆæ—¶æ‰å›æ˜¾ï¼‰
            let isCorrect = false;
            let isWrong = false;
            if (savedAns && savedAns.trim()) {
                const normalizedSavedAns = normalizeJudgementAnswer(savedAns);
                isCorrect = (normalizedSavedAns === 'æ­£ç¡®');
                isWrong = (normalizedSavedAns === 'é”™è¯¯');
            }
            html += `
                <ul class="options">
                    <li class="option-item"><label class="${isCorrect?'selected':''}" onclick="selectOption(this, 'radio')"><input type="radio" name="q" value="æ­£ç¡®" ${isCorrect?'checked':''}><span>æ­£ç¡® (âˆš)</span></label></li>
                    <li class="option-item"><label class="${isWrong?'selected':''}" onclick="selectOption(this, 'radio')"><input type="radio" name="q" value="é”™è¯¯" ${isWrong?'checked':''}><span>é”™è¯¯ (Ã—)</span></label></li>
                </ul>`;
        } else {
            // ç®€ç­”
            html += `<textarea id="text-answer" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ...">${escapeHTML(savedAns)}</textarea>`;
        }

        html += `<div id="explanation-area"></div>`;
        container.innerHTML = html;

        // å¦‚æœå·²ç­”ï¼Œç›´æ¥æ˜¾ç¤ºè§£æå¹¶ç¦ç”¨è¾“å…¥
        if (isAnswered) {
            // å»¶è¿Ÿä¸€ç‚¹æ˜¾ç¤ºè§£æï¼Œç¡®ä¿ DOM æ¸²æŸ“å®Œæ¯•
            setTimeout(() => {
                // åˆ¤æ–­é¢˜éœ€è¦è§„èŒƒåŒ–æ¯”è¾ƒ
                let isCorrect;
                if (q.type === 'åˆ¤æ–­é¢˜' || q.answer === 'æ­£ç¡®' || q.answer === 'é”™è¯¯' || 
                    q.answer === 'å¯¹' || q.answer === 'é”™' || q.answer === 'æ˜¯' || q.answer === 'å¦') {
                    const normalizedSavedAns = normalizeJudgementAnswer(savedAns);
                    const normalizedCorrectAns = normalizeJudgementAnswer(q.answer);
                    isCorrect = (normalizedSavedAns === normalizedCorrectAns);
                } else {
                    isCorrect = (savedAns === q.answer);
                }
                showFeedback(isCorrect, q.answer, savedAns);
                // ç¦ç”¨æ‰€æœ‰è¾“å…¥
                container.querySelectorAll('input, textarea').forEach(el => {
                    el.disabled = true;
                    el.parentElement.onclick = null; // ç§»é™¤ç‚¹å‡»äº‹ä»¶
                });
            }, 0);
        }
    }

    window.selectOption = function(label, type) {
        if(currentStep !== 'answering') return;
        
        if (type === 'radio') {
            label.closest('ul').querySelectorAll('label').forEach(l => l.classList.remove('selected'));
            label.classList.add('selected');
            label.querySelector('input').checked = true;
        } else {
            // checkbox å¤šé€‰é€»è¾‘
            const checkbox = label.querySelector('input');
            checkbox.checked = !checkbox.checked;
            if (checkbox.checked) {
                label.classList.add('selected');
            } else {
                label.classList.remove('selected');
            }
        }
    }

    window.handleAction = function() {
        const btn = document.getElementById('btn-action');
        const q = currentQuestions[currentIndex];

        if(currentStep === 'answering') {
            // æäº¤é€»è¾‘
            let userAns = '';
            const inputs = document.querySelectorAll('input[name="q"]');
            
            if(inputs.length > 0) {
                const checked = Array.from(inputs).filter(i => i.checked);
                if(checked.length === 0) return alert('è¯·é€‰æ‹©ç­”æ¡ˆ');
                
                // æ’åºå¹¶åˆå¹¶ç­”æ¡ˆ (é’ˆå¯¹å¤šé€‰é¢˜ï¼Œå¦‚ ABC)
                userAns = checked.map(i => i.value).sort().join('');
            } else {
                userAns = document.getElementById('text-answer').value;
            }

            // åˆ¤æ–­é¢˜éœ€è¦è§„èŒƒåŒ–ç­”æ¡ˆæ ¼å¼
            let isCorrect;
            if (q.type === 'åˆ¤æ–­é¢˜' || q.answer === 'æ­£ç¡®' || q.answer === 'é”™è¯¯' || 
                q.answer === 'å¯¹' || q.answer === 'é”™' || q.answer === 'æ˜¯' || q.answer === 'å¦') {
                // åˆ¤æ–­é¢˜ï¼šè§„èŒƒåŒ–åæ¯”è¾ƒ
                const normalizedUserAns = normalizeJudgementAnswer(userAns);
                const normalizedCorrectAns = normalizeJudgementAnswer(q.answer);
                isCorrect = (normalizedUserAns === normalizedCorrectAns);
            } else {
                // å…¶ä»–é¢˜å‹ï¼šç›´æ¥æ¯”è¾ƒï¼ˆå¤šé€‰é¢˜éœ€è¦æ’åºåæ¯”è¾ƒï¼‰
                isCorrect = (userAns === q.answer);
            }
            
            if(isCorrect) score++;

            // æ ‡è®°ä¸ºå·²ä½œç­”
            answeredIndices.add(currentIndex);
            userAnswersMap[currentIndex] = userAns;
            questionStatusMap[currentIndex] = isCorrect ? 'correct' : 'wrong'; // è®°å½•å¯¹é”™çŠ¶æ€
            
            // æ˜¾ç¤ºåé¦ˆ
            showFeedback(isCorrect, q.answer, userAns);
            
            currentStep = 'reviewed';
            btn.innerText = (currentIndex === currentQuestions.length - 1) ? 'æŸ¥çœ‹ç»“æœ' : 'ä¸‹ä¸€é¢˜';
            
            // åˆ·æ–°å¯¼èˆªå¹¶ä¿å­˜
            renderNavGrid();
            if (!isChallengeMode) {
                saveProgress();
            }
            
        } else {
            // ä¸‹ä¸€é¢˜é€»è¾‘
            if(currentIndex < currentQuestions.length - 1) {
                currentIndex++;
                if (!isChallengeMode) {
                    saveProgress(); // åˆ‡æ¢é¢˜ç›®ä¹Ÿä¿å­˜ä¸€ä¸‹è¿›åº¦(ä¸»è¦æ˜¯ currentIndex)
                }
                loadQuestion();
            } else {
                showResult();
            }
        }
    }

    function showFeedback(isCorrect, rightAns, userAns) {
        const area = document.getElementById('explanation-area');
        const color = isCorrect ? '#48bb78' : '#f56565';
        
        // è·å–å½“å‰é¢˜ç›®å¯¹è±¡
        const q = currentQuestions[currentIndex];
        
        // åˆ¤æ–­é¢˜ï¼šè§„èŒƒåŒ–æ˜¾ç¤ºç­”æ¡ˆ
        let displayRightAns = rightAns;
        let displayUserAns = userAns;
        if (q.type === 'åˆ¤æ–­é¢˜' || rightAns === 'æ­£ç¡®' || rightAns === 'é”™è¯¯' || 
            rightAns === 'å¯¹' || rightAns === 'é”™' || rightAns === 'æ˜¯' || rightAns === 'å¦') {
            displayRightAns = normalizeJudgementAnswer(rightAns);
            displayUserAns = normalizeJudgementAnswer(userAns);
        }
        
        // é€‰é¡¹æŸ“è‰²é€»è¾‘
        document.querySelectorAll('input[name="q"]').forEach(input => {
            const label = input.parentElement;
            const val = input.value;
            
            // ç¡®ä¿ rightAns å’Œ userAns æ˜¯å­—ç¬¦ä¸²
            const safeRightAns = String(rightAns || '');
            const safeUserAns = String(userAns || '');

            // 1. å¦‚æœè¯¥é€‰é¡¹æ˜¯æ­£ç¡®ç­”æ¡ˆçš„ä¸€éƒ¨åˆ†ï¼Œæ ‡è®°ä¸ºç»¿è‰² (correct)
            if (safeRightAns.includes(val)) {
                label.classList.add('correct');
            }
            
            // 2. å¦‚æœç”¨æˆ·é€‰äº†è¯¥é€‰é¡¹ï¼Œä½†å®ƒä¸æ˜¯æ­£ç¡®ç­”æ¡ˆï¼Œæ ‡è®°ä¸ºçº¢è‰² (wrong)
            if (safeUserAns.includes(val) && !safeRightAns.includes(val)) {
                label.classList.add('wrong');
            }
            
            input.disabled = true;
        });

        const explanation = q.explanation ? `<div style="margin-top:10px; border-top:1px dashed #e2e8f0; padding-top:10px; font-size:0.9rem;"><strong>è§£æï¼š</strong>${escapeHTML(q.explanation)}</div>` : '';

        area.innerHTML = `
            <div class="explanation-box" style="border-left-color:${color}">
                <strong style="color:${color}">${isCorrect ? 'å›ç­”æ­£ç¡®' : 'å›ç­”é”™è¯¯'}</strong>
                <div style="margin-top:5px; color:#4a5568">æ­£ç¡®ç­”æ¡ˆï¼š${escapeHTML(displayRightAns)}</div>
                ${explanation}
                <button class="ai-btn" onclick="askAI(this)">âœ¨é—®AI</button>
            </div>
        `;
    }

    async function askAI(btn) {
        const q = currentQuestions[currentIndex];
        const userAns = userAnswersMap[currentIndex] || 'æœªä½œç­”';
        
        // ç•Œé¢çŠ¶æ€æ›´æ–°
        btn.disabled = true;
        btn.classList.add('thinking'); // æ·»åŠ åŠ¨ç”»ç±»
        btn.innerHTML = 'âœ¨ æ­£åœ¨æ€è€ƒ...';
        
        const feedbackBox = btn.parentElement;
        
        // åˆ›å»ºæˆ–è·å– AI å®¹å™¨
        let aiContainer = feedbackBox.querySelector('.ai-box');
        if (!aiContainer) {
            aiContainer = document.createElement('div');
            aiContainer.className = 'ai-box hidden';
            feedbackBox.appendChild(aiContainer);
        }
        
        try {
            const res = await fetch('/api/ask-ai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question: q,
                    userAnswer: userAns
                })
            });
            const data = await res.json();
            
            if (data.error) throw new Error(data.error);
            
            aiContainer.innerHTML = `
                <div class="ai-title">âœ¨ AIè§£æ</div>
                <div class="ai-content">${escapeHTML(data.reply)}</div>
            `;
            aiContainer.classList.remove('hidden');
            btn.innerHTML = 'âœ¨ é‡æ–°æé—®';
            btn.classList.remove('thinking'); // ç§»é™¤åŠ¨ç”»ç±»
            btn.disabled = false;
            
        } catch (e) {
            alert('AI è¯·æ±‚å¤±è´¥: ' + e.message);
            btn.innerHTML = 'âœ¨ é—® AI';
            btn.classList.remove('thinking'); // ç§»é™¤åŠ¨ç”»ç±»
            btn.disabled = false;
        }
    }

    function showResult() {
        if (isChallengeMode) {
            saveChallengeResult();
        }
        toggleView('result');
        document.getElementById('score-display').innerText = score;
        const rate = Math.round((score / currentQuestions.length) * 100);
        document.getElementById('score-detail').innerText = `æ­£ç¡®ç‡ ${rate}% Â· å…± ${currentQuestions.length} é¢˜`;
    }

    window.restartQuiz = function() {
        if (!confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿå½“å‰è¿›åº¦å°†è¢«æ¸…ç©ºã€‚')) return;
        
        clearProgress(); // æ¸…é™¤ç¼“å­˜
        currentIndex = 0;
        score = 0;
        answeredIndices.clear();
        userAnswersMap = {};
        questionStatusMap = {};
        
        toggleView('quiz');
        document.getElementById('progress-container').style.display = 'flex';
        renderNavGrid();
        loadQuestion();
    }
</script>

</body>
</html>
