<!DOCTYPE html>
<!--              _                          
__      _____| | ___ ___  _ __ ___   ___ 
\ \ /\ / / _ \ |/ __/ _ \| '_ ` _ \ / _ \
 \ V  V /  __/ | (_| (_) | | | | | |  __/
  \_/\_/ \___|_|\___\___/|_| |_| |_|\___|-->
  
  <!--  __ _   ____   ___   _   _ 
 / _` | |_  /  / __| | | | |
| (_| |  / /  | (__  | |_| |
 \__, | /___|  \___|  \__, |
    |_|               |___/ -->
    
    <!--åˆä½œé‚®ç®± yxy3635@gmail.com-->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åƒçº¸é›é¸¢-åœ¨çº¿ç­”é¢˜ç³»ç»Ÿ</title>
    <script src="../js/chart.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --primary-color: #667eea;
            --text-main: #2d3748;
            --text-secondary: #718096;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --success-color: #1fe873;
            --error-color: #f61a1a;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius-lg: 16px;
            --radius-md: 8px;
        }

        body.dark-mode {
            --text-main: #e2e8f0;
            --text-secondary: #a0aec0;
            --bg-color: #1a202c;
            --card-bg: #2d3748;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .header,
        body.dark-mode .content-box,
        body.dark-mode .quiz-sidebar,
        body.dark-mode .challenge-sidebar,
        body.dark-mode .exam-card,
        body.dark-mode .background-settings-content {
            background: var(--card-bg);
            color: var(--text-main);
        }

        body.dark-mode.has-background .header,
        body.dark-mode.has-background .content-box,
        body.dark-mode.has-background .quiz-sidebar,
        body.dark-mode.has-background .challenge-sidebar,
        body.dark-mode.has-background .exam-card,
        body.dark-mode.has-background .background-settings-content {
            background: rgba(26, 32, 44, 0.85) !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        @media (max-width: 600px) {
            body::before {
                background-attachment: scroll;
            }
        }
        
        body.has-background::before {
            opacity: 1;
        }

        body { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            margin: 0; padding: 0; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            min-height: 100vh;
            display: flex; flex-direction: column;
            position: relative;
        }
        
        body.has-background .header,
        body.has-background .content-box,
        body.has-background .quiz-sidebar,
        body.has-background .challenge-sidebar,
        body.has-background .exam-card,
        body.has-background .background-settings-content {
            background: rgba(255, 255, 255, 0.85) !important;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        body.has-background .content-box {
            background: rgba(255, 255, 255, 0.9) !important;
        }

        body.has-background .quiz-sidebar,
        body.has-background .challenge-sidebar {
            background: rgba(255, 255, 255, 0.9) !important;
        }

        body.has-background .exam-card {
            background: rgba(255, 255, 255, 0.88) !important;
        }
        
        .main-wrapper { flex: 1; padding: 20px; max-width: 1200px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 30px; padding: 20px; background: var(--card-bg); 
            border-radius: var(--radius-lg); box-shadow: var(--card-shadow);
            transition: background 0.3s ease, backdrop-filter 0.3s ease;
        }
        .brand { 
            font-size: 1.5rem; font-weight: 800; 
            background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            cursor: pointer;
        }

        .progress-container { display: flex; align-items: center; gap: 15px; font-size: 0.9rem; color: var(--text-secondary); font-weight: 500; }
        .progress-bar { width: 120px; height: 8px; background: #edf2f7; border-radius: 999px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary-gradient); width: 0%; transition: width 0.3s; border-radius: 999px; }

        .content-box { 
            background: var(--card-bg); 
            border-radius: var(--radius-lg); 
            padding: 30px; 
            box-shadow: var(--card-shadow); 
            animation: fadeIn 0.3s;
            transition: background 0.3s ease, backdrop-filter 0.3s ease;
        }
        
        .background-settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .background-settings-modal.open {
            display: flex;
        }
        .background-settings-content {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .background-preview {
            width: 100%;
            height: 200px;
            border-radius: var(--radius-md);
            object-fit: cover;
            margin-bottom: 15px;
            border: 2px solid #e2e8f0;
        }
        .background-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .background-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }
        .background-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .background-item.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
        }
        .background-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .background-item-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            font-size: 0.75rem;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .background-upload-zone {
            border: 2px dashed #cbd5e0;
            padding: 20px;
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 15px;
        }
        .background-upload-zone:hover {
            border-color: var(--primary-color);
            background: #f7fafc;
        }

        .quiz-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            position: relative;
        }
        .quiz-main {
            flex: 1;
            min-width: 0;
        }
        .quiz-sidebar {
            width: 280px;
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            z-index: 1001; /* æé«˜åˆ°é®ç½©å±‚ä»¥ä¸Š */
            transition: transform 0.3s ease;
        }

        .sidebar-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 1001;
            border: none;
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(2px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .sidebar-overlay.open {
            display: block;
            opacity: 1;
        }

        .question-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .question-dot {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            border: 1px solid #e2e8f0;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
            background: var(--card-bg);
            color: var(--text-secondary);
        }
        .question-dot:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        .question-dot.active {
            background: #f3f0ff;
            border-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-color);
        }
        .question-dot.answered {
            background: #f0fdf4;
            border-color: var(--success-color);
            color: var(--success-color);
        }
        .question-dot.status-correct {
            background: #f0fdf4;
            border-color: var(--success-color);
            color: var(--success-color);
        }
        .question-dot.status-wrong {
            background: #fff5f5;
            border-color: var(--error-color);
            color: var(--error-color);
        }
        
        .question-dot.active {
            background: #f3f0ff !important;
            border-color: var(--primary-color) !important;
            color: var(--primary-color) !important;
            box-shadow: 0 0 0 1px var(--primary-color);
        }

        .exam-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .exam-card { 
            background: var(--card-bg); 
            border: 1px solid #e2e8f0; 
            border-radius: 12px; 
            padding: 22px; 
            transition: all 0.25s ease; 
            cursor: pointer; 
            position: relative; 
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .exam-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.12); 
            border-color: #cbd5e0; 
        }
        .exam-card::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 3px; 
            height: 100%; 
            background: var(--primary-gradient); 
            opacity: 0; 
            transition: opacity 0.25s; 
        }
        .exam-card:hover::before { opacity: 1; }
        
        .exam-card::after {
            content: 'åƒçº¸é›é¸¢';
            position: absolute;
            bottom: 25px;
            right: 20px;
            font-size: 70px;
            font-weight: 900;
            color: rgba(47, 182, 58, 0.08);
            line-height: 1;
            pointer-events: none;
            -webkit-user-select: none;
            user-select: none;
            transform: rotate(-12deg);
            font-family: 'Microsoft YaHei', 'SimHei', sans-serif;
            letter-spacing: 4px;
            opacity: 0.6;
        }
        
        .exam-title { 
            font-size: 1.25rem; 
            font-weight: 700; 
            color: var(--text-main); 
            margin-bottom: 10px; 
            line-height: 1.4; 
            position: relative;
            z-index: 1;
        }
        .exam-meta { 
            font-size: 0.85rem; 
            color: var(--text-secondary); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: 12px; 
            position: relative;
            z-index: 1;
        }
        .user-tag { 
            background: #f1f5f9; 
            padding: 4px 10px; 
            border-radius: 6px; 
            font-weight: 600; 
            font-size: 0.8rem; 
            color: #475569; 
        }

        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-title { font-size: 1.5rem; font-weight: 700; margin: 0; }

        .form-group { margin-bottom: 20px; text-align: left; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        .form-input { 
            width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: var(--radius-md); 
            font-size: 1rem; transition: border-color 0.2s; box-sizing: border-box;
        }
        .form-input:focus { border-color: var(--primary-color); outline: none; }
        
        .file-drop-zone { 
            border: 2px dashed #cbd5e0; padding: 40px; border-radius: var(--radius-md); 
            text-align: center; cursor: pointer; transition: all 0.2s; background: #f8fafc; margin-top: 10px;
        }
        .file-drop-zone:hover { border-color: var(--primary-color); background: #ebf8ff; }

        .question-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; line-height: 1.6; }
        .options { list-style: none; padding: 0; }
        .option-item { margin-bottom: 12px; }
        .option-item label { 
            display: flex; align-items: center; padding: 16px; border: 2px solid #e2e8f0; 
            border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; background: var(--card-bg);
            color: var(--text-main);
        }
        .option-item label:hover { background: #f7fafc; border-color: #cbd5e0; }
        .option-item label.selected { border-color: var(--primary-color); background: #ebf8ff; color: #2d3748; }
        .option-item label.correct { border-color: var(--success-color); background: #f0fff4; color: #276749; }
        .option-item label.wrong { border-color: var(--error-color); background: #fff5f5; color: #c53030; }

        body.dark-mode .option-item label { border-color: #4a5568; }
        body.dark-mode .option-item label:hover { background: #2d3748; border-color: #718096; }
        body.dark-mode .option-item label.selected { background: rgba(102, 126, 234, 0.2); border-color: var(--primary-color); color: #e2e8f0; }
        body.dark-mode .option-item label.correct { background: rgba(72, 187, 120, 0.2); border-color: var(--success-color); color: #9ae6b4; }
        body.dark-mode .option-item label.wrong { background: rgba(245, 101, 101, 0.2); border-color: var(--error-color); color: #feb2b2; }

        .option-item input { margin-right: 15px; width: 18px; height: 18px; accent-color: var(--primary-color); }

        textarea, input[type="text"], input[type="number"] { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: var(--radius-md); font-family: inherit; box-sizing: border-box; background: var(--card-bg); color: var(--text-main); }
        textarea { min-height: 100px; resize: vertical; }
        
        body.dark-mode textarea, 
        body.dark-mode input[type="text"], 
        body.dark-mode input[type="number"] {
            background: #2d3748;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        
        body.dark-mode textarea:focus,
        body.dark-mode input[type="text"]:focus,
        body.dark-mode input[type="number"]:focus {
            border-color: var(--primary-color);
            background: #1a202c;
            outline: none;
        }
        
        .btn { padding: 10px 20px; border-radius: var(--radius-md); border: none; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 4px 6px rgba(102, 126, 234, 0.25); }
        .btn-outline { background: var(--card-bg); border: 2px solid #e2e8f0; color: var(--text-main); }
        .btn-secondary { background: #edf2f7; color: var(--text-main); }

        body.dark-mode .btn-secondary { background: #4a5568; color: #e2e8f0; }

        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
            margin-left: 5px;
        }
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e0;
            transition: .4s;
            border-radius: 34px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 5px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 2;
        }
        input:checked + .slider {
            background-color: #667eea;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #667eea;
        }
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        /* é”™é¢˜æœ¬è‡ªåŠ¨æ·»åŠ æ»‘å—å¼€å…³ */
        .wrongbook-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }
        .wrongbook-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .wrongbook-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 28px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .wrongbook-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2), 0 1px 2px rgba(0,0,0,0.1);
            z-index: 2;
        }
        .wrongbook-switch input:checked + .wrongbook-slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        .wrongbook-switch input:checked + .wrongbook-slider:before {
            transform: translateX(24px);
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.4), 0 1px 3px rgba(0,0,0,0.2);
        }
        .wrongbook-switch:hover .wrongbook-slider {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);
        }
        .wrongbook-switch:hover input:checked + .wrongbook-slider {
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.25);
        }
        .wrongbook-switch input:focus + .wrongbook-slider {
            outline: 2px solid rgba(102, 126, 234, 0.5);
            outline-offset: 2px;
        }
        .icon-sun, .icon-moon {
            font-size: 14px;
            z-index: 1;
            user-select: none;
            line-height: 1;
        }
        .icon-sun { margin-left: 4px; }
        .icon-moon { margin-right: 4px; }

        body.dark-mode .slider {
            background-color: #4a5568;
        }
        body.dark-mode input:checked + .slider {
            background-color: #667eea;
        }

        .explanation-box { background: #fffaf0; border-left: 4px solid #ed8936; padding: 15px; border-radius: 4px; margin-top: 20px; color: #2d3748; }
        
        body.dark-mode .explanation-box { background: rgba(237, 137, 54, 0.15); border-left-color: #ed8936; color: #e2e8f0; }
        
        .result-box { text-align: center; padding: 40px 0; }
        .score-circle { width: 120px; height: 120px; background: var(--primary-gradient); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: 800; margin: 0 auto 20px; }

        .rateAndDataContainer { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; }
        .rating-display { display: flex; align-items: center; gap: 5px; }
        .rating-stars { display: flex; gap: 2px; cursor: pointer; }
        .rating-star { font-size: 1rem; color: #fbbf24; transition: all 0.2s; }
        .rating-star:hover { transform: scale(1.1); }
        .rating-star.empty { color: #d1d5db; }
        .rating-value { font-size: 0.9rem; color: #4b5563; font-weight: 600; margin-left: 4px; }
        .rating-count { font-size: 0.8rem; color: #9ca3af; margin-left: 4px; }
        .rating-no-data { font-size: 0.85rem; color: #9ca3af; }
        .rating-link { font-size: 0.85rem; color: #667eea; cursor: pointer; margin-left: 8px; text-decoration: underline; }
        .rating-link:hover { color: #764ba2; }
        .rating-date { font-size: 0.8rem; color: #a0aec0; }

        /* è¯„åˆ†å¼¹çª—æ ·å¼ */
        .rating-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .rating-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .rating-modal {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s;
        }
        .rating-modal-overlay.show .rating-modal {
            transform: scale(1) translateY(0);
        }
        .rating-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 20px;
            text-align: center;
        }
        .rating-modal-stars {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        .rating-modal-star {
            font-size: 2rem;
            color: #d1d5db;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        .rating-modal-star:hover {
            transform: scale(1.1);
        }
        .rating-modal-star.active {
            color: #fbbf24;
        }
        .rating-modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .rating-modal-btn {
            padding: 10px 24px;
            border-radius: 8px;
            border: none;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .rating-modal-btn-confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .rating-modal-btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .rating-modal-btn-cancel {
            background: #e5e7eb;
            color: #4b5563;
        }
        .rating-modal-btn-cancel:hover {
            background: #d1d5db;
        }

        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .footer { text-align: center; color: var(--text-secondary); font-size: 0.8rem; padding: 20px; }

        @media (max-width: 600px) {
            .main-wrapper { 
                padding: 8px; 
                max-width: 100%;
            }
            
            .header { 
                padding: 12px; 
                margin-bottom: 12px; 
                flex-direction: column; 
                align-items: stretch; 
                gap: 12px; 
            }
            .header > div {
                display: flex;
                align-items: center;
                gap: 8px;
                flex-wrap: wrap;
            }
            .header > div:first-child {
                justify-content: space-between;
            }
            .brand { 
                font-size: 1rem; 
                flex: 1;
                min-width: 0;
            }
            .header .btn {
                padding: 8px 12px;
                font-size: 0.85rem;
                white-space: nowrap;
                flex-shrink: 0;
            }
            .progress-container { 
                width: 100%; 
                justify-content: space-between; 
                font-size: 0.8rem;
            }
            .progress-bar { 
                flex: 1; 
                max-width: none; 
                height: 6px;
            }
            
            .content-box { 
                padding: 16px; 
                border-radius: 12px;
            }
            .question-title { 
                font-size: 1rem; 
                line-height: 1.5;
                margin-bottom: 16px;
            }
            .option-item label { 
                padding: 14px; 
                font-size: 0.9rem; 
                min-height: 44px; /* ç¡®ä¿è§¦æ‘¸ç›®æ ‡è¶³å¤Ÿå¤§ */
            }
            
            .action-bar { 
                flex-wrap: wrap; 
                gap: 8px; 
                margin-bottom: 16px;
            }
            .action-bar > div {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                width: 100%;
            }
            .section-title { 
                font-size: 1.1rem; 
                margin-bottom: 0;
            }
            .action-bar .btn {
                padding: 10px 14px;
                font-size: 0.85rem;
                flex: 1;
                min-width: 0;
            }
            
            .exam-grid { 
                grid-template-columns: 1fr; 
                gap: 12px;
                margin-top: 12px;
            }
            .exam-card { 
                padding: 16px; 
                border-radius: 10px;
            }
            .exam-card::after {
                font-size: 40px;
                bottom: 10px;
                right: 10px;
                opacity: 0.3;
            }
            .exam-title { 
                font-size: 1.05rem; 
                margin-bottom: 8px;
            }
            .exam-meta { 
                font-size: 0.8rem; 
                margin-top: 8px;
            }
            .user-tag {
                font-size: 0.75rem;
                padding: 3px 8px;
            }
            
            .sidebar-toggle { 
                display: flex; 
                width: 44px;
                height: 44px;
            }
            .quiz-sidebar {
                position: fixed;
                top: 0;
                right: 0;
                bottom: 0;
                width: 85%;
                max-width: 320px;
                border-radius: 0;
                margin: 0;
                transform: translateX(100%);
                box-shadow: -4px 0 12px rgba(0,0,0,0.1);
                padding-top: env(safe-area-inset-top, 20px);
                padding: env(safe-area-inset-top, 20px) 16px 16px 16px;
            }
            .quiz-sidebar.open {
                transform: translateX(0);
            }
            .sidebar-overlay.open {
                display: block;
            }

            .question-grid { 
                grid-template-columns: repeat(5, 1fr); 
                gap: 6px; 
                margin-top: 12px;
            }
            .question-dot { 
                font-size: 0.7rem; 
                min-height: 36px;
                padding: 4px;
                font-weight: 600;
            }

            .controls { 
                flex-direction: column; 
                gap: 10px; 
            }
            .btn { 
                min-height: 44px; /* ç¡®ä¿è§¦æ‘¸ç›®æ ‡è¶³å¤Ÿå¤§ */
                padding: 12px 16px;
                font-size: 0.9rem;
            }
            .btn-primary, .btn-outline, .btn-secondary {
                width: 100%;
            }
            
            .form-group {
                margin-bottom: 16px;
            }
            .form-label {
                font-size: 0.9rem;
                margin-bottom: 6px;
            }
            .form-input {
                padding: 12px;
                font-size: 0.9rem;
                min-height: 44px;
            }
            
            /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸä¼˜åŒ– */
            .file-drop-zone {
                padding: 24px 16px;
                min-height: 120px;
            }
            .file-drop-zone > div:first-child {
                font-size: 1.5rem;
            }
            .file-drop-zone > div:last-child {
                font-size: 0.85rem;
            }
            
            /* ä¸Šä¼ è¿›åº¦æ¡ä¼˜åŒ– */
            #upload-progress-box {
                padding: 16px;
            }
            #upload-logs {
                height: 60px;
                font-size: 0.75rem;
            }
            
            /* JSONæ¨¡æ¿åŒºåŸŸä¼˜åŒ– */
            #json-upload-group .file-drop-zone {
                padding: 20px 12px;
            }
            #json-template-pre {
                font-size: 0.7rem;
                padding: 10px;
                max-height: 200px;
            }
            
            /* èƒŒæ™¯è®¾ç½®å¼¹çª—ä¼˜åŒ– */
            .background-settings-modal {
                padding: 10px;
            }
            .background-settings-content {
                width: 100%;
                max-width: none;
                padding: 20px 16px;
                max-height: 90vh;
                margin: 0;
            }
            .background-settings-content h2 {
                font-size: 1.2rem;
            }
            .background-settings-content .btn-secondary {
                min-width: 44px;
                min-height: 44px;
                padding: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .background-preview {
                height: 150px;
            }
            .background-list {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
            .background-item {
                min-height: 80px;
            }
            .background-item-label {
                font-size: 0.7rem;
                padding: 4px;
            }
            .background-upload-zone {
                padding: 16px;
                min-height: 100px;
            }
            .background-upload-zone > div {
                font-size: 0.85rem;
            }
            
            /* æŒ‘æˆ˜æ¨¡å¼ä¾§è¾¹æ ä¼˜åŒ– */
            .challenge-sidebar {
                width: 85%;
                max-width: 320px;
            }
            
            /* é¡µè„šä¼˜åŒ– */
            .footer {
                padding: 16px;
                font-size: 0.75rem;
            }
            
            /* ç»“æœé¡µä¼˜åŒ– */
            .result-box {
                padding: 30px 0;
            }
            .score-circle {
                width: 100px;
                height: 100px;
                font-size: 2.5rem;
            }
        }

        @media (max-width: 900px) and (min-width: 601px) {
            .main-wrapper {
                padding: 15px;
            }
            .quiz-layout { 
                flex-direction: column; 
            }
            .quiz-sidebar { 
                width: 100%; 
                position: static; 
                max-height: none; 
                box-sizing: border-box; 
            }
            .exam-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .action-bar .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
        }
        
            /* è¶…å°å±å¹•ä¼˜åŒ– (å°äº400px) */
        @media (max-width: 400px) {
            .main-wrapper {
                padding: 6px;
            }
            .header {
                padding: 10px;
            }
            .brand {
                font-size: 0.9rem;
            }
            .header .btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            .content-box {
                padding: 12px;
            }
            .section-title {
                font-size: 1rem;
            }
            .action-bar .btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            .exam-card {
                padding: 12px;
            }
            .exam-title {
                font-size: 0.95rem;
            }
            .background-list {
                grid-template-columns: repeat(2, 1fr);
            }
            .question-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            .question-dot {
                font-size: 0.65rem;
                min-height: 32px;
            }
        }
        
        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (max-width: 900px) and (orientation: landscape) {
            .main-wrapper {
                padding: 10px;
            }
            .header {
                padding: 10px 15px;
                flex-direction: row;
                justify-content: space-between;
            }
            .header > div {
                flex: 1;
            }
            .content-box {
                padding: 16px;
            }
            .background-settings-content {
                max-height: 95vh;
            }
        }

    </style>
</head>
<body>

<div class="main-wrapper">
    <!-- é¡¶éƒ¨ -->
    <div class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="brand" onclick="toggleView('home')">åƒçº¸é›é¸¢Â·é¢˜åº“ç³»ç»ŸÂ·Online Quiz System</div>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <button class="btn btn-outline" style="padding: 8px;" onclick="toggleChallengeSidebar(true)">å†å²è®°å½•</button>
            <button class="btn btn-outline" style="padding: 8px;" onclick="openBackgroundSettings()">èƒŒæ™¯è®¾ç½®</button>
            
            <label class="theme-switch" title="åˆ‡æ¢æµ…è‰²/æ·±è‰²æ¨¡å¼">
                <input type="checkbox" id="theme-toggle-checkbox" onchange="toggleTheme()">
                <span class="slider round">
                    <span class="icon-sun">ğŸŒ</span>
                    <span class="icon-moon">ğŸŒœ</span>
                </span>
            </label>

            <div class="progress-container" id="progress-container" style="display:none;">
                <span id="progress-text"></span>
                <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
            </div>
        </div>
    </div>
    
    <!-- èƒŒæ™¯è®¾ç½®å¼¹çª— -->
    <div id="background-settings-modal" class="background-settings-modal" onclick="if(event.target.id === 'background-settings-modal') closeBackgroundSettings()">
        <div class="background-settings-content" onclick="event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 1.5rem;">èƒŒæ™¯è®¾ç½®</h2>
                <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="closeBackgroundSettings()" title="å…³é—­">âœ•</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">å½“å‰èƒŒæ™¯é¢„è§ˆ</label>
                <img id="background-preview" class="background-preview" src="" alt="èƒŒæ™¯é¢„è§ˆ" style="display: none;">
                <div id="background-preview-placeholder" style="width: 100%; height: 200px; background: var(--bg-color); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                    æ— èƒŒæ™¯
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">é€‰æ‹©èƒŒæ™¯</label>
                <div class="background-list" id="background-list">
                    <div class="background-item" data-bg="default" onclick="selectBackground('default')">
                        <div style="width: 100%; height: 100%; background: var(--bg-color); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-weight: 600;">
                            é»˜è®¤
                        </div>
                        <div class="background-item-label">é»˜è®¤ï¼ˆæ— èƒŒæ™¯ï¼‰</div>
                    </div>
                </div>
                <div id="background-load-more-container" style="text-align: center; margin-top: 15px; display: none;">
                    <button id="background-load-more-btn" class="btn btn-secondary" onclick="loadMoreBackgrounds()" style="padding: 8px 20px;">
                        åŠ è½½æ›´å¤š
                    </button>
                    <div id="background-loading" style="display: none; color: var(--text-secondary); margin-top: 10px;">åŠ è½½ä¸­...</div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">ä¸Šä¼ æ–°èƒŒæ™¯</label>
                <div class="background-upload-zone" onclick="document.getElementById('background-file-input').click()">
                    <div style="font-size: 1.2rem; margin-bottom: 10px; font-weight: 600;">IMAGE</div>
                    <div style="color: #4a5568; font-weight: 500;">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</div>
                    <input type="file" id="background-file-input" accept="image/*" style="display:none" onchange="handleBackgroundUpload()">
                </div>
                <input type="text" id="background-name-input" class="form-input" placeholder="ä¸ºèƒŒæ™¯å‘½åï¼ˆå¯é€‰ï¼‰" style="margin-top: 10px;">
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeBackgroundSettings()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ä»ªè¡¨ç›˜é¡µ -->
    <div id="view-dashboard" class="content-box hidden" style="background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3);">
        <div class="action-bar">
            <h2 class="section-title" style="letter-spacing: 1px;">ä»ªè¡¨ç›˜</h2>
            <button class="btn btn-secondary" onclick="toggleView('home')">è¿”å›é¦–é¡µ</button>
        </div>
        
        <div class="stats-grid-main">
            <!-- å·¦ä¾§ï¼šæ ¸å¿ƒæŒ‡æ ‡ -->
            <div class="stats-column-left">
                <!-- ç´¯è®¡æ—¶é•¿ - ç‰¹å¤§å¡ç‰‡ -->
                <div class="stats-card-premium highlight-blue">
                    <div class="stats-card-tag">Real-time</div>
                    <div class="stats-card-header">ä½ å·²ç´¯è®¡ä½¿ç”¨æ—¶é•¿</div>
                    <div id="stat-total-time" class="stats-card-value-hero">00:00:00:00</div>
                    <div class="stats-card-footer">ç³»ç»Ÿè¿è¡Œæ€»æ—¶é•¿: <span id="stat-system-uptime">--</span></div>
                </div>

                <div class="stats-row-sub">
                    <div class="stats-card-premium">
                        <div class="stats-card-header">å…¨åº“é¢˜ç›®æ€»é‡</div>
                        <div id="stat-total-questions" class="stats-card-value-mid">0</div>
                        <div class="stats-card-footer">å½“å‰å·²æ”¶å½•æœ‰æ•ˆé¢˜ç›®</div>
                    </div>
                    <div class="stats-card-premium">
                        <div class="stats-card-header">å½“å‰åœ¨çº¿å·ç‹</div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div id="stat-online-users" class="stats-card-value-mid">0</div>
                            <!-- <div class="ping-container">
                                <div class="ping-dot"></div>
                                <div class="ping-wave"></div>
                            </div> -->
                        </div>
                        <div class="stats-card-footer">æ´»è·ƒè®¿é—®å¹¶å‘æ•°</div>
                    </div>
                </div>

                <!-- æ— ç§å¥‰çŒ® - è£èª‰å¡ç‰‡ -->
                <div class="stats-card-premium honor-card">
                    <div class="stats-card-tag gold">Honor</div>
                    <div class="stats-card-header">æ— ç§å¥‰çŒ®</div>
                    <div style="display: flex; align-items: center; gap: 15px; margin-top: 5px;">
                        <div id="stat-top-uploader-name" class="stats-card-value-mid" style="color: #b45309;">--</div>
                        <div class="honor-badge">è´¡çŒ®ç‹ </div>
                    </div>
                    <div class="stats-card-footer">ç´¯è®¡ä¸Šä¼ äº† <span id="stat-top-uploader-count" style="font-weight: 700; color: #d97706;">0</span> ä¸ªèµ„æºé¢˜åº“</div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå›¾å½¢ç›‘æ§ -->
            <div class="stats-column-right">
                <!-- ç¡¬ä»¶èµ„æº -->
                <div class="stats-card-premium">
                    <div class="stats-card-header">æœåŠ¡å™¨çŠ¶æ€</div>
                    <div class="resource-visuals">
                        <div class="chart-wrapper-mini">
                            <canvas id="memChart"></canvas>
                            <div class="chart-overlay-text">
                                <span id="mem-usage-pct">0%</span>
                                <small>RAM</small>
                            </div>
                        </div>
                        <div class="chart-wrapper-mini">
                            <canvas id="storageChart"></canvas>
                            <div class="chart-overlay-text">
                                <span id="storage-usage-pct">0%</span>
                                <small>DISK</small>
                            </div>
                        </div>
                    </div>
                    <div class="resource-meta-list">
                        <div class="meta-row">
                            <span class="meta-label">èŠ‚ç‚¹åˆ†å¸ƒ</span>
                            <span id="stat-server-region" class="meta-value">æ­£åœ¨å®šä½...</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">å†…å­˜å ç”¨</span>
                            <span id="stat-mem-info" class="meta-value">-- / -- GB</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">ç£ç›˜å‰©ä½™</span>
                            <span id="stat-storage-info" class="meta-value">-- GB</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">æœåŠ¡çŠ¶æ€</span>
                            <span id="stat-server-status" class="meta-value status-online">åœ¨çº¿è¿è¡Œ</span>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card-premium">
                    <div class="stats-card-header">é¢˜åº“èµ„æºåˆ†å¸ƒ (Top 5)</div>
                    <div style="height: 180px; width: 100%; margin-top: 10px;">
                        <canvas id="subjectChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-disclaimer">
            å®æ—¶å±•ç¤ºæœåŠ¡å™¨èµ„æºè°ƒåº¦ï¼Œæœ¬é¡¹ç›®ä¸ºå…¬ç›Šé¡¹ç›®ï¼Œä¸è¦è¿‡æ¸¡å ç”¨æœåŠ¡å™¨èµ„æºã€‚
        </div>
    </div>

    <style>
        .stats-grid-main {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 24px;
            margin-top: 24px;
        }
        .stats-column-left, .stats-column-right {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .stats-row-sub {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        .stats-card-premium {
            background: var(--card-bg);
            padding: 28px;
            border-radius: 20px;
            border: 1px solid #f1f5f9;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.02), 0 8px 10px -6px rgba(0, 0, 0, 0.02);
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        .stats-card-premium:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
        }
        .stats-card-premium.highlight-blue,
        .stats-card-premium.honor-card {
            border-top: 1px solid #f1f5f9;
        }
        .stats-card-tag {
            display: none;
        }
        .stats-card-header {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 16px;
        }
        .stats-card-value-hero {
            font-size: 3.2rem;
            font-weight: 900;
            color: #0f172a;
            font-family: 'JetBrains Mono', 'Inter', monospace;
            letter-spacing: -0.03em;
        }
        .stats-card-value-mid {
            font-size: 2.2rem;
            font-weight: 800;
            color: #1e293b;
            letter-spacing: -0.02em;
        }
        .stats-card-footer {
            color: #94a3b8;
            font-size: 0.8rem;
            margin-top: 12px;
        }
        
        /* èµ„æºå±•ç¤ºåŒºåŸŸ */
        .resource-visuals {
            display: flex;
            justify-content: space-around;
            padding: 10px 0 20px 0;
        }
        .chart-wrapper-mini {
            width: 130px;
            height: 130px;
            position: relative;
        }
        .chart-overlay-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none;
        }
        .chart-overlay-text span {
            font-size: 1.25rem;
            font-weight: 800;
            color: #1e293b;
        }
        .chart-overlay-text small {
            font-size: 0.6rem;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
        }
        
        .resource-meta-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 10px;
            padding-top: 20px;
            border-top: 1px solid #f1f5f9;
        }
        .meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .meta-label {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 500;
        }
        .meta-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: #334155;
        }
        .status-online { color: #10b981; }
        
        /* åŠ¨ç”»ä¸ç‚¹ */
        .ping-container {
            position: relative;
            width: 12px;
            height: 12px;
        }
        .ping-dot {
            width: 100%;
            height: 100%;
            background: #10b981;
            border-radius: 50%;
        }
        .ping-wave {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #10b981;
            border-radius: 50%;
            animation: ping-animate 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }
        @keyframes ping-animate {
            75%, 100% { transform: scale(3.5); opacity: 0; }
        }
        
        .honor-badge {
            background: #fbbf24;
            color: white;
            font-size: 0.65rem;
            font-weight: 800;
            padding: 3px 8px;
            border-radius: 6px;
            box-shadow: 0 4px 6px -1px rgba(251, 191, 36, 0.3);
        }
        
        .stats-disclaimer {
            margin-top: 32px;
            text-align: center;
            color: #94a3b8;
            font-size: 0.75rem;
            font-style: italic;
        }
        
        @media (max-width: 1024px) {
            .stats-grid-main { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .stats-grid-main {
                grid-template-columns: 1fr;
                gap: 16px;
                margin-top: 16px;
            }
            
            .stats-card-premium {
                padding: 16px 20px;
            }
            
            .stats-card-value-hero {
                font-size: 1.8rem;  
                line-height: 1.2;
            }
            .stats-card-value-mid {
                font-size: 1.5rem;  
            }
            
            .stats-row-sub {
                gap: 12px;
            }
            
            .resource-visuals {
                gap: 10px;
                justify-content: space-around;
            }
            .chart-wrapper-mini {
                width: 100px;
                height: 100px;
            }
            .chart-overlay-text span {
                font-size: 1rem;
            }
            
            #view-dashboard .action-bar {
                flex-direction: row;  
                align-items: center;
                justify-content: space-between;
            }
            #view-dashboard .action-bar button {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
        }
    </style>

    <!-- 1. é¦–é¡µï¼šè¯•å·åˆ—è¡¨ -->
    <div id="view-home">
        <div class="action-bar">
            <h2 class="section-title">é¢˜åº“åˆ—è¡¨</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-outline" onclick="openDashboard()">ä»ªè¡¨ç›˜</button>
                <button class="btn btn-outline" style="border-color: #9333ea; color: #9333ea;" onclick="openChallengeConfig()">æŒ‘æˆ˜æ¨¡å¼</button>
                <button class="btn btn-outline" style="border-color: #e32910; color: #ea6133;" onclick="toggleView('wrongbook')">é”™é¢˜æœ¬</button>
                <button class="btn btn-outline" onclick="openKeyboardSettings()">å¿«æ·é”®è®¾ç½®</button>
                <button class="btn btn-outline" onclick="toggleView('api')">API æ–‡æ¡£</button>
                <button class="btn btn-primary" onclick="toggleView('upload')">ä¸Šä¼ æ–°é¢˜ç›®</button>
            </div>
        </div>
        
        <div class="exam-card">
            <p style="margin: 0; font-size: 0.95rem;">
                <strong>tipsï¼š</strong>æœ¬é¡¹ç›®GitHubåœ°å€ï¼š
                <a href="https://github.com/yxy3635/online_test" target="_blank" rel="noopener" style="color: #2563eb; text-decoration: underline; font-weight: 600;">
                    https://github.com/yxy3635/online_test
                </a>
                æ±‚startï¼
            </p><br />
            <p style="margin: 0; font-size: 0.95rem;">
                <strong>ä¸»é¡µï¼š</strong>
                <a href="http://www.qzcy2.top/" target="_blank" rel="noopener" style="color: #2563eb; text-decoration: underline; font-weight: 600;">
                    http://www.qzcy2.top/
                </a>
            </p>
        </div>
        
        <div id="exam-list" class="exam-grid">
            <!-- åŠ¨æ€æ¸²æŸ“ -->
            <p style="color: #718096; grid-column: 1/-1; text-align: center; padding: 40px;">æ­£åœ¨åŠ è½½é¢˜åº“...</p>
        </div>
        
        <!-- è¯„åˆ†å¼¹çª— -->
        <div id="rating-modal-overlay" class="rating-modal-overlay" onclick="closeRatingModal(event)">
            <div class="rating-modal" onclick="event.stopPropagation();">
                <div class="rating-modal-title">ä¸ºè¿™ä¸ªé¢˜åº“è¯„åˆ†</div>
                <div class="rating-modal-stars" id="rating-modal-stars">
                    <span class="rating-modal-star" data-rating="1">â˜…</span>
                    <span class="rating-modal-star" data-rating="2">â˜…</span>
                    <span class="rating-modal-star" data-rating="3">â˜…</span>
                    <span class="rating-modal-star" data-rating="4">â˜…</span>
                    <span class="rating-modal-star" data-rating="5">â˜…</span>
                </div>
                <div class="rating-modal-actions">
                    <button class="rating-modal-btn rating-modal-btn-cancel" onclick="closeRatingModal()">å–æ¶ˆ</button>
                    <button class="rating-modal-btn rating-modal-btn-confirm" onclick="confirmRating()">ç¡®è®¤è¯„åˆ†</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é”™é¢˜æœ¬é¡µ -->
    <div id="view-wrongbook" class="content-box hidden">
        <div class="action-bar">
            <h2 class="section-title">é”™é¢˜æœ¬</h2>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button class="btn btn-primary" id="btn-redo-all" onclick="startAllWrongQuestions()" style="display: none;">å…¨éƒ¨é‡åš</button>
                <button class="btn btn-danger" id="btn-delete-all" onclick="deleteAllWrongQuestions()" style="display: none; font-weight: 600;">ä¸€é”®åˆ é™¤</button>
                <div id="batch-actions" style="display: none; gap: 8px; align-items: center; margin-left: 10px; padding-left: 10px; border-left: 1px solid var(--border-color);">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()" style="cursor: pointer;">
                        <span style="font-size: 0.9rem;">å…¨é€‰</span>
                    </label>
                    <button class="btn btn-secondary" onclick="invertSelection()" style="padding: 6px 12px; font-size: 0.85rem;">åé€‰</button>
                    <button class="btn btn-danger" id="btn-delete-selected" onclick="deleteSelectedWrongQuestions()" style="padding: 6px 12px; font-size: 0.85rem; display: none;">åˆ é™¤é€‰ä¸­</button>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; padding: 6px 12px; border-left: 1px solid var(--border-color); margin-left: 10px;border: 1px solid #e2e8f0;border-radius: 20px;">
                    <span style="font-size: 0.9rem; white-space: nowrap; color: var(--text-main);">è‡ªåŠ¨æ·»åŠ é”™é¢˜æœ¬</span>
                    <label class="wrongbook-switch" title="å¼€å¯åï¼Œç­”é”™é¢˜ç›®æ—¶è‡ªåŠ¨æ·»åŠ åˆ°é”™é¢˜æœ¬">
                        <input type="checkbox" id="auto-add-wrongbook-toggle" onchange="toggleAutoAddWrongBook()">
                        <span class="wrongbook-slider"></span>
                    </label>
                </div>
                <button class="btn btn-secondary" onclick="toggleView('home')">è¿”å›é¦–é¡µ</button>
            </div>
        </div>
        
        <div id="wrongbook-list" class="exam-grid">
            <p style="color: #718096; grid-column: 1/-1; text-align: center; padding: 40px;">æš‚æ— é”™é¢˜</p>
        </div>
    </div>

    <!-- 2. ä¸Šä¼ é¡µ -->
    <div id="view-upload" class="content-box hidden">
        <div class="action-bar">
            <h2 class="section-title">ä¸Šä¼ æ–°é¢˜ç›®</h2>
        </div>
        
        
        <div class="form-group">
            <label class="form-label">ç§‘ç›®åç§° / è¯•å·æ ‡é¢˜</label>
            <input type="text" id="subjectName" class="form-input" placeholder="ä¾‹å¦‚ï¼š2024æœŸæœ«å¤ä¹ é¢˜">
        </div>
        
        <div class="form-group">
            <label class="form-label">ä¸Šä¼ è€…å§“å</label>
            <input type="text" id="uploaderName" class="form-input" placeholder="ä¾‹å¦‚ï¼šyxyå¤§å¸…æ¯”">
        </div>
        
        <div class="form-group" id="docx-upload-group">
            <label class="form-label">é¢˜ç›®æ–‡æ¡£ (.docx)</label>
            <div class="file-drop-zone" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 2rem; margin-bottom: 10px;">Document</div>
                <div id="fileName" style="color: #4a5568; font-weight: 500;">ç‚¹å‡»é€‰æ‹© Word æ–‡æ¡£</div>
                <input type="file" id="fileInput" accept=".docx" style="display:none" onchange="handleFileSelect()">
            </div>
        </div>

        <div class="form-group hidden" id="json-upload-group">
            <label class="form-label">JSON å¯¼å…¥</label>
            <div style="display: flex; gap: 16px; align-items: flex-start;">
                <!-- å·¦ä¾§ï¼šé€‰æ‹©æ–‡ä»¶ / ç²˜è´´ JSON -->
                <div style="flex: 1; min-width: 0;">
                    <div class="file-drop-zone" onclick="document.getElementById('jsonFileInput').click()">
                        <div style="font-size: 2rem; margin-bottom: 10px;">JSON</div>
                        <div id="jsonFileName" style="color: #4a5568; font-weight: 500;">ç‚¹å‡»é€‰æ‹© JSON æ–‡ä»¶ï¼ˆ.jsonï¼‰</div>
                        <input type="file" id="jsonFileInput" accept=".json,application/json" style="display:none" onchange="handleJsonFileSelect()">
                    </div>

                    <div style="margin-top: 12px; font-size: 0.9rem; color: #718096; font-weight: 600;">æˆ–ç›´æ¥ç²˜è´´ JSONï¼š</div>
                    <textarea id="jsonTextInput" placeholder="ç²˜è´´ JSONï¼ˆæ”¯æŒï¼š[é¢˜ç›®æ•°ç»„] æˆ– {questions:[...] }ï¼‰" style="min-height: 160px;"></textarea>
                </div>

                <!-- å³ä¾§ï¼šæ ¼å¼è¯´æ˜ -->
                <div style="width: 420px; max-width: 45%; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 14px; box-sizing: border-box;">
                    <div style="display:flex; align-items:center; justify-content: space-between; gap: 10px; margin-bottom: 10px;">
                        <div style="font-weight: 800; color: #2d3748;">æœ¬ç³»ç»Ÿ JSON æ ¼å¼ç¤ºä¾‹ï¼ˆå¯ç…§æŠ„ï¼‰</div>
                        <button class="btn btn-outline" type="button" style="padding: 6px 10px; font-size: 0.8rem;" onclick="copyJsonTemplate()">ä¸€é”®å¤åˆ¶</button>
                    </div>
                    <div style="font-size: 0.85rem; color: #718096; line-height: 1.5; margin-bottom: 10px;">
                        é¡¶å±‚å»ºè®®ä¸ºæ•°ç»„ï¼š<code>[{...},{...}]</code>ã€‚æ¯é¢˜å­—æ®µï¼š<code>title</code> / <code>type</code> / <code>options</code> / <code>answer</code> / <code>explanation</code>
                    </div>
                    <pre id="json-template-pre" style="margin:0; white-space: pre-wrap; font-size: 0.8rem; line-height: 1.45; color: var(--text-main); background: var(--card-bg); border: 1px solid #edf2f7; border-radius: 10px; padding: 12px; overflow:auto; max-height: 360px;">[
    {
        "type": "å•é€‰é¢˜",
        "title": "1+1ç­‰äºå¤šå°‘ï¼Ÿ",
        "options": [
        { "label": "A", "content": "1" },
        { "label": "B", "content": "2" },
        { "label": "C", "content": "3" },
        { "label": "D", "content": "4" }
        ],
        "answer": "B",
        "explanation": "åŸºç¡€æ•°å­¦è¿ç®—ï¼Œ1åŠ 1ç­‰äº2ã€‚"
    },
    {
        "type": "å¤šé€‰é¢˜",
        "title": "ä»¥ä¸‹å±äºå¶æ•°çš„æ˜¯ï¼Ÿ",
        "options": [
        { "label": "A", "content": "2" },
        { "label": "B", "content": "3" },
        { "label": "C", "content": "4" },
        { "label": "D", "content": "5" }
        ],
        "answer": "AC",
        "explanation": "èƒ½è¢«2æ•´é™¤çš„æ•°æ˜¯å¶æ•°ï¼Œ2å’Œ4ç¬¦åˆæ¡ä»¶ã€‚"
    },
    {
        "type": "åˆ¤æ–­é¢˜",
        "title": "3æ˜¯å¶æ•°ã€‚",
        "options": [],
        "answer": "é”™è¯¯",
        "explanation": "3ä¸èƒ½è¢«2æ•´é™¤ï¼Œå±äºå¥‡æ•°ã€‚"
    },
    {
        "type": "ç®€ç­”é¢˜",
        "title": "ç®€è¿°ä»€ä¹ˆæ˜¯å¥‡æ•°ã€‚",
        "options": [],
        "answer": "ä¸èƒ½è¢«2æ•´é™¤çš„æ•´æ•°å«åšå¥‡æ•°ï¼Œæ¯”å¦‚1ã€3ã€5ç­‰ã€‚",
        "explanation": ""
    },
    {
        "type": "å¡«ç©ºé¢˜",
        "title": "2+3ç­‰äº____ã€‚",
        "options": [],
        "answer": "5",
        "explanation": "åŸºç¡€åŠ æ³•è¿ç®—ï¼Œ2åŠ 3çš„ç»“æœæ˜¯5ã€‚"
    },
    {
        "type": "å¡«ç©ºé¢˜(å¦‚æœ‰ä¸¤ä¸ªç©ºçš„æƒ…å†µä»¥ç©ºæ ¼éš”å¼€)",
        "title": "6å¯ä»¥åˆ†æˆ___å’Œ___",
        "options": [],
        "answer": "2 4",
        "explanation": "2åŠ 4ç­‰äº6ï¼Œæ˜¯6çš„ä¸€ç§æ‹†åˆ†æ–¹å¼ã€‚"
    }
]</pre>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">è§£ææ¨¡å¼</label>
            <div style="display: flex; gap: 15px;">
                <label style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; display: flex; align-items: center;">
                    <input type="radio" name="uploadMode" value="normal" checked style="margin-right: 10px;" onchange="onUploadModeChange()">
                    <div>
                        <div style="font-weight: 600;">æ™®é€šä¸Šä¼ </div>
                        <div style="font-size: 0.8rem; color: #718096;">ä½¿ç”¨æ­£åˆ™è§£æï¼Œå…è´¹ï¼Œé€‚åˆæ ‡å‡†æ ¼å¼</div>
                    </div>
                </label>
                <label style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; display: flex; align-items: center;">
                    <input type="radio" name="uploadMode" value="ai" style="margin-right: 10px;" onchange="onUploadModeChange()">
                    <div>
                        <div style="font-weight: 600; color: #667eea;">AI æé€Ÿè§£æ</div>
                        <div style="font-size: 0.8rem; color: #718096;">ä½¿ç”¨ AI å¤§æ¨¡å‹ï¼Œç²¾å‡†è¯†åˆ«å¤æ‚æ ¼å¼</div>
                    </div>
                </label>
                <label style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; display: flex; align-items: center;">
                    <input type="radio" name="uploadMode" value="json" style="margin-right: 10px;" onchange="onUploadModeChange()">
                    <div>
                        <div style="font-weight: 600; color: #9333ea;">JSON å¯¼å…¥</div>
                        <div style="font-size: 0.8rem; color: #718096;">è·³è¿‡è§£æï¼ŒæŒ‰æ¨¡æ¿ç›´æ¥å…¥åº“ï¼ˆæœ€ç¨³ï¼‰</div>
                    </div>
                </label>
            </div>
        </div>

        <div style="text-align: right; margin-top: 30px;">
            <button class="btn btn-secondary" onclick="toggleView('home')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="uploadFile()">ç¡®è®¤ä¸Šä¼ </button>
        </div>
        
        <!-- ä¸Šä¼ è¿›åº¦æ¡ -->
        <div id="upload-progress-box" style="display:none; margin-top: 25px; padding: 20px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.95rem; font-weight: 600; color: #2d3748;">
                <span id="upload-status-text">å‡†å¤‡ä¸Šä¼ ...</span>
                <span id="upload-percent" style="color: var(--primary-color);">0%</span>
            </div>
            
            <!-- è¿›åº¦æ¡è½¨é“ -->
            <div style="width:100%; height:12px; background:#edf2f7; border-radius:999px; overflow:hidden; position: relative; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);">
                <div id="upload-progress-bar" style="width:0%; height:100%; background:var(--primary-gradient); border-radius: 999px; position: relative; box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);">
                    <!-- æµå…‰åŠ¨ç”»å±‚ -->
                    <div style="position: absolute; top: 0; left: 0; bottom: 0; right: 0; background-image: linear-gradient(45deg,rgba(255,255,255,.2) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.2) 50%,rgba(255,255,255,.2) 75%,transparent 75%,transparent); background-size: 20px 20px; animation: progress-stripes 0.5s linear infinite;"></div>
                </div>
            </div>

            <!-- å®æ—¶æ—¥å¿—åŒºåŸŸ -->
            <div id="upload-logs" style="margin-top: 15px; height: 80px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; color: var(--text-secondary); background: var(--card-bg); padding: 10px; border-radius: 6px; border: 1px solid #edf2f7; scroll-behavior: smooth;">
                <div style="color: var(--text-secondary);">ç­‰å¾…ä»»åŠ¡å¼€å§‹...</div>
            </div>
        </div>
        
        <p id="uploadStatus" style="text-align: center; margin-top: 15px; font-weight: 500; display:none;"></p>
    </div>

    <style>
        @keyframes progress-stripes {
            from { background-position: 20px 0; }
            to { background-position: 0 0; }
        }
        #upload-logs::-webkit-scrollbar { width: 4px; }
        #upload-logs::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
        .log-item { margin-bottom: 4px; animation: fadeIn 0.2s; }
        .log-item.highlight { color: var(--primary-color); font-weight: bold; }
        
        /* æŒ‘æˆ˜æ¨¡å¼ç›¸å…³ */
        .challenge-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 300px;
            background: var(--card-bg);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1100;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .challenge-sidebar.open { transform: translateX(0); }
        .challenge-history-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .history-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .history-card:hover { border-color: var(--primary-color); background: #f0f7ff; }
        .history-score { font-size: 1.2rem; font-weight: 800; color: var(--primary-color); }
        
        .multi-select-list {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
        }
        .select-item {
            display: flex;
            align-items: center;
            padding: 8px;
            gap: 10px;
            cursor: pointer;
        }
        .select-item:hover { background: #f7fafc; }

        /* AI åŠ©æ‰‹ç›¸å…³ */
        .ai-btn {
            background: #9333ea;
            color: white;
            margin-top: 15px;
            font-size: 0.85rem;
            padding: 8px 16px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.2s;
        }
        .ai-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3); }
        .ai-btn.thinking {
            background: linear-gradient(135deg, #9333ea 0%, #a855f7 50%, #9333ea 100%);
            background-size: 200% 200%;
            cursor: not-allowed;
            position: relative;
            overflow: visible;
            animation: ai-gradient-flow 3s ease-in-out infinite, ai-breathing 2.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            box-shadow: 
                0 4px 20px rgba(168, 85, 247, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .ai-btn.thinking::before {
            content: '';
            position: absolute;
            inset: -6px;
            border-radius: 999px;
            background: radial-gradient(circle at 50% 50%, rgba(168, 85, 247, 0.5) 0%, rgba(168, 85, 247, 0.2) 40%, transparent 70%);
            animation: ai-glow-pulse 2.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            z-index: -1;
        }
        
        .ai-btn.thinking::after {
            content: '';
            position: absolute;
            top: 20%;
            left: 15%;
            width: 3px;
            height: 3px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            animation: ai-particle-1 2s ease-in-out infinite;
            box-shadow: 
                0 0 6px rgba(255, 255, 255, 0.8),
                0 0 12px rgba(255, 255, 255, 0.4);
        }
        
        .ai-btn.thinking .thinking-icon {
            display: inline-block;
            animation: ai-icon-rotate 3s ease-in-out infinite;
            filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.6));
            transform-origin: center;
        }
        
        .ai-btn.thinking .thinking-text {
            display: inline-block;
        }
        
        .ai-btn.thinking .thinking-dots {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            margin-left: 2px;
        }
        
        .ai-btn.thinking .thinking-dot {
            display: inline-block;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            animation: ai-dot-bounce 1.4s ease-in-out infinite;
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.6);
        }
        
        .ai-btn.thinking .thinking-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .ai-btn.thinking .thinking-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .ai-btn.thinking .thinking-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes ai-gradient-flow {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }
        
        @keyframes ai-breathing {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }
        
        @keyframes ai-glow-pulse {
            0%, 100% {
                opacity: 0.6;
                transform: scale(0.98);
            }
            50% {
                opacity: 1;
                transform: scale(1.15);
            }
        }
        
        @keyframes ai-particle-1 {
            0%, 100% {
                opacity: 0;
                transform: translate(0, 0) scale(0.5);
            }
            25% {
                opacity: 1;
                transform: translate(10px, -5px) scale(1.2);
            }
            50% {
                opacity: 0.7;
                transform: translate(20px, 5px) scale(0.8);
            }
            75% {
                opacity: 1;
                transform: translate(15px, -3px) scale(1);
            }
        }
        
        @keyframes ai-icon-rotate {
            0%, 100% {
                transform: rotate(0deg) scale(1);
                opacity: 1;
            }
            25% {
                transform: rotate(5deg) scale(1.1);
                opacity: 0.9;
            }
            50% {
                transform: rotate(0deg) scale(1);
                opacity: 1;
            }
            75% {
                transform: rotate(-5deg) scale(1.1);
                opacity: 0.9;
            }
        }
        
        @keyframes ai-dot-bounce {
            0%, 100% {
                transform: translateY(0) scale(1);
                opacity: 0.7;
            }
            50% {
                transform: translateY(-8px) scale(1.3);
                opacity: 1;
            }
        }

        .ai-box {
            margin-top: 15px;
            background: #fdf4ff;
            border: 1px solid #f0abfc;
            border-radius: 8px;
            padding: 15px;
            animation: fadeIn 0.3s;
        }
        .ai-title {
            font-weight: 700;
            color: #9333ea;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ai-content {
            font-size: 0.95rem;
            color: #4a5568;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* --- æŒ‘æˆ˜æ¨¡å¼æ ·å¼ --- */
        .challenge-layout {
            display: flex;
            gap: 24px;
            height: calc(100vh - 140px);
            min-height: 500px;
        }
        .challenge-main {
            flex: 1;
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 30px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .challenge-sidebar {
            width: 320px;
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
        }
        .history-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 15px;
            padding-right: 5px;
        }
        .history-item {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }
        .history-item:hover {
            border-color: #cbd5e0;
            background: #f7fafc;
            border-left-color: var(--primary-color);
        }
        .history-meta {
            font-size: 0.8rem;
            color: #718096;
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
        }
        .history-score {
            font-weight: 800;
            color: var(--primary-color);
        }
        .score-badge {
            background: #ebf4ff;
            color: #4299e1;
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        .challenge-select {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 20px;
            background: var(--card-bg);
            color: var(--text-main);
        }
        
        @media (max-width: 768px) {
            .challenge-layout { 
                flex-direction: column; 
                height: auto; 
                gap: 16px;
            }
            .challenge-sidebar { 
                width: 100%; 
                max-height: 400px; 
            }
            .challenge-main {
                padding: 20px;
            }
        }
        
        /* ç§»åŠ¨ç«¯æŒ‘æˆ˜æ¨¡å¼ä¼˜åŒ– */
        @media (max-width: 600px) {
            .challenge-layout {
                gap: 12px;
            }
            .challenge-main {
                padding: 16px;
            }
            .challenge-sidebar {
                padding: 16px;
            }
            .challenge-select {
                font-size: 0.9rem;
                padding: 10px;
            }
            .multi-select-list {
                max-height: 250px;
            }
            .select-item {
                padding: 10px;
                min-height: 44px;
            }
        }
    </style>

    <!-- 3. ç­”é¢˜é¡µ -->
    <div id="view-quiz" class="hidden">
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar(false)"></div>
        <button class="sidebar-toggle" onclick="toggleSidebar(true)">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
        <div class="quiz-layout">
            <div class="quiz-main content-box">
                <div class="action-bar" style="align-items: flex-start;">
                    <div style="display: flex; flex-direction: column;">
                        <h3 id="quiz-subject-title" style="margin:0; font-size:1.1rem; word-break: break-all; padding-right: 10px;">æ­£åœ¨ç­”é¢˜</h3>
                        <div id="quiz-mode-tag" style="font-size: 0.75rem; margin-top: 4px; display: none;">
                            <span style="background: #fdf2f8; color: #db2777; padding: 2px 6px; border-radius: 4px; font-weight: 700; border: 1px solid #fbcfe8;">æŒ‘æˆ˜æ¨¡å¼</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem; flex-shrink: 0;" onclick="exitQuiz()">é€€å‡º</button>
                </div>
                
                <div id="question-container"></div>
                
                
                
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px; border-top: 1px solid #edf2f7; padding-top: 20px;">
                    <button class="btn btn-secondary" id="btn-prev" onclick="goToPreviousQuestion()" style="display: none;">ä¸Šä¸€é¢˜</button>
                    <button class="btn btn-secondary" id="btn-add-wrong" onclick="addToWrongBook()" style="display: none;">åŠ å…¥é”™é¢˜</button>
                    <button class="btn btn-primary" id="btn-action" onclick="handleAction()">æäº¤æœ¬é¢˜</button>
                </div>
            </div>
            
            <div class="quiz-sidebar" id="quiz-sidebar">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0; font-size: 1rem; color: var(--text-main);">é¢˜ç›®å¯¼èˆª</h4>
                    <button class="btn-secondary" style="border:none; background:none; cursor:pointer; display:none;" id="mobile-close-sidebar" onclick="toggleSidebar(false)">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">
                    å·²ç­”: <span id="answered-count">0</span> / <span id="total-count">0</span>
                </div>
                <div id="question-nav-grid" class="question-grid">
                    <!-- åŠ¨æ€ç”Ÿæˆé¢˜å· -->
                </div>
            </div>
        </div>
    </div>

    <!-- æŒ‘æˆ˜è®°å½•ä¾§è¾¹æ  -->
    <div id="challenge-sidebar" class="challenge-sidebar">
        <div style="padding: 20px; border-bottom: 1px solid #edf2f7; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 1.2rem;">æŒ‘æˆ˜å†å²è®°å½•</h3>
            <button class="btn-secondary" style="border:none; background:none; cursor:pointer;" onclick="toggleChallengeSidebar(false)">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div id="challenge-history-list" class="challenge-history-list">
            <!-- å†å²è®°å½• -->
        </div>
    </div>
    <div class="sidebar-overlay" id="challenge-overlay" onclick="toggleChallengeSidebar(false)"></div>

    <!-- 6. æŒ‘æˆ˜æ¨¡å¼é…ç½®é¡µ -->
    <div id="view-challenge" class="content-box hidden">
        <div class="action-bar">
            <h2 class="section-title">å¼€å¯æŒ‘æˆ˜</h2>
            <button class="btn btn-secondary" onclick="toggleView('home')">è¿”å›</button>
        </div>
        
        <p style="color: var(--text-secondary); margin-bottom: 30px;">é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªé¢˜åº“ï¼Œç³»ç»Ÿå°†ä»ä¸­éšæœºæŠ½å–é¢˜ç›®ç»„æˆæŒ‘æˆ˜ã€‚</p>

        <div class="form-group">
            <label class="form-label">é€‰æ‹©é¢˜åº“ (å¯å¤šé€‰)</label>
            <div id="challenge-exam-list" class="multi-select-list">
                <!-- é¢˜åº“åˆ—è¡¨ -->
            </div>
        </div>

        <div class="form-group" style="margin-top: 25px;">
            <label class="form-label">é€‰æ‹©é¢˜å‹ (å¯å¤šé€‰)</label>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <input type="checkbox" name="challenge-types" value="å•é€‰é¢˜" checked style="width: 18px; height: 18px;">
                    <span>å•é€‰é¢˜</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <input type="checkbox" name="challenge-types" value="å¤šé€‰é¢˜" checked style="width: 18px; height: 18px;">
                    <span>å¤šé€‰é¢˜</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <input type="checkbox" name="challenge-types" value="åˆ¤æ–­é¢˜" checked style="width: 18px; height: 18px;">
                    <span>åˆ¤æ–­é¢˜</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <input type="checkbox" name="challenge-types" value="ç®€ç­”é¢˜" checked style="width: 18px; height: 18px;">
                    <span>ç®€ç­”é¢˜</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <input type="checkbox" name="challenge-types" value="å¡«ç©ºé¢˜" checked style="width: 18px; height: 18px;">
                    <span>å¡«ç©ºé¢˜</span>
                </label>
            </div>
        </div>

        <div class="form-group" style="margin-top: 25px;">
            <label class="form-label">æŠ½å–é¢˜ç›®æ•°é‡</label>
            <div style="display: flex; align-items: center; gap: 15px;">
                <input type="number" id="challenge-count" class="form-input" value="10" min="1" max="100" style="width: 120px;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">(å»ºè®® 10-50 é¢˜)</span>
            </div>
        </div>

        <div style="margin-top: 40px; padding: 20px; background: #fffbeb; border-radius: 12px; border: 1px solid #fef3c7;">
            <div style="display: flex; gap: 12px; align-items: flex-start;">
                <div style="font-size: 0.9rem; color: #92400e; line-height: 1.6;">
                    <strong>æŒ‘æˆ˜æ¨¡å¼è§„åˆ™ï¼š</strong><br>
                    1. é¢˜ç›®å°†ä»æ‰€é€‰é¢˜åº“ä¸­å…¨éšæœºæŠ½å–ã€‚<br>
                    2. æŒ‘æˆ˜ç»“æœå°†ä¿å­˜åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å†å²è®°å½•ä¸­ã€‚<br>
                    3. æŒ‘æˆ˜è¿‡ç¨‹ä¸­é€€å‡ºä¸ä¼šä¿å­˜è¿›åº¦ã€‚
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 40px;">
            <button class="btn btn-primary" style="padding: 15px 60px; font-size: 1.1rem;" onclick="startChallenge()">ç«‹å³å¼€å§‹æŒ‘æˆ˜</button>
        </div>
    </div>

    <!-- 4. ç»“æœé¡µ -->
    <div id="view-result" class="content-box hidden result-box">
        <h2>ç»ƒä¹ å®Œæˆ</h2>
        <div class="score-circle" id="score-display">0</div>
        <p id="score-detail" style="font-size: 1.1rem; color: var(--text-secondary);">--</p>
        <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
            <button class="btn btn-outline" onclick="toggleView('home')">è¿”å›é¦–é¡µ</button>
            <button class="btn btn-primary" onclick="restartQuiz()">å†ç»ƒä¸€æ¬¡</button>
        </div>
    </div>

    <!-- 5. API æ–‡æ¡£é¡µ -->
    <div id="view-api" class="content-box hidden">
        <div class="action-bar">
            <h2 class="section-title">API æ¥å£æ–‡æ¡£</h2>
            <button class="btn btn-secondary" onclick="toggleView('home')">è¿”å›</button>
        </div>
        <div style="background:#f7fafc; padding:20px; border-radius:8px; margin-bottom:20px;">
            <strong>GET /api/exams</strong>
            <p style="font-size:0.9rem; color:#4a5568;">è·å–æ‰€æœ‰è¯•å·åˆ—è¡¨</p>
        </div>
        <div style="background:#f7fafc; padding:20px; border-radius:8px; margin-bottom:20px;">
            <strong>GET /api/questions?exam_id=ID</strong>
            <p style="font-size:0.9rem; color:#4a5568;">è·å–æŒ‡å®šè¯•å·çš„é¢˜ç›®</p>
        </div>
        <div style="background:#f7fafc; padding:20px; border-radius:8px; margin-bottom:20px;">
            <strong>POST /api/upload</strong>
            <p style="font-size:0.9rem; color:#4a5568;">å‚æ•°: file (docx), uploader (string), subject (string)</p>
        </div>
        <div style="background:#f7fafc; padding:20px; border-radius:8px; margin-bottom:20px;">
            <strong>POST /api/upload/ai</strong>
            <p style="font-size:0.9rem; color:#4a5568;">AIä¸Šä¼ ï¼ˆæµå¼è¿”å›è¿›åº¦ï¼‰ï¼Œå‚æ•°: file (docx), uploader (string), subject (string)</p>
        </div>
        <div style="background:#f7fafc; padding:20px; border-radius:8px; margin-bottom:20px;">
            <strong>POST /api/upload/json</strong>
            <p style="font-size:0.9rem; color:#4a5568;">Body: { uploader?: string, subject?: string, questions: Array } æˆ–ç›´æ¥ä¼ æ•°ç»„</p>
        </div>
        <div style="background:#f7fafc; padding:20px; border-radius:8px; margin-bottom:20px;">
            <strong>POST /api/upload/background</strong>
            <p style="font-size:0.9rem; color:#4a5568;">å‚æ•°: background (å›¾ç‰‡æ–‡ä»¶), name (å¯é€‰, string)</p>
        </div>
        <div style="background:#f7fafc; padding:20px; border-radius:8px; margin-bottom:20px;">
            <strong>GET /api/backgrounds</strong>
            <p style="font-size:0.9rem; color:#4a5568;">å‚æ•°: page (å¯é€‰, é»˜è®¤1), pageSize (å¯é€‰, é»˜è®¤20)</p>
        </div>
        <div style="background:#f7fafc; padding:20px; border-radius:8px; margin-bottom:20px;">
            <strong>POST /api/ask-ai</strong>
            <p style="font-size:0.9rem; color:#4a5568;">Body: { question: object, userAnswer?: string }</p>
        </div>
        <div style="background:#f7fafc; padding:20px; border-radius:8px; margin-bottom:20px;">
            <strong>POST /api/heartbeat</strong>
            <p style="font-size:0.9rem; color:#4a5568;">Body: { userId?: string }</p>
        </div>
        <div style="background:#f7fafc; padding:20px; border-radius:8px;">
            <strong>GET /api/stats</strong>
            <p style="font-size:0.9rem; color:#4a5568;">è·å–ä»ªè¡¨ç›˜æ•°æ®</p>
        </div>
    </div>
</div>

<div class="footer">&copy; åƒçº¸é›é¸¢ Â· Online Quiz System | github <a href="https://github.com/yxy3635/online_test" target="_blank" rel="noopener">https://github.com/yxy3635/online_test</a></div>

<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 10002; pointer-events: none;"></div>

<!-- é¢˜ç›®é¢„è§ˆæ¨¡æ€æ¡† -->
<div id="question-preview-modal" class="question-preview-modal" onclick="closeQuestionPreview(event)">
    <div class="question-preview-content" onclick="event.stopPropagation();">
        <div class="question-preview-header">
            <div class="question-preview-title">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 10px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
                <h2>é¢˜ç›®é¢„è§ˆ</h2>
            </div>
            <button class="question-preview-close" onclick="closeQuestionPreview()" title="å…³é—­">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="question-preview-body">
            <div style="padding: 15px; background: #f0f9ff; border-radius: 8px; margin-bottom: 20px; border: 1px solid #bae6fd;">
                <div style="font-size: 1.1rem; font-weight: 600; color: #0369a1; margin-bottom: 5px;">
                    æœ¬æ¬¡ä¸Šä¼  <span id="preview-question-count" style="color: #0284c7; font-size: 1.3rem;">0</span> é“é¢˜
                </div>
                <div style="font-size: 0.9rem; color: #075985;">è¯·ä»”ç»†æ£€æŸ¥é¢˜ç›®å†…å®¹ï¼Œç¡®è®¤æ— è¯¯åç‚¹å‡»"ç¡®è®¤ä¸Šä¼ "</div>
            </div>
            <div id="preview-questions-list" style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                <!-- é¢˜ç›®åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="question-preview-footer">
            <button class="btn btn-secondary" onclick="closeQuestionPreview()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="confirmUpload()">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 6px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                ç¡®è®¤ä¸Šä¼ 
            </button>
        </div>
    </div>
</div>

<!-- å¿«æ·é”®è®¾ç½®æ¨¡æ€æ¡† -->
<div id="keyboard-settings-modal" class="keyboard-settings-modal" onclick="closeKeyboardSettings(event)">
    <div class="keyboard-settings-content" onclick="event.stopPropagation();">
        <div class="keyboard-settings-header">
            <div class="keyboard-settings-title">
                <svg class="keyboard-settings-icon" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                </svg>
                <h2>å¿«æ·é”®è®¾ç½®</h2>
            </div>
            <button class="keyboard-settings-close" onclick="closeKeyboardSettings()" title="å…³é—­">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="keyboard-settings-body">
            <div class="keyboard-simulator-container">
                <div class="keyboard-simulator" id="keyboard-simulator">
                    <!-- é”®ç›˜å¸ƒå±€å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="keyboard-settings-list" id="keyboard-settings-list">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="keyboard-settings-footer">
            <button class="btn btn-secondary" onclick="resetKeyboardSettings()">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 6px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                æ¢å¤é»˜è®¤
            </button>
            <button class="btn btn-primary" onclick="saveKeyboardSettings()">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 6px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                ä¿å­˜è®¾ç½®
            </button>
        </div>
    </div>
</div>

<style>
    .toast {
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: toastSlideIn 0.3s ease-out, toastFadeOut 0.3s ease-in 2.7s;
        pointer-events: auto;
        max-width: 300px;
        font-size: 0.9rem;
    }
    
    /* å¿«æ·é”®æç¤ºæ ·å¼ */
    kbd {
        display: inline-block;
        padding: 4px 8px;
        font-size: 0.75rem;
        font-family: monospace;
        background: #fff;
        border: 1px solid #cbd5e0;
        border-radius: 4px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        color: var(--text-main);
        font-weight: 600;
        min-width: 24px;
        text-align: center;
    }
    
    body.dark-mode kbd {
        background: #2d3748;
        border-color: #4a5568;
        color: var(--text-main);
    }
    
    /* é¢˜ç›®é¢„è§ˆæ¨¡æ€æ¡†æ ·å¼ */
    .question-preview-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10002;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        animation: modalFadeIn 0.2s ease-out;
    }
    
    .question-preview-modal.open {
        display: flex;
    }
    
    .question-preview-content {
        background: var(--card-bg);
        border-radius: 16px;
        max-width: 900px;
        width: 90%;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(0, 0, 0, 0.05);
        animation: modalSlideUp 0.3s ease-out;
        overflow: hidden;
    }
    
    .question-preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 28px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    }
    
    .question-preview-title {
        display: flex;
        align-items: center;
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-main);
    }
    
    .question-preview-close {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        color: var(--text-secondary);
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .question-preview-close:hover {
        background: rgba(0, 0, 0, 0.05);
        color: var(--text-main);
    }
    
    .question-preview-body {
        padding: 24px 28px;
        overflow-y: auto;
        flex: 1;
    }
    
    .question-preview-item {
        padding: 16px;
        margin-bottom: 12px;
        background: var(--card-bg);
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        transition: all 0.2s;
    }
    
    .question-preview-item:hover {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }
    
    .question-preview-item-title {
        font-weight: 600;
        color: var(--text-main);
        margin-bottom: 8px;
        font-size: 0.95rem;
    }
    
    .question-preview-item-meta {
        display: flex;
        gap: 12px;
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }
    
    .question-preview-item-options {
        margin-top: 8px;
        padding-left: 12px;
    }
    
    .question-preview-item-option {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin: 4px 0;
    }
    
    .question-preview-item-answer {
        margin-top: 8px;
        padding: 8px 12px;
        background: #f0f9ff;
        border-left: 3px solid #0284c7;
        border-radius: 4px;
        font-size: 0.85rem;
        color: #0369a1;
    }
    
    .question-preview-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 20px 28px;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        background: rgba(0, 0, 0, 0.02);
    }
    
    #preview-questions-list::-webkit-scrollbar {
        width: 6px;
    }
    
    #preview-questions-list::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 3px;
    }
    
    #preview-questions-list::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }

    /* å¿«æ·é”®è®¾ç½®æ¨¡æ€æ¡†æ ·å¼ */
    .keyboard-settings-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        animation: modalFadeIn 0.2s ease-out;
    }
    
    @keyframes modalFadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
    
    .keyboard-settings-modal.open {
        display: flex;
    }
    
    .keyboard-settings-content {
        background: var(--card-bg);
        border-radius: 16px;
        max-width: 640px;
        width: 90%;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(0, 0, 0, 0.05);
        animation: modalSlideUp 0.3s ease-out;
        overflow: hidden;
    }
    
    @keyframes modalSlideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .keyboard-settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 28px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    }
    
    body.dark-mode .keyboard-settings-header {
        border-bottom-color: rgba(255, 255, 255, 0.1);
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }
    
    .keyboard-settings-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .keyboard-settings-icon {
        color: var(--primary-color);
        flex-shrink: 0;
    }
    
    .keyboard-settings-title h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-main);
        letter-spacing: -0.02em;
    }
    
    .keyboard-settings-close {
        border: none;
        background: rgba(0, 0, 0, 0.05);
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        color: var(--text-secondary);
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
    }
    
    .keyboard-settings-close:hover {
        background: rgba(0, 0, 0, 0.1);
        color: var(--text-main);
        transform: rotate(90deg);
    }
    
    body.dark-mode .keyboard-settings-close {
        background: rgba(255, 255, 255, 0.1);
    }
    
    body.dark-mode .keyboard-settings-close:hover {
        background: rgba(255, 255, 255, 0.15);
    }
    
    .keyboard-settings-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px 28px;
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        scrollbar-width: thin;
        scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
    }
    
    .keyboard-settings-body::-webkit-scrollbar {
        width: 8px;
    }
    
    .keyboard-settings-body::-webkit-scrollbar-track {
        background: transparent;
        border-radius: 4px;
    }
    
    .keyboard-settings-body::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.3);
        border-radius: 4px;
        transition: background 0.2s;
    }
    
    .keyboard-settings-body::-webkit-scrollbar-thumb:hover {
        background: rgba(102, 126, 234, 0.5);
    }
    
    body.dark-mode .keyboard-settings-body {
        scrollbar-color: rgba(102, 126, 234, 0.5) transparent;
    }
    
    body.dark-mode .keyboard-settings-body::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.5);
    }
    
    body.dark-mode .keyboard-settings-body::-webkit-scrollbar-thumb:hover {
        background: rgba(102, 126, 234, 0.7);
    }
    
    .keyboard-settings-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .keyboard-setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 18px;
        background: #f8fafc;
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .keyboard-setting-item:hover {
        border-color: var(--primary-color);
        background: #f0f4ff;
        transform: translateX(4px);
    }
    
    .keyboard-setting-item.active {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    body.dark-mode .keyboard-setting-item {
        background: #1e293b;
        border-color: #334155;
    }
    
    body.dark-mode .keyboard-setting-item:hover {
        background: #1e3a8a;
        border-color: var(--primary-color);
    }
    
    body.dark-mode .keyboard-setting-item.active {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(102, 126, 234, 0.1) 100%);
    }
    
    .keyboard-setting-item .label {
        flex: 1;
        font-weight: 500;
        font-size: 0.95rem;
        color: var(--text-main);
    }
    
    .keyboard-setting-item .key-display {
        padding: 6px 12px;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-family: monospace;
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--primary-color);
        min-width: 50px;
        text-align: center;
    }
    
    body.dark-mode .keyboard-setting-item .key-display {
        background: #0f172a;
        border-color: #334155;
    }
    
    .keyboard-settings-current {
        text-align: center;
        padding: 20px;
        margin-bottom: 20px;
        background: rgba(102, 126, 234, 0.05);
        border-radius: 12px;
        border: 2px dashed rgba(102, 126, 234, 0.2);
    }
    
    .current-setting-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }
    
    .current-setting-key {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        font-family: monospace;
    }
    
    .keyboard-simulator-container {
        margin: 0 0 20px 0;
        padding: 12px;
        background: rgba(0, 0, 0, 0.02);
        border-radius: 12px;
        overflow: visible;
    }
    
    .keyboard-simulator {
        display: flex;
        flex-direction: column;
        gap: 4px;
        width: 100%;
        margin: 0 auto;
        transform: scale(0.85);
        transform-origin: top center;
    }
    
    .keyboard-row {
        display: flex;
        gap: 3px;
        justify-content: center;
        flex-wrap: nowrap;
    }
    
    .keyboard-key {
        padding: 8px 10px;
        background: #fff;
        border: 2px solid #e2e8f0;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-main);
        transition: all 0.15s;
        min-width: 38px;
        width: auto;
        text-align: center;
        user-select: none;
        position: relative;
        flex-shrink: 0;
        white-space: nowrap;
    }
    
    .keyboard-key:hover {
        background: #f8faff;
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .keyboard-key.active {
        background: var(--primary-color);
        color: #fff;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
    }
    
    .keyboard-key.assigned {
        background: #eef2ff;
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    .keyboard-key.wide {
        min-width: 60px;
    }
    
    .keyboard-key.space {
        min-width: 180px;
        flex-grow: 0;
    }
    
    body.dark-mode .keyboard-settings-current {
        background: rgba(102, 126, 234, 0.1);
        border-color: rgba(102, 126, 234, 0.3);
    }
    
    body.dark-mode .keyboard-simulator-container {
        background: rgba(255, 255, 255, 0.02);
    }
    
    body.dark-mode .keyboard-key {
        background: #1e293b;
        border-color: #334155;
        color: var(--text-main);
    }
    
    body.dark-mode .keyboard-key:hover {
        background: #1e3a8a;
        border-color: var(--primary-color);
    }
    
    body.dark-mode .keyboard-key.assigned {
        background: rgba(102, 126, 234, 0.2);
        border-color: var(--primary-color);
    }
    
    .keyboard-settings-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 20px 28px;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        background: rgba(0, 0, 0, 0.02);
    }
    
    body.dark-mode .keyboard-settings-footer {
        border-top-color: rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.02);
    }
    
    .keyboard-settings-footer .btn {
        display: flex;
        align-items: center;
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .keyboard-settings-footer .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    @keyframes keyListening {
        0%, 100% {
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
            transform: scale(1);
        }
        50% {
            box-shadow: 0 0 0 8px rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }
    }
    
    @media (max-width: 640px) {
        .keyboard-settings-content {
            width: 95%;
            max-height: 90vh;
            border-radius: 12px;
        }
        
        .keyboard-settings-header {
            padding: 20px;
        }
        
        .keyboard-settings-body {
            padding: 16px 20px;
        }
        
        .keyboard-settings-footer {
            padding: 16px 20px;
            flex-direction: column-reverse;
        }
        
        .keyboard-settings-footer .btn {
            width: 100%;
            justify-content: center;
        }
        
        .keyboard-setting-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }
        
        .keyboard-simulator-container {
            padding: 12px;
            margin: 16px 0;
        }
        
        .keyboard-simulator {
            gap: 4px;
            min-width: 500px;
        }
        
        .keyboard-key {
            padding: 8px 10px;
            font-size: 0.7rem;
            min-width: 36px;
        }
        
        .keyboard-key.wide {
            min-width: 60px;
        }
        
        .keyboard-key.space {
            min-width: 150px;
        }
    }
</style>

<script>
    let examList = [];
    let currentQuestions = [];
    let currentIndex = 0;
    let score = 0;
    let currentStep = 'answering'; // answering | reviewed
    let currentExamId = null;
    let answeredIndices = new Set(); // è®°å½•å·²ä½œç­”çš„é¢˜ç›®ç´¢å¼•
    let userAnswersMap = {}; // è®°å½•æ¯ä¸€é¢˜çš„ç”¨æˆ·ç­”æ¡ˆ
    let questionStatusMap = {}; // è®°å½•æ¯ä¸€é¢˜çš„å¯¹é”™çŠ¶æ€ { index: 'correct'|'wrong' }
    let isChallengeMode = false; // æ˜¯å¦ä¸ºæŒ‘æˆ˜æ¨¡å¼
    let challengeRecord = null; // å½“å‰æŒ‘æˆ˜è®°å½•

    let backgroundList = [];
    let currentBackground = null;
    let backgroundPage = 1;
    let backgroundPageSize = 5;
    let backgroundHasMore = false;
    let backgroundTotal = 0;
    let backgroundLoading = false;
    let userId = localStorage.getItem('system_user_id') || ('user_' + Math.random().toString(36).substr(2, 9));
    localStorage.setItem('system_user_id', userId);

    // é”®ç›˜å¿«æ·é”®é…ç½®
    let keyboardSettings = {
        optionA: 'Digit1',
        optionB: 'Digit2',
        optionC: 'Digit3',
        optionD: 'Digit4',
        submit: 'Enter',
        next: 'ArrowRight',
        prev: 'ArrowLeft',
        addWrong: 'KeyW'
    };
    
    // é”®åæ˜ å°„ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
    const keyNameMap = {
        'KeyA': 'A', 'KeyB': 'B', 'KeyC': 'C', 'KeyD': 'D',
        'KeyW': 'W', 'KeyE': 'E', 'KeyR': 'R', 'KeyT': 'T',
        'KeyY': 'Y', 'KeyU': 'U', 'KeyI': 'I', 'KeyO': 'O',
        'KeyP': 'P', 'KeyS': 'S', 'KeyF': 'F', 'KeyG': 'G',
        'KeyH': 'H', 'KeyJ': 'J', 'KeyK': 'K', 'KeyL': 'L',
        'KeyZ': 'Z', 'KeyX': 'X', 'KeyV': 'V', 'KeyN': 'N',
        'KeyM': 'M', 'Digit1': '1', 'Digit2': '2', 'Digit3': '3',
        'Digit4': '4', 'Digit5': '5', 'Digit6': '6', 'Digit7': '7',
        'Digit8': '8', 'Digit9': '9', 'Digit0': '0',
        'Enter': 'Enter', 'Space': 'Space',
        'ArrowLeft': 'â†', 'ArrowRight': 'â†’', 'ArrowUp': 'â†‘', 'ArrowDown': 'â†“',
        'Tab': 'Tab', 'CapsLock': 'Caps', 'ControlLeft': 'Ctrl', 'AltLeft': 'Alt',
        'Escape': 'Esc'
    };
    
    // åŠ è½½é”®ç›˜è®¾ç½®
    function loadKeyboardSettings() {
        const saved = localStorage.getItem('keyboard_settings');
        if (saved) {
            try {
                keyboardSettings = { ...keyboardSettings, ...JSON.parse(saved) };
            } catch (e) {
                console.error('åŠ è½½é”®ç›˜è®¾ç½®å¤±è´¥:', e);
            }
        }
        updateKeyboardHints();
    }
    
    // ä¿å­˜é”®ç›˜è®¾ç½®
    function saveKeyboardSettings() {
        localStorage.setItem('keyboard_settings', JSON.stringify(keyboardSettings));
        updateKeyboardHints();
        closeKeyboardSettings();
        showToast('å¿«æ·é”®è®¾ç½®å·²ä¿å­˜');
    }
    
    // æ¢å¤é»˜è®¤è®¾ç½®
    function resetKeyboardSettings() {
        keyboardSettings = {
            optionA: 'Digit1',
            optionB: 'Digit2',
            optionC: 'Digit3',
            optionD: 'Digit4',
            submit: 'Enter',
            next: 'ArrowRight',
            prev: 'ArrowLeft',
            addWrong: 'KeyW'
        };
        renderKeyboardSettings();
        showToast('å·²æ¢å¤é»˜è®¤è®¾ç½®');
    }
    
    // æ›´æ–°å¿«æ·é”®æç¤º
    function updateKeyboardHints() {
        const hints = document.getElementById('keyboard-hints');
        if (!hints) return;
        
        document.getElementById('hint-option-a').textContent = keyNameMap[keyboardSettings.optionA] || keyboardSettings.optionA;
        document.getElementById('hint-option-b').textContent = keyNameMap[keyboardSettings.optionB] || keyboardSettings.optionB;
        document.getElementById('hint-option-c').textContent = keyNameMap[keyboardSettings.optionC] || keyboardSettings.optionC;
        document.getElementById('hint-option-d').textContent = keyNameMap[keyboardSettings.optionD] || keyboardSettings.optionD;
        document.getElementById('hint-submit').textContent = keyNameMap[keyboardSettings.submit] || keyboardSettings.submit;
        document.getElementById('hint-next').textContent = keyNameMap[keyboardSettings.next] || keyboardSettings.next;
        const hintPrev = document.getElementById('hint-prev');
        if (hintPrev) {
            hintPrev.textContent = keyNameMap[keyboardSettings.prev] || keyboardSettings.prev;
        }
        document.getElementById('hint-add-wrong').textContent = keyNameMap[keyboardSettings.addWrong] || keyboardSettings.addWrong;
    }
    
    // æ‰“å¼€å¿«æ·é”®è®¾ç½®
    function openKeyboardSettings() {
        const modal = document.getElementById('keyboard-settings-modal');
        if (modal) {
            modal.classList.add('open');
            renderKeyboardSettings();
        }
    }
    
    // å…³é—­å¿«æ·é”®è®¾ç½®
    function closeKeyboardSettings(event) {
        if (event && event.target !== event.currentTarget) return;
        const modal = document.getElementById('keyboard-settings-modal');
        if (modal) {
            modal.classList.remove('open');
            currentSettingKey = null;
        }
    }
    
    // å½“å‰é€‰ä¸­çš„è®¾ç½®é¡¹
    let currentSettingKey = null;
    
    // æ¸²æŸ“å¿«æ·é”®è®¾ç½®ç•Œé¢
    function renderKeyboardSettings() {
        const list = document.getElementById('keyboard-settings-list');
        const simulator = document.getElementById('keyboard-simulator');
        if (!list || !simulator) return;
        
        const settings = [
            { key: 'optionA', label: 'é€‰é¡¹A/å¯¹' },
            { key: 'optionB', label: 'é€‰é¡¹B/é”™' },
            { key: 'optionC', label: 'é€‰é¡¹C' },
            { key: 'optionD', label: 'é€‰é¡¹D' },
            { key: 'submit', label: 'æäº¤ç­”æ¡ˆ' },
            { key: 'next', label: 'ä¸‹ä¸€é¢˜' },
            { key: 'prev', label: 'ä¸Šä¸€é¢˜' },
            { key: 'addWrong', label: 'åŠ å…¥é”™é¢˜æœ¬' }
        ];
        
        // æ¸²æŸ“åŠŸèƒ½åˆ—è¡¨
        list.innerHTML = settings.map(setting => {
            const currentKey = keyboardSettings[setting.key];
            const displayName = keyNameMap[currentKey] || currentKey;
            return `
                <div class="keyboard-setting-item ${currentSettingKey === setting.key ? 'active' : ''}" 
                     onclick="selectSetting('${setting.key}')">
                    <span class="label">${setting.label}</span>
                    <span class="key-display">${displayName}</span>
                </div>
            `;
        }).join('');
        
        // æ¸²æŸ“é”®ç›˜æ¨¡æ‹Ÿå™¨
        renderKeyboardSimulator();
    }
    
    // é€‰æ‹©è®¾ç½®é¡¹
    window.selectSetting = function(settingKey) {
        currentSettingKey = settingKey;
        renderKeyboardSettings();
    }
    
    // æ¸²æŸ“é”®ç›˜æ¨¡æ‹Ÿå™¨
    function renderKeyboardSimulator() {
        const simulator = document.getElementById('keyboard-simulator');
        if (!simulator) return;
        
        // ç¬”è®°æœ¬é”®ç›˜å¸ƒå±€ï¼ˆæ›´çœŸå®çš„å¸ƒå±€ï¼‰
        const keyboardLayout = [
            // æ•°å­—è¡Œ
            { keys: ['Digit1', 'Digit2', 'Digit3', 'Digit4', 'Digit5', 'Digit6', 'Digit7', 'Digit8', 'Digit9', 'Digit0'], offset: 0 },
            // QWERTYè¡Œ
            { keys: ['KeyQ', 'KeyW', 'KeyE', 'KeyR', 'KeyT', 'KeyY', 'KeyU', 'KeyI', 'KeyO', 'KeyP'], offset: 0 },
            // ASDFè¡Œï¼ˆTabé”®åç§»ï¼‰
            { keys: ['Tab', 'KeyA', 'KeyS', 'KeyD', 'KeyF', 'KeyG', 'KeyH', 'KeyJ', 'KeyK', 'KeyL'], offset: 1 },
            // ZXCVè¡Œï¼ˆCaps Lockå’ŒShiftåç§»ï¼‰
            { keys: ['CapsLock', 'KeyZ', 'KeyX', 'KeyC', 'KeyV', 'KeyB', 'KeyN', 'KeyM'], offset: 1.5 },
            // åŠŸèƒ½é”®è¡Œï¼ˆCtrlã€Altã€Spaceç­‰ï¼‰
            { keys: ['ControlLeft', 'AltLeft', 'Space', 'AltRight', 'ControlRight'], offset: 0 },
            // æ–¹å‘é”®å’ŒEnter
            { keys: ['ArrowLeft', 'ArrowUp', 'ArrowDown', 'ArrowRight', 'Enter'], offset: 0 }
        ];
        
        // è·å–æ‰€æœ‰å·²åˆ†é…çš„æŒ‰é”®
        const assignedKeys = Object.values(keyboardSettings);
        
        simulator.innerHTML = keyboardLayout.map((row, rowIndex) => {
            const offsetStyle = row.offset > 0 ? `margin-left: ${row.offset * 50}px;` : '';
            return `
                <div class="keyboard-row" style="${offsetStyle}">
                    ${row.keys.map(keyCode => {
                        // å¤„ç†ç‰¹æ®Šé”®åæ˜ å°„åˆ°å®é™…çš„keyCode
                        let actualKeyCode = keyCode;
                        let displayName = keyNameMap[keyCode] || keyCode;
                        
                        // æ˜ å°„åˆ°æµè§ˆå™¨å®é™…ä½¿ç”¨çš„keyCode
                        if (keyCode === 'Tab') {
                            actualKeyCode = 'Tab';
                            displayName = 'Tab';
                        } else if (keyCode === 'CapsLock') {
                            actualKeyCode = 'CapsLock';
                            displayName = 'Caps';
                        } else if (keyCode === 'ControlLeft' || keyCode === 'ControlRight') {
                            actualKeyCode = 'ControlLeft'; // ç»Ÿä¸€ä½¿ç”¨ControlLeft
                            displayName = 'Ctrl';
                        } else if (keyCode === 'AltLeft' || keyCode === 'AltRight') {
                            actualKeyCode = 'AltLeft'; // ç»Ÿä¸€ä½¿ç”¨AltLeft
                            displayName = 'Alt';
                        } else {
                            displayName = keyNameMap[keyCode] || keyCode;
                        }
                        
                        const isAssigned = assignedKeys.includes(actualKeyCode);
                        const isCurrent = currentSettingKey && keyboardSettings[currentSettingKey] === actualKeyCode;
                        
                        let keyClass = 'keyboard-key';
                        if (isCurrent) keyClass += ' active';
                        if (isAssigned && !isCurrent) keyClass += ' assigned';
                        if (keyCode === 'Space') keyClass += ' space';
                        if (keyCode === 'Enter' || keyCode === 'Tab' || keyCode === 'CapsLock' || 
                            keyCode === 'ControlLeft' || keyCode === 'ControlRight' || 
                            keyCode === 'AltLeft' || keyCode === 'AltRight') {
                            keyClass += ' wide';
                        }
                        
                        return `<div class="${keyClass}" data-keycode="${actualKeyCode}" onclick="setKeyboardKey('${actualKeyCode}')">${displayName}</div>`;
                    }).join('')}
                </div>
            `;
        }).join('');
    }
    
    // è®¾ç½®é”®ç›˜æŒ‰é”®
    window.setKeyboardKey = function(keyCode) {
        if (!currentSettingKey) {
            showToast('è¯·å…ˆé€‰æ‹©è¦è®¾ç½®çš„åŠŸèƒ½');
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–å¿«æ·é”®å†²çª
        let hasConflict = false;
        let conflictKey = null;
        for (const [key, value] of Object.entries(keyboardSettings)) {
            if (key !== currentSettingKey && value === keyCode) {
                hasConflict = true;
                conflictKey = key;
                break;
            }
        }
        
        if (hasConflict) {
            const conflictLabel = {
                'optionA': 'é€‰é¡¹1',
                'optionB': 'é€‰é¡¹2',
                'optionC': 'é€‰é¡¹3',
                'optionD': 'é€‰é¡¹4',
                'submit': 'æäº¤ç­”æ¡ˆ',
                'next': 'ä¸‹ä¸€é¢˜',
                'addWrong': 'åŠ å…¥é”™é¢˜æœ¬'
            };
            showToast(`è¯¥æŒ‰é”®å·²è¢« "${conflictLabel[conflictKey]}" ä½¿ç”¨`, 3000);
            return;
        }
        
        // è®¾ç½®å¿«æ·é”®
        keyboardSettings[currentSettingKey] = keyCode;
        renderKeyboardSettings();
        showToast('å¿«æ·é”®å·²è®¾ç½®', 2000);
    }
    
    
    // è·å–è®¾ç½®æ ‡ç­¾
    function getSettingLabel(key) {
        const map = {
            'optionA': 'é€‰é¡¹1',
            'optionB': 'é€‰é¡¹2',
            'optionC': 'é€‰é¡¹3',
            'optionD': 'é€‰é¡¹4',
            'submit': 'æäº¤ç­”æ¡ˆ',
            'next': 'ä¸‹ä¸€é¢˜',
            'prev': 'ä¸Šä¸€é¢˜',
            'addWrong': 'åŠ å…¥é”™é¢˜æœ¬'
        };
        return map[key] || key;
    }
    
    // é”®ç›˜äº‹ä»¶å¤„ç†
    function handleKeyboardEvent(e) {
        // å¦‚æœæ­£åœ¨è¾“å…¥æ–‡æœ¬ï¼Œä¸å¤„ç†å¿«æ·é”®
        const activeElement = document.activeElement;
        if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
            // å¦‚æœæ˜¯æ–‡æœ¬è¾“å…¥æ¡†ï¼Œåªå¤„ç†éå­—ç¬¦é”®
            if (activeElement.type === 'text' || activeElement.tagName === 'TEXTAREA') {
                // å…è®¸å¤„ç†æ–¹å‘é”®å’ŒEnteré”®
                if (e.code !== 'ArrowRight' && e.code !== 'ArrowLeft' && e.code !== 'Enter') {
                    return;
                }
            }
        }
        
        const code = e.code;
        
        // é€‰æ‹©é€‰é¡¹
        if (code === keyboardSettings.optionA || code === keyboardSettings.optionB || 
            code === keyboardSettings.optionC || code === keyboardSettings.optionD) {
            if (currentStep !== 'answering') return;
            
            // æ£€æŸ¥å½“å‰é¢˜ç›®ç±»å‹
            const q = currentQuestions[currentIndex];
            const isJudgement = q && (q.type === 'åˆ¤æ–­é¢˜' || q.answer === 'æ­£ç¡®' || q.answer === 'é”™è¯¯' || 
                q.answer === 'å¯¹' || q.answer === 'é”™' || q.answer === 'æ˜¯' || q.answer === 'å¦');
            
            if (isJudgement) {
                // åˆ¤æ–­é¢˜ï¼š1=æ­£ç¡®ï¼Œ2=é”™è¯¯
                e.preventDefault();
                if (code === keyboardSettings.optionA) {
                    selectJudgementOption('æ­£ç¡®');
                } else if (code === keyboardSettings.optionB) {
                    selectJudgementOption('é”™è¯¯');
                }
            } else {
                // é€‰æ‹©é¢˜ï¼š1=A, 2=B, 3=C, 4=D
                const optionMap = {
                    [keyboardSettings.optionA]: 'A',
                    [keyboardSettings.optionB]: 'B',
                    [keyboardSettings.optionC]: 'C',
                    [keyboardSettings.optionD]: 'D'
                };
                
                const selectedOption = optionMap[code];
                if (selectedOption) {
                    e.preventDefault();
                    selectOptionByKey(selectedOption);
                }
            }
            return;
        }
        
        // æäº¤
        if (code === keyboardSettings.submit) {
            e.preventDefault();
            const btn = document.getElementById('btn-action');
            if (btn && btn.textContent === 'æäº¤æœ¬é¢˜') {
                handleAction();
            }
            return;
        }
        
        // ä¸‹ä¸€é¢˜
        if (code === keyboardSettings.next) {
            e.preventDefault();
            const btn = document.getElementById('btn-action');
            if (btn && (btn.textContent === 'ä¸‹ä¸€é¢˜' || btn.textContent === 'æŸ¥çœ‹ç»“æœ')) {
                handleAction();
            }
            return;
        }
        
        // ä¸Šä¸€é¢˜
        if (code === keyboardSettings.prev) {
            e.preventDefault();
            const prevBtn = document.getElementById('btn-prev');
            if (prevBtn && prevBtn.style.display !== 'none') {
                goToPreviousQuestion();
            }
            return;
        }
        
        // åŠ å…¥é”™é¢˜æœ¬
        if (code === keyboardSettings.addWrong) {
            e.preventDefault();
            const btn = document.getElementById('btn-add-wrong');
            if (btn && btn.style.display !== 'none') {
                addToWrongBook();
            }
            return;
        }
    }
    
    // é€šè¿‡æŒ‰é”®é€‰æ‹©é€‰é¡¹
    function selectOptionByKey(optionLabel) {
        const inputs = document.querySelectorAll('input[name="q"]');
        if (inputs.length === 0) return;
        
        const targetInput = Array.from(inputs).find(input => {
            const label = input.parentElement;
            const labelText = label.querySelector('strong');
            if (labelText) {
                return labelText.textContent.trim().replace('.', '') === optionLabel;
            }
            return false;
        });
        
        if (targetInput) {
            const label = targetInput.parentElement;
            const type = targetInput.type;
            selectOption(label, type);
        }
    }
    
    // é€šè¿‡æŒ‰é”®é€‰æ‹©åˆ¤æ–­é¢˜é€‰é¡¹
    function selectJudgementOption(value) {
        const inputs = document.querySelectorAll('input[name="q"]');
        if (inputs.length === 0) return;
        
        const targetInput = Array.from(inputs).find(input => input.value === value);
        
        if (targetInput) {
            const label = targetInput.parentElement;
            selectOption(label, 'radio');
        }
    }

    window.onload = () => {
        loadExamList();
        loadChallengeHistory(); // åŠ è½½å†å²è®°å½•
        initBackground(); // åˆå§‹åŒ–èƒŒæ™¯
        loadBackgroundList(); // åŠ è½½èƒŒæ™¯åˆ—è¡¨
        startHeartbeat(); // å¯åŠ¨å¿ƒè·³
        loadKeyboardSettings(); // åŠ è½½é”®ç›˜è®¾ç½®
        document.addEventListener('keydown', handleKeyboardEvent); // æ·»åŠ é”®ç›˜ç›‘å¬
        setTimeout(() => {
            if (typeof onUploadModeChange === 'function') onUploadModeChange();
        }, 0);
    };

    function startHeartbeat() {
        // ç«‹å³å‘é€ä¸€æ¬¡å¿ƒè·³
        sendHeartbeat();
        // æ¯ 5 ç§’å‘é€ä¸€æ¬¡
        setInterval(sendHeartbeat, 5000);
    }

    async function sendHeartbeat() {
        try {
            await fetch('/api/heartbeat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId })
            });
        } catch (e) {
            console.error('å¿ƒè·³åŒæ­¥å¤±è´¥:', e);
        }
    }

    let dashboardTimer = null;
    
    // ç”¨æˆ·æœ¬åœ°ç´¯è®¡æ—¶é•¿
    let userUsageSeconds = parseInt(localStorage.getItem('user_usage_seconds') || '0');
    // ç³»ç»Ÿç´¯è®¡è¿è¡Œæ—¶é•¿
    let systemTotalSeconds = 0;
    
    setInterval(() => {
        userUsageSeconds++;
        localStorage.setItem('user_usage_seconds', userUsageSeconds);
        
        systemTotalSeconds++;
        
        const timeEl = document.getElementById('stat-total-time');
        const systemTimeEl = document.getElementById('stat-system-uptime');
        const dashboard = document.getElementById('view-dashboard');
        
        if (dashboard && !dashboard.classList.contains('hidden')) {
            if (timeEl) timeEl.innerText = formatSeconds(userUsageSeconds);
            if (systemTimeEl) systemTimeEl.innerText = formatSeconds(systemTotalSeconds);
        }
    }, 1000);

    // å›¾è¡¨å®ä¾‹å˜é‡
    let memChart = null;
    let storageChart = null;
    let subjectChart = null;

    async function openDashboard() {
        if (typeof Chart === 'undefined') {
            alert('ç»Ÿè®¡å›¾è¡¨åº“åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•...');
            return;
        }
        toggleView('dashboard');
        initCharts(); // åˆå§‹åŒ–å›¾è¡¨
        await updateDashboardData();
        // é¡µé¢æ‰“å¼€æ—¶ï¼Œæ¯ 5 ç§’åŒæ­¥ä¸€æ¬¡æœåŠ¡ç«¯çœŸå®æ•°æ®
        if (dashboardTimer) clearInterval(dashboardTimer);
        dashboardTimer = setInterval(updateDashboardData, 5000);
        
        // ç«‹å³åˆ·æ–°ä¸€æ¬¡æ—¶é—´æ˜¾ç¤º
        const timeEl = document.getElementById('stat-total-time');
        if (timeEl) timeEl.innerText = formatSeconds(userUsageSeconds);
    }

    function initCharts() {
        const commonOptions = {
            cutout: '75%',
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 800,
                easing: 'easeOutQuart'
            },
            plugins: { 
                legend: { display: false }, 
                tooltip: { enabled: true } 
            }
        };

        if (!memChart) {
            const ctx = document.getElementById('memChart');
            if (!ctx) return;
            memChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#10b981', '#f3f4f6'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: commonOptions
            });
        }

        if (!storageChart) {
            const ctx = document.getElementById('storageChart');
            if (!ctx) return;
            storageChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#3b82f6', '#f3f4f6'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: commonOptions
            });
        }

        if (!subjectChart) {
            const ctx = document.getElementById('subjectChart');
            if (!ctx) return;
            subjectChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'é¢˜ç›®æ•°é‡',
                        data: [],
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000
                    },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#1f2937',
                            bodyColor: '#4b5563',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            padding: 10
                        }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true,
                            grid: { display: false }, 
                            ticks: { color: '#9ca3af', font: { size: 10 } }, 
                            border: { display: false } 
                        },
                        y: { 
                            grid: { display: false }, 
                            ticks: { color: '#4b5563', font: { weight: '600' } },
                            border: { display: false } 
                        }
                    }
                }
            });
        }
    }

    async function updateDashboardData() {
        const statusEl = document.getElementById('stat-server-status');
        const regionEl = document.getElementById('stat-server-region');
        
        try {
            const res = await fetch('/api/stats');
            if (!res.ok) throw new Error('ç½‘ç»œå¼‚å¸¸');
            const data = await res.json();
            
            let startTime = parseInt(data.totalUsageSeconds);
            
            let uptimeSeconds = 0;
            if (startTime > 0) {
                 uptimeSeconds = Math.floor((Date.now() - startTime) / 1000);
            }
            if (uptimeSeconds < 0) uptimeSeconds = 0;  
            
            systemTotalSeconds = uptimeSeconds;
            
            // æ›´æ–° UI
            const timeEl = document.getElementById('stat-total-time');
            const systemTimeEl = document.getElementById('stat-system-uptime');
            const questionsEl = document.getElementById('stat-total-questions');
            const onlineEl = document.getElementById('stat-online-users');
            
            if (systemTimeEl) systemTimeEl.innerText = formatSeconds(systemTotalSeconds);
            if (questionsEl) questionsEl.innerText = data.totalQuestions;
            if (onlineEl) onlineEl.innerText = data.onlineUsers;
            
            if (statusEl) {
                statusEl.innerText = 'åœ¨çº¿è¿è¡Œ';
                statusEl.className = 'meta-value status-online';
            }

            // æ›´æ–°æ— ç§å¥‰çŒ®æ¦œ
            if (data.topUploader) {
                const uploaderNameEl = document.getElementById('stat-top-uploader-name');
                const uploaderCountEl = document.getElementById('stat-top-uploader-count');
                if (uploaderNameEl) uploaderNameEl.innerText = data.topUploader.uploader_name;
                if (uploaderCountEl) uploaderCountEl.innerText = data.topUploader.exam_count;
            }

            // æ›´æ–°æœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯
            if (data.serverInfo) {
                if (regionEl) regionEl.innerText = data.serverInfo.region;
                
                // æ›´æ–°å›¾è¡¨å’Œæ–‡å­—
                if (memChart) {
                    const usage = parseFloat(data.serverInfo.memory.usage);
                    memChart.data.datasets[0].data = [usage, 100 - usage];
                    memChart.update();
                    const memInfoEl = document.getElementById('stat-mem-info');
                    if (memInfoEl) memInfoEl.innerText = `${(data.serverInfo.memory.total * usage / 100).toFixed(1)} / ${data.serverInfo.memory.total} GB`;
                    const memPctEl = document.getElementById('mem-usage-pct');
                    if (memPctEl) memPctEl.innerText = `${usage}%`;
                }

                if (storageChart) {
                    const usage = parseFloat(data.serverInfo.storage.usage);
                    storageChart.data.datasets[0].data = [usage, 100 - usage];
                    storageChart.update();
                    const storageInfoEl = document.getElementById('stat-storage-info');
                    if (storageInfoEl) storageInfoEl.innerText = `${data.serverInfo.storage.free} GB`;
                    const storagePctEl = document.getElementById('storage-usage-pct');
                    if (storagePctEl) storagePctEl.innerText = `${usage}%`;
                }
            }

            // æ›´æ–°ç§‘ç›®åˆ†å¸ƒå›¾è¡¨
            if (subjectChart && examList && examList.length > 0) {
                const sortedExams = [...examList].sort((a, b) => b.question_count - a.question_count).slice(0, 5);
                const newLabels = sortedExams.map(e => e.subject_name.length > 8 ? e.subject_name.substring(0, 8) + '...' : e.subject_name);
                const newData = sortedExams.map(e => e.question_count);
                
                const currentData = JSON.stringify(subjectChart.data.datasets[0].data);
                if (currentData !== JSON.stringify(newData)) {
                    subjectChart.data.labels = newLabels;
                    subjectChart.data.datasets[0].data = newData;
                    subjectChart.update();
                }
            }

        } catch (e) {
            console.error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:', e);
            if (statusEl) {
                statusEl.innerText = 'è¿æ¥å¼‚å¸¸';
                statusEl.className = 'meta-value';
                statusEl.style.color = '#ef4444';
            }
        }
    }

    function formatSeconds(s) {
        const days = Math.floor(s / (24 * 3600));
        const hours = Math.floor((s % (24 * 3600)) / 3600);
        const minutes = Math.floor((s % 3600) / 60);
        const secs = Math.floor(s % 60);
        
        const d = String(days).padStart(2, '0');
        const h = String(hours).padStart(2, '0');
        const m = String(minutes).padStart(2, '0');
        const sc = String(secs).padStart(2, '0');
        
        return `${d}:${h}:${m}:${sc}`;
    }

    function initBackground() {
        const savedBg = localStorage.getItem('selected_background');
        if (savedBg) {
            currentBackground = savedBg;
        } else {
            currentBackground = 'Nahida.png';
            localStorage.setItem('selected_background', currentBackground);
        }
        applyBackground(currentBackground);
    }

    function applyBackground(bgName) {
        const body = document.body;
        const previewImg = document.getElementById('background-preview');
        const previewPlaceholder = document.getElementById('background-preview-placeholder');
        
        if (bgName === 'default' || !bgName) {
            body.classList.remove('has-background');
            const existingStyle = document.getElementById('dynamic-background-style');
            if (existingStyle) existingStyle.remove();
            if (previewImg) previewImg.style.display = 'none';
            if (previewPlaceholder) previewPlaceholder.style.display = 'flex';
        } else {
            const bgUrl = `/uploads/${bgName}`;
            body.classList.add('has-background');
            
            const style = document.createElement('style');
            style.id = 'dynamic-background-style';
            const existingStyle = document.getElementById('dynamic-background-style');
            if (existingStyle) existingStyle.remove();
            style.textContent = `body.has-background::before { background-image: url(${bgUrl}); }`;
            document.head.appendChild(style);
            
            if (previewImg) {
                previewImg.src = bgUrl;
                previewImg.style.display = 'block';
            }
            if (previewPlaceholder) previewPlaceholder.style.display = 'none';
        }
        
        currentBackground = bgName;
    }

    async function loadBackgroundList(reset = false) {
        if (backgroundLoading) return;
        
        if (reset) {
            backgroundPage = 1;
            backgroundList = [];
        }
        
        try {
            backgroundLoading = true;
            const loadMoreContainer = document.getElementById('background-load-more-container');
            const loadMoreBtn = document.getElementById('background-load-more-btn');
            const loadingDiv = document.getElementById('background-loading');
            
            if (loadMoreBtn) loadMoreBtn.style.display = 'none';
            if (loadingDiv) loadingDiv.style.display = 'block';
            
            console.log(`å¼€å§‹åŠ è½½èƒŒæ™¯åˆ—è¡¨ç¬¬ ${backgroundPage} é¡µ...`);
            const res = await fetch(`/api/backgrounds?page=${backgroundPage}&pageSize=${backgroundPageSize}`);
            const result = await res.json();
            console.log('èƒŒæ™¯åˆ—è¡¨APIè¿”å›:', result);
            
            const newBackgrounds = result.data || [];
            if (reset) {
                backgroundList = newBackgrounds;
            } else {
                backgroundList = backgroundList.concat(newBackgrounds);
            }
            
            backgroundTotal = result.total || 0;
            backgroundHasMore = result.hasMore || false;
            
            console.log(`è§£æåçš„èƒŒæ™¯åˆ—è¡¨: å…± ${backgroundTotal} ä¸ªï¼Œå·²åŠ è½½ ${backgroundList.length} ä¸ªï¼Œè¿˜æœ‰æ›´å¤š: ${backgroundHasMore}`);
            
            renderBackgroundList();
            
            // æ˜¾ç¤º/éšè—åŠ è½½æ›´å¤šæŒ‰é’®
            if (loadMoreContainer) {
                if (backgroundHasMore) {
                    loadMoreContainer.style.display = 'block';
                    if (loadMoreBtn) loadMoreBtn.style.display = 'inline-block';
                } else {
                    loadMoreContainer.style.display = 'none';
                }
            }
            
            if (loadingDiv) loadingDiv.style.display = 'none';
        } catch (e) {
            console.error('åŠ è½½èƒŒæ™¯åˆ—è¡¨å¤±è´¥:', e);
            const loadingDiv = document.getElementById('background-loading');
            if (loadingDiv) {
                loadingDiv.textContent = 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•';
                loadingDiv.style.display = 'block';
            }
        } finally {
            backgroundLoading = false;
        }
    }
    
    async function loadMoreBackgrounds() {
        if (backgroundHasMore && !backgroundLoading) {
            backgroundPage++;
            await loadBackgroundList(false);
        }
    }

    function renderBackgroundList() {
        const container = document.getElementById('background-list');
        if (!container) {
            console.warn('èƒŒæ™¯åˆ—è¡¨å®¹å™¨ä¸å­˜åœ¨');
            return;
        }
        
        console.log('æ¸²æŸ“èƒŒæ™¯åˆ—è¡¨ï¼Œå½“å‰èƒŒæ™¯:', currentBackground);
        console.log('å¯ç”¨èƒŒæ™¯æ•°é‡:', backgroundList.length);
        
        const defaultHtml = `
            <div class="background-item ${currentBackground === 'default' ? 'selected' : ''}" data-bg="default" onclick="selectBackground('default')">
                <div style="width: 100%; height: 100%; background: var(--bg-color); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-weight: 600;">
                    é»˜è®¤
                </div>
                <div class="background-item-label">é»˜è®¤ï¼ˆæ— èƒŒæ™¯ï¼‰</div>
            </div>
        `;
        
        const backgroundsHtml = backgroundList.map(bg => {
            const isSelected = currentBackground === bg.name;
            return `
                <div class="background-item ${isSelected ? 'selected' : ''}" data-bg="${bg.name}" onclick="selectBackground('${bg.name}')">
                    <img data-src="${bg.url}" alt="${bg.name}" class="lazy-background-img" onerror="console.error('èƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥:', '${bg.url}'); this.parentElement.style.display='none'">
                    <div class="background-item-label">${bg.name}</div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = defaultHtml + backgroundsHtml;
        
        // åˆå§‹åŒ–æ‡’åŠ è½½è§‚å¯Ÿå™¨
        initLazyLoadImages();
        
        console.log('èƒŒæ™¯åˆ—è¡¨æ¸²æŸ“å®Œæˆ');
    }
    
    // å›¾ç‰‡æ‡’åŠ è½½å‡½æ•°
    function initLazyLoadImages() {
        const lazyImages = document.querySelectorAll('.lazy-background-img[data-src]');
        
        if ('IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy-background-img');
                        img.removeAttribute('data-src');
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px' // æå‰50pxå¼€å§‹åŠ è½½
            });
            
            lazyImages.forEach(img => imageObserver.observe(img));
        } else {
            // ä¸æ”¯æŒ IntersectionObserver çš„æµè§ˆå™¨ï¼Œç›´æ¥åŠ è½½æ‰€æœ‰å›¾ç‰‡
            lazyImages.forEach(img => {
                img.src = img.dataset.src;
                img.classList.remove('lazy-background-img');
                img.removeAttribute('data-src');
            });
        }
    }

    function selectBackground(bgName) {
        applyBackground(bgName);
        localStorage.setItem('selected_background', bgName);
        renderBackgroundList(); // æ›´æ–°é€‰ä¸­çŠ¶æ€
    }

    function openBackgroundSettings() {
        const modal = document.getElementById('background-settings-modal');
        if (modal) {
            modal.classList.add('open');
            loadBackgroundList(true); // é‡ç½®å¹¶åˆ·æ–°èƒŒæ™¯åˆ—è¡¨
            if (currentBackground && currentBackground !== 'default') {
                const previewImg = document.getElementById('background-preview');
                const previewPlaceholder = document.getElementById('background-preview-placeholder');
                if (previewImg) {
                    previewImg.src = `/uploads/${currentBackground}`;
                    previewImg.style.display = 'block';
                }
                if (previewPlaceholder) previewPlaceholder.style.display = 'none';
            } else {
                const previewImg = document.getElementById('background-preview');
                const previewPlaceholder = document.getElementById('background-preview-placeholder');
                if (previewImg) previewImg.style.display = 'none';
                if (previewPlaceholder) previewPlaceholder.style.display = 'flex';
            }
        }
    }

    function closeBackgroundSettings() {
        const modal = document.getElementById('background-settings-modal');
        if (modal) {
            modal.classList.remove('open');
        }
    }

    async function handleBackgroundUpload() {
        const fileInput = document.getElementById('background-file-input');
        const nameInput = document.getElementById('background-name-input');
        
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
            alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
            return;
        }
        
        const file = fileInput.files[0];
        const customName = nameInput.value.trim();
        
        if (!file.type.startsWith('image/')) {
            alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
            return;
        }
        
        try {
            const formData = new FormData();
            formData.append('background', file);
            if (customName) {
                formData.append('name', customName);
            }
            
            const res = await fetch('/api/upload/background', {
                method: 'POST',
                body: formData
            });
            
            const result = await res.json();
            
            if (res.ok && result.success) {
                alert('ä¸Šä¼ æˆåŠŸï¼');
                selectBackground(result.filename);
                await loadBackgroundList(true);
                fileInput.value = '';
                nameInput.value = '';
            } else {
                alert('ä¸Šä¼ å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (e) {
            alert('ä¸Šä¼ å¤±è´¥: ' + e.message);
        }
    }

    function toggleChallengeSidebar(show) {
        const sidebar = document.getElementById('challenge-sidebar');
        const overlay = document.getElementById('challenge-overlay');
        if (show) {
            sidebar.classList.add('open');
            overlay.classList.add('open');
            renderChallengeHistory();
        } else {
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
        }
    }

    async function openChallengeConfig() {
        toggleView('challenge');
        const container = document.getElementById('challenge-exam-list');
        
        // å¦‚æœé¢˜åº“åˆ—è¡¨ä¸ºç©ºï¼Œå…ˆåŠ è½½
        if (examList.length === 0) {
            container.innerHTML = '<div style="padding:20px; color:#a0aec0; text-align:center;">æ­£åœ¨åŠ è½½é¢˜åº“...</div>';
            await loadExamList();
        }
        
        // å†æ¬¡æ£€æŸ¥ï¼ˆé˜²æ­¢åŠ è½½åä»ä¸ºç©ºï¼‰
        if (examList.length === 0) {
            container.innerHTML = '<div style="padding:20px; color:#a0aec0; text-align:center;">æš‚æ— é¢˜åº“å¯ç”¨ï¼Œè¯·å…ˆä¸Šä¼ é¢˜ç›®</div>';
            return;
        }
        
        container.innerHTML = examList.map(exam => `
            <div class="select-item" onclick="this.querySelector('input').click()">
                <input type="checkbox" value="${exam.id}" data-name="${escapeHTML(exam.subject_name)}" onclick="event.stopPropagation()">
                <span>${escapeHTML(exam.subject_name)} (${exam.question_count}é¢˜)</span>
            </div>
        `).join('');
    }

    async function startChallenge() {
        const selectedExams = Array.from(document.querySelectorAll('#challenge-exam-list input:checked'));
        if (selectedExams.length === 0) return alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé¢˜åº“');
        
        // è·å–ç”¨æˆ·é€‰æ‹©çš„é¢˜å‹
        const selectedTypes = Array.from(document.querySelectorAll('input[name="challenge-types"]:checked')).map(cb => cb.value);
        if (selectedTypes.length === 0) return alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§é¢˜å‹');
        
        const count = parseInt(document.getElementById('challenge-count').value);
        if (isNaN(count) || count <= 0) return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é¢˜ç›®æ•°é‡');

        try {
            console.log('æ­£åœ¨å‡†å¤‡æŒ‘æˆ˜é¢˜ç›®...');
            let allAvailableQuestions = [];
            
            // é€ä¸ªè·å–æ‰€é€‰é¢˜åº“çš„é¢˜ç›®
            for (const input of selectedExams) {
                const res = await fetch(`/api/questions?exam_id=${input.value}`);
                const result = await res.json();
                allAvailableQuestions = allAvailableQuestions.concat(result.data || []);
            }

            if (allAvailableQuestions.length === 0) return alert('æ‰€é€‰é¢˜åº“ä¸­æ²¡æœ‰é¢˜ç›®');

            // æ ¹æ®é€‰æ‹©çš„é¢˜å‹è¿‡æ»¤é¢˜ç›®
            allAvailableQuestions = allAvailableQuestions.filter(q => {
                const qType = q.type || 'æœªçŸ¥';
                return selectedTypes.includes(qType);
            });

            if (allAvailableQuestions.length === 0) {
                return alert(`æ‰€é€‰é¢˜åº“ä¸­æ²¡æœ‰ ${selectedTypes.join('ã€')} ç±»å‹çš„é¢˜ç›®`);
            }

            // éšæœºæ´—ç‰Œå¹¶æˆªå–
            allAvailableQuestions.sort(() => Math.random() - 0.5);
            currentQuestions = allAvailableQuestions.slice(0, count);
            
            // åˆå§‹åŒ–æŒ‘æˆ˜çŠ¶æ€
            isChallengeMode = true;
            currentIndex = 0;
            score = 0;
            answeredIndices.clear();
            userAnswersMap = {};
            questionStatusMap = {};
            
            // ä¿å­˜æŒ‘æˆ˜é…ç½®ä¿¡æ¯ï¼ˆç”¨äºè®°å½•ï¼‰
            challengeRecord = {
                selectedTypes: selectedTypes,
                subjectNames: selectedExams.map(i => i.dataset.name).join(', ')
            };
            
            // æ›´æ–° UI æ ‡è¯†
            document.getElementById('quiz-mode-tag').style.display = 'block';
            document.getElementById('quiz-subject-title').innerText = `éšæœºæŒ‘æˆ˜ (${currentQuestions.length}é¢˜)`;
            
            toggleView('quiz');
            document.getElementById('progress-container').style.display = 'flex';
            renderNavGrid();
            loadQuestion();
            
        } catch (e) {
            alert('å¼€å¯æŒ‘æˆ˜å¤±è´¥: ' + e.message);
        }
    }

    function saveChallengeResult() {
        if (!isChallengeMode) return;
        
        const history = JSON.parse(localStorage.getItem('challenge_history') || '[]');
        const record = {
            id: Date.now(),
            date: new Date().toISOString(),
            questions: currentQuestions,
            userAnswers: userAnswersMap,
            statusMap: questionStatusMap,
            score: score,
            total: currentQuestions.length,
            subjectNames: challengeRecord?.subjectNames || 'æœªçŸ¥é¢˜åº“',
            selectedTypes: challengeRecord?.selectedTypes || []
        };
        
        history.unshift(record); // æœ€æ–°è®°å½•åœ¨å‰
        localStorage.setItem('challenge_history', JSON.stringify(history.slice(0, 50))); // åªä¿ç•™æœ€è¿‘50æ¡
        loadChallengeHistory();
    }

    function loadChallengeHistory() {
        // é¢„åŠ è½½é€»è¾‘ï¼Œå¯ä»¥ä¸ºç©º
    }

    function renderChallengeHistory() {
        const history = JSON.parse(localStorage.getItem('challenge_history') || '[]');
        const list = document.getElementById('challenge-history-list');
        
        if (history.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:40px; color:#a0aec0;">æš‚æ— è®°å½•</div>';
            return;
        }

        list.innerHTML = history.map(rec => `
            <div class="history-card" onclick="viewHistoryRecord(${rec.id})">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                    <div style="font-weight:700; font-size:0.95rem; color:var(--text-main); flex:1;">${escapeHTML(rec.subjectNames || 'éšæœºæŒ‘æˆ˜')}</div>
                    <div class="history-score">${rec.score}/${rec.total}</div>
                </div>
                ${rec.selectedTypes && rec.selectedTypes.length > 0 ? 
                    `<div style="font-size:0.75rem; color:#718096; margin-bottom:4px;">
                        ${rec.selectedTypes.map(t => escapeHTML(t)).join('ã€')}
                    </div>` : ''}
                <div style="font-size:0.8rem; color:var(--text-secondary);">
                    ${new Date(rec.date).toLocaleString()}
                </div>
            </div>
        `).join('');
    }

    function viewHistoryRecord(id) {
        const history = JSON.parse(localStorage.getItem('challenge_history') || '[]');
        const rec = history.find(r => r.id === id);
        if (!rec) return;

        // åŠ è½½å†å²æ•°æ®
        currentQuestions = rec.questions;
        userAnswersMap = rec.userAnswers;
        questionStatusMap = rec.statusMap;
        score = rec.score;
        isChallengeMode = true; // è®¾ä¸ºæŒ‘æˆ˜æ¨¡å¼ä»¥ä¾¿å›æ˜¾
        answeredIndices = new Set(Object.keys(userAnswersMap).map(k => parseInt(k)));
        
        // æ¢å¤æŒ‘æˆ˜é…ç½®ä¿¡æ¯
        challengeRecord = {
            subjectNames: rec.subjectNames || 'æœªçŸ¥é¢˜åº“',
            selectedTypes: rec.selectedTypes || []
        };
        
        currentIndex = 0;
        
        document.getElementById('quiz-mode-tag').style.display = 'block';
        document.getElementById('quiz-subject-title').innerText = `å†å²å›é¡¾: ${new Date(rec.date).toLocaleDateString()}`;
        
        toggleChallengeSidebar(false);
        toggleView('quiz');
        document.getElementById('progress-container').style.display = 'flex';
        renderNavGrid();
        loadQuestion();
    }

    function exitQuiz() {
        if (isChallengeMode && answeredIndices.size < currentQuestions.length) {
            if (!confirm('æŒ‘æˆ˜å°šæœªå®Œæˆï¼Œé€€å‡ºå°†ä¸ä¼šä¿å­˜è®°å½•ã€‚ç¡®å®šé€€å‡ºå—ï¼Ÿ')) return;
        }
        toggleView('home');
        isChallengeMode = false;
        challengeRecord = null;
        document.getElementById('quiz-mode-tag').style.display = 'none';
    }

    // --- æœ¬åœ°ç¼“å­˜ç›¸å…³ ---
    function getStorageKey() {
        return `quiz_progress_${currentExamId}`;
    }

    function saveProgress() {
        if (!currentExamId) return;
        const data = {
            currentIndex,
            score,
            answeredIndices: Array.from(answeredIndices),
            userAnswersMap,
            questionStatusMap
        };
        localStorage.setItem(getStorageKey(), JSON.stringify(data));
    }

    function loadProgress() {
        if (!currentExamId) return false;
        const raw = localStorage.getItem(getStorageKey());
        if (!raw) return false;
        
        try {
            const data = JSON.parse(raw);
            if (data.currentIndex === undefined) return false;
            
            currentIndex = data.currentIndex;
            score = data.score || 0;
            answeredIndices = new Set(data.answeredIndices || []);
            userAnswersMap = data.userAnswersMap || {};
            questionStatusMap = data.questionStatusMap || {};

            // å…³é”®ä¿®å¤ï¼šé˜²æ­¢ç´¢å¼•è¶Šç•Œ (æ¯”å¦‚ç¼“å­˜äº†ç¬¬10é¢˜ï¼Œä½†æ–°è¯•å·åªæœ‰4é¢˜)
            if (currentIndex >= currentQuestions.length) {
                console.warn('ç¼“å­˜ç´¢å¼•è¶Šç•Œï¼Œé‡ç½®è¿›åº¦');
                currentIndex = 0;
            }

            return true;
        } catch (e) {
            console.error("è¯»å–ç¼“å­˜å¤±è´¥", e);
            return false;
        }
    }

    function clearProgress() {
        if (currentExamId) {
            localStorage.removeItem(getStorageKey());
        }
    }

    function toggleView(viewId) {
        ['view-home', 'view-upload', 'view-quiz', 'view-result', 'view-api', 'view-challenge', 'view-dashboard', 'view-wrongbook'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        });
        document.getElementById('progress-container').style.display = 'none';

        if (viewId !== 'dashboard') {
            if (dashboardTimer) {
                clearInterval(dashboardTimer);
                dashboardTimer = null;
            }
        }

        if(viewId === 'home') {
            document.getElementById('view-home').classList.remove('hidden');
            loadExamList();
        } else if(viewId === 'wrongbook') {
            document.getElementById('view-wrongbook').classList.remove('hidden');
            loadWrongBook();
        } else {
            const el = document.getElementById('view-' + viewId);
            if (el) el.classList.remove('hidden');
        }
    }

    // --- ç”¨æˆ·Tokenç®¡ç† ---
    function getUserToken() {
        let token = localStorage.getItem('user_token');
        if (!token) {
            token = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('user_token', token);
        }
        return token;
    }

    function checkUserRated(examId, userToken) {
        const ratedExams = JSON.parse(localStorage.getItem('rated_exams') || '{}');
        return ratedExams[examId] === userToken;
    }

    function markUserRated(examId, userToken) {
        const ratedExams = JSON.parse(localStorage.getItem('rated_exams') || '{}');
        ratedExams[examId] = userToken;
        localStorage.setItem('rated_exams', JSON.stringify(ratedExams));
    }

    // --- è¯„åˆ†ç›¸å…³å‡½æ•° ---
    function generateStars(rate, hasRated) {
        const fullStars = Math.floor(rate);
        const hasHalf = rate % 1 >= 0.5;
        let html = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= fullStars) {
                html += '<span class="rating-star" data-rating="' + i + '">â˜…</span>';
            } else if (i === fullStars + 1 && hasHalf) {
                html += '<span class="rating-star" data-rating="' + i + '">â˜…</span>';
            } else {
                html += '<span class="rating-star empty" data-rating="' + i + '">â˜…</span>';
            }
        }
        return html;
    }

    // è¯„åˆ†å¼¹çª—ç›¸å…³å˜é‡
    let currentRatingExamId = null;
    let selectedRating = 0;

    // æ‰“å¼€è¯„åˆ†å¼¹çª—
    function openRatingModal(examId) {
        const userToken = getUserToken();
        
        if (checkUserRated(examId, userToken)) {
            showToast('æ‚¨å·²ç»è¯„åˆ†è¿‡äº†ï¼');
            return;
        }

        currentRatingExamId = examId;
        selectedRating = 0;
        
        // é‡ç½®æ˜Ÿæ˜ŸçŠ¶æ€
        const stars = document.querySelectorAll('#rating-modal-stars .rating-modal-star');
        stars.forEach(star => {
            star.classList.remove('active');
        });
        
        // æ˜¾ç¤ºå¼¹çª—
        const overlay = document.getElementById('rating-modal-overlay');
        overlay.classList.add('show');
        
        // ç»‘å®šæ˜Ÿæ˜Ÿç‚¹å‡»äº‹ä»¶
        stars.forEach(star => {
            star.onclick = function() {
                const rating = parseInt(this.dataset.rating);
                selectedRating = rating;
                
                // æ›´æ–°æ˜Ÿæ˜Ÿæ˜¾ç¤º
                stars.forEach((s, index) => {
                    if (index < rating) {
                        s.classList.add('active');
                    } else {
                        s.classList.remove('active');
                    }
                });
            };
        });
    }

    // å…³é—­è¯„åˆ†å¼¹çª—
    function closeRatingModal(event) {
        // å¦‚æœç‚¹å‡»çš„æ˜¯å¼¹çª—å†…éƒ¨ï¼Œä¸å…³é—­
        if (event && event.target.closest('.rating-modal')) {
            return;
        }
        const overlay = document.getElementById('rating-modal-overlay');
        if (overlay) {
            overlay.classList.remove('show');
        }
        currentRatingExamId = null;
        selectedRating = 0;
    }

    // ç¡®è®¤è¯„åˆ†
    async function confirmRating() {
        if (!currentRatingExamId || selectedRating === 0) {
            showToast('è¯·å…ˆé€‰æ‹©è¯„åˆ†ï¼');
            return;
        }

        const examId = currentRatingExamId;
        const rating = selectedRating;
        const userToken = getUserToken();

        if (checkUserRated(examId, userToken)) {
            showToast('æ‚¨å·²ç»è¯„åˆ†è¿‡äº†ï¼');
            closeRatingModal();
            return;
        }

        try {
            const response = await fetch('/api/exam/rate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    exam_id: examId,
                    rating: rating,
                    user_token: userToken
                })
            });

            const result = await response.json();
            if (result.success) {
                markUserRated(examId, userToken);
                closeRatingModal();
                await loadExamList();
                showToast('è¯„åˆ†æˆåŠŸï¼');
            } else {
                showToast('è¯„åˆ†å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            console.error('è¯„åˆ†æäº¤å¤±è´¥:', error);
            showToast('è¯„åˆ†æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    // ç‚¹å‡»æ˜Ÿæ˜Ÿæ‰“å¼€è¯„åˆ†å¼¹çª—ï¼ˆæ—§å‡½æ•°ä¿ç•™ä½†æ”¹ä¸ºæ‰“å¼€å¼¹çª—ï¼‰
    function handleRatingClick(event) {
        event.stopPropagation();
        const starsContainer = event.currentTarget;
        const examId = parseInt(starsContainer.dataset.examId);
        openRatingModal(examId);
    }

    // --- é¦–é¡µé€»è¾‘ ---
    async function loadExamList() {
        try {
            const res = await fetch('/api/exams');
            const result = await res.json();
            const list = result.data || [];
            examList = list;
            
            const container = document.getElementById('exam-list');
            if(list.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#a0aec0;">æš‚æ— è¯•å·ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ä¸Šä¼ </div>';
                return;
            }

            container.innerHTML = list.map(exam => {
                const rate = exam.rate !== null && exam.rate !== undefined ? parseFloat(exam.rate) : 5.0;
                const rateDisplay = rate.toFixed(1);
                const rateNums = exam.ratenums !== null && exam.ratenums !== undefined ? parseInt(exam.ratenums) : 0;
                const userToken = getUserToken();
                const hasRated = checkUserRated(exam.id, userToken);
                
                return `
                <div class="exam-card">
                    <div onclick="startExam(${exam.id}, '${escapeHTML(exam.subject_name)}')" style="cursor: pointer;">
                        <div class="exam-title">${escapeHTML(exam.subject_name)}</div>
                        <div class="exam-meta">
                            <span class="user-tag">ä¸Šä¼ è€…: ${escapeHTML(exam.uploader_name)}</span>
                            <span>é¢˜ç›®: ${exam.question_count}</span>
                        </div>
                    </div>
                    <div class="rateAndDataContainer" onclick="event.stopPropagation();">
                        <div class="rating-display">
                            ${rateNums === 0 ? 
                                `<span class="rating-no-data">æš‚æ— è¯„åˆ†</span><span class="rating-link" onclick="openRatingModal(${exam.id})">å»è¯„åˆ†</span>` :
                                `<div class="rating-stars" data-exam-id="${exam.id}" data-current-rate="${rate}" data-has-rated="${hasRated}" ${hasRated ? 'style="cursor: default; opacity: 0.7;"' : ''}>
                                    ${generateStars(rate, hasRated)}
                                </div>
                                <span class="rating-value">${rateDisplay}</span>
                                <span class="rating-count">(${rateNums}äºº)</span>`
                            }
                        </div>
                        <div class="rating-date">
                            ${new Date(exam.created_at).toLocaleDateString()}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            // ç»‘å®šè¯„åˆ†ç‚¹å‡»äº‹ä»¶ï¼ˆåªå¯¹æœªè¯„åˆ†çš„ç»‘å®šï¼‰
            document.querySelectorAll('.rating-stars').forEach(stars => {
                const hasRated = stars.dataset.hasRated === 'true';
                if (!hasRated) {
                    stars.addEventListener('click', handleRatingClick);
                }
            });
        } catch(e) {
            console.error(e);
        }
    }

    // --- ä¸Šä¼ é€»è¾‘ ---
    let progressTimer = null;
    let targetPercentVal = 0;
    let currentPercentVal = 0;
    let previewQuestions = null; // å­˜å‚¨é¢„è§ˆçš„é¢˜ç›®æ•°æ®
    let previewUploader = '';
    let previewSubject = '';
    let previewMode = '';
    let previewFile = null; // å­˜å‚¨æ–‡ä»¶ï¼Œç”¨äºç¡®è®¤ä¸Šä¼ æ—¶ä½¿ç”¨

    function handleFileSelect() {
        const file = document.getElementById('fileInput').files[0];
        if(file) document.getElementById('fileName').innerText = file.name;
    }

    function handleJsonFileSelect() {
        const file = document.getElementById('jsonFileInput').files[0];
        if (file) document.getElementById('jsonFileName').innerText = file.name;
    }

    async function copyJsonTemplate() {
        const pre = document.getElementById('json-template-pre');
        if (!pre) return alert('æœªæ‰¾åˆ°æ¨¡æ¿å†…å®¹');
        const text = pre.innerText || pre.textContent || '';
        if (!text.trim()) return alert('æ¨¡æ¿å†…å®¹ä¸ºç©º');

        // ä¼˜å…ˆä½¿ç”¨ Clipboard API
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
                alert('å·²å¤åˆ¶ JSON æ¨¡æ¿åˆ°å‰ªè´´æ¿');
                return;
            }
        } catch (e) {
            console.error(e.error);
        }

        try {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            ta.style.top = '0';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            if (ok) alert('å·²å¤åˆ¶ JSON æ¨¡æ¿åˆ°å‰ªè´´æ¿');
            else alert('å¤åˆ¶å¤±è´¥ï¼šæµè§ˆå™¨ä¸æ”¯æŒè‡ªåŠ¨å¤åˆ¶ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
        } catch (e) {
            alert('å¤åˆ¶å¤±è´¥ï¼š' + e.message);
        }
    }

    function onUploadModeChange() {
        const mode = document.querySelector('input[name="uploadMode"]:checked')?.value || 'normal';
        const docxGroup = document.getElementById('docx-upload-group');
        const jsonGroup = document.getElementById('json-upload-group');
        if (!docxGroup || !jsonGroup) return;

        if (mode === 'json') {
            docxGroup.classList.add('hidden');
            jsonGroup.classList.remove('hidden');
        } else {
            jsonGroup.classList.add('hidden');
            docxGroup.classList.remove('hidden');
        }
    }

    function normalizeQuestionsPayload(raw) {
        if (Array.isArray(raw)) return raw;
        if (raw && typeof raw === 'object') {
            if (Array.isArray(raw.questions)) return raw.questions;
            if (Array.isArray(raw.data)) return raw.data;
        }
        return null;
    }

    function addLog(message, isHighlight = false) {
        const logs = document.getElementById('upload-logs');
        const div = document.createElement('div');
        div.className = 'log-item' + (isHighlight ? ' highlight' : '');
        div.innerText = `> ${message}`;
        logs.appendChild(div);
        logs.scrollTop = logs.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    }

    async function uploadFile() {
        const uploader = document.getElementById('uploaderName').value.trim();
        const subject = document.getElementById('subjectName').value.trim();
        const fileInput = document.getElementById('fileInput');
        const statusText = document.getElementById('uploadStatus');
        const mode = document.querySelector('input[name="uploadMode"]:checked').value;
        const jsonFileInput = document.getElementById('jsonFileInput');
        const jsonTextInput = document.getElementById('jsonTextInput');
        
        // è¿›åº¦æ¡å…ƒç´ 
        const progressBox = document.getElementById('upload-progress-box');
        const progressBar = document.getElementById('upload-progress-bar');
        const progressStatus = document.getElementById('upload-status-text');
        const progressPercent = document.getElementById('upload-percent');
        const logsDiv = document.getElementById('upload-logs');

        if(!uploader || !subject) {
            alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼ˆå§“åã€ç§‘ç›®ï¼‰');
            return;
        }

        // JSON å¯¼å…¥ï¼šæ— éœ€ docx
        if (mode === 'json') {
            const hasJsonFile = jsonFileInput && jsonFileInput.files && jsonFileInput.files.length > 0;
            const hasJsonText = jsonTextInput && jsonTextInput.value && jsonTextInput.value.trim().length > 0;
            if (!hasJsonFile && !hasJsonText) {
                alert('è¯·æä¾› JSON æ–‡ä»¶æˆ–ç²˜è´´ JSON å†…å®¹');
                return;
            }
        } else {
            if (!fileInput || fileInput.files.length === 0) {
                alert('è¯·ä¸Šä¼  Word æ–‡æ¡£ï¼ˆ.docxï¼‰');
                return;
            }
        }

        // åˆå§‹åŒ–ç•Œé¢çŠ¶æ€
        statusText.style.display = 'none';
        progressBox.style.display = 'block';
        
        // é‡ç½®è¿›åº¦çŠ¶æ€
        currentPercentVal = 0;
        targetPercentVal = 0;
        progressBar.style.width = '0%';
        progressPercent.innerText = '0%';
        
        // å¯åŠ¨å¹³æ»‘è¿›åº¦åŠ¨ç”»å¾ªç¯
        if (progressTimer) clearInterval(progressTimer);
        progressTimer = setInterval(() => {
            // ç­–ç•¥ï¼š
            // 1. å¦‚æœå½“å‰ < ç›®æ ‡ï¼šå¿«é€Ÿè¿½èµ¶ (Lerp)
            // 2. å¦‚æœå½“å‰ >= ç›®æ ‡ ä¸” ç›®æ ‡ < 95 (AIå¤„ç†ä¸­)ï¼šæ…¢é€Ÿè •åŠ¨ (Fake Progress)ï¼Œè®©ç”¨æˆ·è§‰å¾—æ²¡å¡æ­»
            
            if (currentPercentVal < targetPercentVal) {
                // è¿½èµ¶æ¨¡å¼ï¼šæ¯æ¬¡è¿½ 10% çš„å·®è·ï¼Œè‡³å°‘ +0.5
                const diff = targetPercentVal - currentPercentVal;
                const step = Math.max(0.5, diff * 0.1);
                currentPercentVal = Math.min(targetPercentVal, currentPercentVal + step);
            } else if ((mode === 'ai' || mode === 'json') && targetPercentVal > 0 && targetPercentVal < 95) {
                // è •åŠ¨æ¨¡å¼ï¼šæ¯å¸§ +0.05% (çº¦æ¯ç§’ +1-2%)ï¼Œä¸Šé™æ˜¯ target + 15 æˆ– 98
                const limit = Math.min(98, targetPercentVal + 20);
                if (currentPercentVal < limit) {
                    currentPercentVal += 0.05;
                }
            }
            
            // æ¸²æŸ“
            const pctStr = currentPercentVal.toFixed(1) + '%';
            progressBar.style.width = pctStr;
            progressPercent.innerText = Math.floor(currentPercentVal) + '%';
            
        }, 50); // 20FPS

        progressStatus.innerText = mode === 'ai' ? 'AI å¼•æ“å¤„ç†ä¸­...' : (mode === 'json' ? 'æ•°æ®å¯¼å…¥ä¸­...' : 'æ­£åœ¨ä¸Šä¼ ...');
        logsDiv.innerHTML = ''; // æ¸…ç©ºæ—¥å¿—
        addLog('ä»»åŠ¡å·²æäº¤ï¼Œå‡†å¤‡å¼€å§‹å¤„ç†...');

        // JSON å¯¼å…¥åˆ†æ”¯ï¼šç›´æ¥è§£æå¹¶æ˜¾ç¤ºé¢„è§ˆ
        if (mode === 'json') {
            try {
                targetPercentVal = 20;
                addLog('æ­£åœ¨è¯»å– JSON...', true);

                let rawJsonText = '';
                if (jsonFileInput && jsonFileInput.files && jsonFileInput.files[0]) {
                    rawJsonText = await jsonFileInput.files[0].text();
                } else {
                    rawJsonText = (jsonTextInput?.value || '').trim();
                }

                targetPercentVal = 45;
                addLog('æ­£åœ¨è§£æ JSON...', true);
                let parsed;
                try {
                    parsed = JSON.parse(rawJsonText);
                } catch (e) {
                    throw new Error('JSON æ ¼å¼ä¸åˆæ³•ï¼š' + e.message);
                }

                const questions = normalizeQuestionsPayload(parsed);
                if (!questions || !Array.isArray(questions) || questions.length === 0) {
                    throw new Error('JSON ä¸­æœªæ‰¾åˆ°é¢˜ç›®æ•°ç»„ï¼ˆéœ€è¦ [é¢˜ç›®æ•°ç»„] æˆ– {questions:[...]}ï¼‰');
                }

                targetPercentVal = 100;
                currentPercentVal = 100;
                progressBar.style.width = '100%';
                progressPercent.innerText = '100%';
                addLog(`å·²è¯†åˆ« ${questions.length} é¢˜`, true);
                
                // æ˜¾ç¤ºé¢„è§ˆ
                setTimeout(() => {
                    progressBox.style.display = 'none';
                    showQuestionPreview(questions, uploader, subject, mode);
                }, 500);
                return;
            } catch (e) {
                finishUpload(false, e.message);
                return;
            }
        }

        // æ™®é€šä¸Šä¼ å’ŒAIä¸Šä¼ ï¼šå…ˆè°ƒç”¨é¢„è§ˆæ¥å£
        previewFile = fileInput.files[0]; // ä¿å­˜æ–‡ä»¶ç”¨äºç¡®è®¤ä¸Šä¼ æ—¶ä½¿ç”¨
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        
        const previewEndpoint = mode === 'ai' ? '/api/upload/ai/preview' : '/api/upload/preview';

        try {
            const response = await fetch(previewEndpoint, { method: 'POST', body: formData });
            
            // å¦‚æœæ˜¯æ™®é€šä¸Šä¼ é¢„è§ˆ
            if (mode !== 'ai') {
                const data = await response.json();
                if (response.ok && data.success) {
                    targetPercentVal = 100;
                    currentPercentVal = 100;
                    progressBar.style.width = '100%';
                    progressPercent.innerText = '100%';
                    addLog(`è§£æå®Œæˆï¼Œå…± ${data.count} é¢˜`, true);
                    
                    // æ˜¾ç¤ºé¢„è§ˆ
                    setTimeout(() => {
                        progressBox.style.display = 'none';
                        showQuestionPreview(data.questions, uploader, subject, mode);
                    }, 500);
                } else {
                    addLog('è§£æå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    finishUpload(false, data.error || 'è§£æå¤±è´¥');
                }
                return;
            }

            // AI é¢„è§ˆæ¨¡å¼ï¼šå¤„ç†æµå¼å“åº”
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); 
                
                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const msg = JSON.parse(line);
                        
                        if (msg.type === 'progress') {
                            targetPercentVal = msg.percent;
                            progressStatus.innerText = 'æ­£åœ¨å¤„ç†...';
                            addLog(msg.message, msg.percent % 10 === 0); 
                        } else if (msg.type === 'complete' && msg.success) {
                            targetPercentVal = 100;
                            currentPercentVal = 100;
                            progressBar.style.width = '100%';
                            progressPercent.innerText = '100%';
                            addLog(`è§£æå®Œæˆï¼Œå…± ${msg.count} é¢˜`, true);
                            
                            // æ˜¾ç¤ºé¢„è§ˆ
                            setTimeout(() => {
                                progressBox.style.display = 'none';
                                showQuestionPreview(msg.questions, uploader, subject, mode);
                            }, 500);
                            return;
                        } else if (msg.type === 'error') {
                            addLog('âŒ ' + msg.message);
                            throw new Error(msg.message);
                        }
                    } catch (e) {
                        console.error('è§£ææµæ•°æ®å¤±è´¥:', e);
                    }
                }
            }

        } catch(e) {
            finishUpload(false, e.message);
        }
    }
    
    // æ˜¾ç¤ºé¢„è§ˆå¼¹çª—
    function showQuestionPreview(questions, uploader, subject, mode) {
        previewQuestions = questions;
        previewUploader = uploader;
        previewSubject = subject;
        previewMode = mode;
        
        const modal = document.getElementById('question-preview-modal');
        const countEl = document.getElementById('preview-question-count');
        const listEl = document.getElementById('preview-questions-list');
        
        if (!modal || !countEl || !listEl) return;
        
        countEl.textContent = questions.length;
        
        // æ¸²æŸ“é¢˜ç›®åˆ—è¡¨ï¼ˆæœ€å¤šæ˜¾ç¤ºå‰20é¢˜ï¼‰
        const displayCount = Math.min(questions.length, 20);
        listEl.innerHTML = questions.slice(0, displayCount).map((q, index) => {
            let optionsHtml = '';
            if (q.options && q.options.length > 0) {
                optionsHtml = q.options.map(opt => 
                    `<div class="question-preview-item-option">${opt.label}. ${escapeHTML(opt.content)}</div>`
                ).join('');
            }
            
            // è§£æå†…å®¹
            let explanationHtml = '';
            const rawExplanation = q.explanation || q.analysis || q.explain; // å…¼å®¹ä¸åŒå­—æ®µå
            if (rawExplanation && String(rawExplanation).trim()) {
                explanationHtml = `
                    <div class="question-preview-item-answer">
                        è§£æ: ${escapeHTMLWithLineBreaks(String(rawExplanation))}
                    </div>
                `;
            }
            
            return `
                <div class="question-preview-item">
                    <div class="question-preview-item-title">${index + 1}. ${escapeHTML(q.title || 'æ— æ ‡é¢˜')}</div>
                    <div class="question-preview-item-meta">
                        <span>ç±»å‹: ${escapeHTML(q.type || 'æœªçŸ¥')}</span>
                    </div>
                    ${optionsHtml ? `<div class="question-preview-item-options">${optionsHtml}</div>` : ''}
                    <div class="question-preview-item-answer" style="margin-top: 6px; background:#f0fff4; border-left-color:#7AB876;">ç­”æ¡ˆ: ${escapeHTML(q.answer || 'æ— ')}</div>
                    ${explanationHtml}
                </div>
            `;
        }).join('');
        
        if (questions.length > 20) {
            listEl.innerHTML += `<div style="text-align: center; padding: 15px; color: var(--text-secondary); font-size: 0.9rem;">è¿˜æœ‰ ${questions.length - 20} é“é¢˜æœªæ˜¾ç¤º...</div>`;
        }
        
        modal.classList.add('open');
    }
    
    // å…³é—­é¢„è§ˆå¼¹çª—
    window.closeQuestionPreview = function(event) {
        if (event && event.target !== event.currentTarget) return;
        const modal = document.getElementById('question-preview-modal');
        if (modal) {
            modal.classList.remove('open');
            previewQuestions = null;
            previewUploader = '';
            previewSubject = '';
            previewMode = '';
            previewFile = null;
        }
    }
    
    // ç¡®è®¤ä¸Šä¼ 
    window.confirmUpload = async function() {
        if (!previewQuestions || previewQuestions.length === 0) {
            alert('æ²¡æœ‰å¯ä¸Šä¼ çš„é¢˜ç›®');
            return;
        }
        
        const modal = document.getElementById('question-preview-modal');
        if (modal) {
            modal.classList.remove('open');
        }
        
        // éšè—è¿›åº¦æ¡ï¼Œå‡†å¤‡çœŸæ­£ä¸Šä¼ 
        const progressBox = document.getElementById('upload-progress-box');
        const progressBar = document.getElementById('upload-progress-bar');
        const progressStatus = document.getElementById('upload-status-text');
        const progressPercent = document.getElementById('upload-percent');
        const logsDiv = document.getElementById('upload-logs');
        
        progressBox.style.display = 'block';
        currentPercentVal = 0;
        targetPercentVal = 0;
        progressBar.style.width = '0%';
        progressPercent.innerText = '0%';
        logsDiv.innerHTML = '';
        addLog('å¼€å§‹ä¸Šä¼ åˆ°æ•°æ®åº“...', true);
        
        // å¯åŠ¨è¿›åº¦åŠ¨ç”»
        if (progressTimer) clearInterval(progressTimer);
        progressTimer = setInterval(() => {
            if (currentPercentVal < targetPercentVal) {
                const diff = targetPercentVal - currentPercentVal;
                const step = Math.max(0.5, diff * 0.1);
                currentPercentVal = Math.min(targetPercentVal, currentPercentVal + step);
            }
            const pctStr = currentPercentVal.toFixed(1) + '%';
            progressBar.style.width = pctStr;
            progressPercent.innerText = Math.floor(currentPercentVal) + '%';
        }, 50);
        
        try {
            if (previewMode === 'json') {
                // JSONæ¨¡å¼ï¼šç›´æ¥ä¸Šä¼ 
                targetPercentVal = 50;
                progressStatus.innerText = 'æ­£åœ¨ä¸Šä¼ ...';
                addLog('æ­£åœ¨ä¸Šä¼ åˆ°æ•°æ®åº“...', true);
                
                const response = await fetch('/api/upload/json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        uploader: previewUploader, 
                        subject: previewSubject, 
                        questions: previewQuestions 
                    })
                });
                const data = await response.json();
                
                if (response.ok && !data.error) {
                    targetPercentVal = 100;
                    currentPercentVal = 100;
                    progressBar.style.width = '100%';
                    progressPercent.innerText = '100%';
                    addLog('ä¸Šä¼ å®Œæˆï¼', true);
                    finishUpload(true, data.message || 'ä¸Šä¼ æˆåŠŸï¼');
                } else {
                    throw new Error(data.error || data.message || 'ä¸Šä¼ å¤±è´¥');
                }
            } else {
                // æ™®é€šä¸Šä¼ æˆ–AIä¸Šä¼ ï¼šéœ€è¦é‡æ–°ä¸Šä¼ æ–‡ä»¶
                if (!previewFile) {
                    throw new Error('æ–‡ä»¶ä¿¡æ¯ä¸¢å¤±ï¼Œè¯·é‡æ–°ä¸Šä¼ ');
                }
                
                const formData = new FormData();
                formData.append('uploader', previewUploader);
                formData.append('subject', previewSubject);
                formData.append('file', previewFile);
                
                const apiEndpoint = previewMode === 'ai' ? '/api/upload/ai' : '/api/upload';
                progressStatus.innerText = previewMode === 'ai' ? 'AI å¼•æ“å¤„ç†ä¸­...' : 'æ­£åœ¨ä¸Šä¼ ...';
                
                if (previewMode !== 'ai') {
                    // æ™®é€šä¸Šä¼ 
                    targetPercentVal = 50;
                    addLog('æ­£åœ¨ä¸Šä¼ åˆ°æ•°æ®åº“...', true);
                    
                    const response = await fetch(apiEndpoint, { method: 'POST', body: formData });
                    const data = await response.json();
                    
                    if (response.ok && !data.error) {
                        targetPercentVal = 100;
                        currentPercentVal = 100;
                        progressBar.style.width = '100%';
                        progressPercent.innerText = '100%';
                        addLog('ä¸Šä¼ å®Œæˆï¼', true);
                        finishUpload(true, 'ä¸Šä¼ æˆåŠŸï¼');
                    } else {
                        throw new Error(data.error || data.message || 'ä¸Šä¼ å¤±è´¥');
                    }
                } else {
                    // AIä¸Šä¼ ï¼šæµå¼å¤„ç†
                    const response = await fetch(apiEndpoint, { method: 'POST', body: formData });
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();
                        
                        for (const line of lines) {
                            if (!line.trim()) continue;
                            try {
                                const msg = JSON.parse(line);
                                
                                if (msg.type === 'progress') {
                                    targetPercentVal = msg.percent;
                                    progressStatus.innerText = 'æ­£åœ¨å¤„ç†...';
                                    addLog(msg.message, msg.percent % 10 === 0);
                                } else if (msg.type === 'complete') {
                                    addLog('âœ… ' + msg.message, true);
                                    finishUpload(true, msg.message);
                                    return;
                                } else if (msg.type === 'error') {
                                    addLog('âŒ ' + msg.message);
                                    throw new Error(msg.message);
                                }
                            } catch (e) {
                                console.error('è§£ææµæ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }
                }
            }
        } catch (e) {
            finishUpload(false, e.message);
        }
    }

    function finishUpload(success, message) {
        if (progressTimer) clearInterval(progressTimer);
        
        const statusText = document.getElementById('uploadStatus');
        const progressBox = document.getElementById('upload-progress-box');
        
        if (success) {
            statusText.innerText = 'âœ… ' + message;
            statusText.style.color = 'var(--success-color)';
            statusText.style.display = 'block';
            
            setTimeout(() => {
                // æ¸…ç©ºè¡¨å•
                document.getElementById('subjectName').value = '';
                document.getElementById('fileInput').value = '';
                document.getElementById('fileName').innerText = 'ç‚¹å‡»é€‰æ‹© Word æ–‡æ¡£';
                statusText.innerText = '';
                statusText.style.display = 'none';
                progressBox.style.display = 'none'; 
                toggleView('home');
            }, 2000);
        } else {
            statusText.innerText = 'âŒ å¤±è´¥: ' + message;
            statusText.style.color = 'var(--error-color)';
            statusText.style.display = 'block';
            document.getElementById('upload-progress-bar').style.background = '#f56565';
        }
    }

    
    /**
     * è§„èŒƒåŒ–åˆ¤æ–­é¢˜ç­”æ¡ˆï¼šç»Ÿä¸€è½¬æ¢ä¸º"æ­£ç¡®"æˆ–"é”™è¯¯"
     * @param {string} answer - åŸå§‹ç­”æ¡ˆ
     * @returns {string} - "æ­£ç¡®" æˆ– "é”™è¯¯"
     */
    function normalizeJudgementAnswer(answer) {
        if (!answer || typeof answer !== 'string') return 'é”™è¯¯';
        
        const normalized = answer.trim();
        
        if (/^(æ­£ç¡®|å¯¹|æ˜¯|âˆš|âœ“|T|True|Y|Yes|1)$/i.test(normalized)) {
            return 'æ­£ç¡®';
        }
        
        if (/^(é”™è¯¯|é”™|å¦|Ã—|âœ—|F|False|N|No|0)$/i.test(normalized)) {
            return 'é”™è¯¯';
        }
        
        return 'é”™è¯¯';
    }

    function escapeHTML(str) {
        if (!str || typeof str !== 'string') return str || '';
        return str.replace(/[&<>"']/g, function(m) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m];
        });
    }

    function escapeHTMLWithLineBreaks(str) {
        if (!str || typeof str !== 'string') return str || '';
        return escapeHTML(str).replace(/\n/g, '<br>');
    }

    async function startExam(examId, subjectName) {
        currentExamId = examId;
        document.getElementById('quiz-subject-title').innerText = subjectName;
        
        try {
            const res = await fetch(`/api/questions?exam_id=${examId}`);
            const result = await res.json();
            
            if(result.data && result.data.length > 0) {
                currentQuestions = result.data;
                
                // å°è¯•åŠ è½½ç¼“å­˜
                const hasCache = loadProgress();
                if (!hasCache) {
                    // æ— ç¼“å­˜ï¼Œåˆå§‹åŒ–
                    currentIndex = 0;
                    score = 0;
                    answeredIndices.clear();
                    userAnswersMap = {};
                    questionStatusMap = {};
                }

                toggleView('quiz');
                document.getElementById('progress-container').style.display = 'flex';
                
                // æ¸²æŸ“
                renderNavGrid();
                loadQuestion();
            } else {
                alert('è¯¥è¯•å·æš‚æ— é¢˜ç›®');
            }
        } catch(e) {
            alert('åŠ è½½é¢˜ç›®å‡ºé”™: ' + e.message);
            console.error(e);
        }
    }

    function renderNavGrid() {
        const grid = document.getElementById('question-nav-grid');
        document.getElementById('total-count').innerText = currentQuestions.length;
        document.getElementById('answered-count').innerText = answeredIndices.size;
        
        grid.innerHTML = currentQuestions.map((_, i) => {
            let classes = 'question-dot';
            
            // çŠ¶æ€æ ·å¼
            if (questionStatusMap[i] === 'correct') classes += ' status-correct';
            else if (questionStatusMap[i] === 'wrong') classes += ' status-wrong';
            else if (answeredIndices.has(i)) classes += ' answered'; // å…¼å®¹æ—§æ•°æ®
            
            // å½“å‰é€‰ä¸­é«˜äº®
            if (i === currentIndex) classes += ' active';
            
            return `<div class="${classes}" onclick="jumpToQuestion(${i}); toggleSidebar(false);">${i + 1}</div>`;
        }).join('');
    }

    // åˆ‡æ¢ä¾§è¾¹æ 
    function toggleSidebar(show) {
        const sidebar = document.getElementById('quiz-sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        if (show) {
            sidebar.classList.add('open');
            overlay.classList.add('open');
        } else {
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
        }
    }

    function jumpToQuestion(index) {
        if (index === currentIndex) return;
        currentIndex = index;
        loadQuestion();
    }

    function loadQuestion() {
        // å®‰å…¨æ£€æŸ¥
        if (!currentQuestions || currentQuestions.length === 0) return;
        if (currentIndex >= currentQuestions.length) currentIndex = 0;

        // åˆ¤æ–­å½“å‰é¢˜æ˜¯å¦å·²ç­”
        const isAnswered = answeredIndices.has(currentIndex);
        currentStep = isAnswered ? 'reviewed' : 'answering';
        
        const q = currentQuestions[currentIndex];
        
        // åŒé‡ä¿é™©
        if (!q) {
            console.error('é¢˜ç›®æ•°æ®å¼‚å¸¸', currentIndex, currentQuestions);
            document.getElementById('question-container').innerHTML = '<p style="color:red">é¢˜ç›®åŠ è½½å‡ºé”™ï¼Œè¯·åˆ·æ–°é‡è¯•</p>';
            return;
        }

        const container = document.getElementById('question-container');
        const btn = document.getElementById('btn-action');

        // æ›´æ–°å¯¼èˆªé«˜äº®
        renderNavGrid();

        // è¿›åº¦
        document.getElementById('progress-text').innerText = `${currentIndex + 1} / ${currentQuestions.length}`;
        document.getElementById('progress-fill').style.width = `${((currentIndex + 1) / currentQuestions.length) * 100}%`;
        
        // æŒ‰é’®çŠ¶æ€
        const addWrongBtn = document.getElementById('btn-add-wrong');
        const prevBtn = document.getElementById('btn-prev');
        if (isAnswered) {
            btn.innerText = (currentIndex === currentQuestions.length - 1) ? 'æŸ¥çœ‹ç»“æœ' : 'ä¸‹ä¸€é¢˜';
            if (addWrongBtn) {
                addWrongBtn.style.display = 'inline-block';
            }
            // æ˜¾ç¤ºä¸Šä¸€é¢˜æŒ‰é’®ï¼ˆå¦‚æœä¸æ˜¯ç¬¬ä¸€é¢˜ï¼‰
            if (prevBtn) {
                prevBtn.style.display = currentIndex > 0 ? 'inline-block' : 'none';
            }
        } else {
            btn.innerText = 'æäº¤æœ¬é¢˜';
            if (addWrongBtn) {
                addWrongBtn.style.display = 'none';
            }
            // ç­”é¢˜æ¨¡å¼ä¸‹éšè—ä¸Šä¸€é¢˜æŒ‰é’®
            if (prevBtn) {
                prevBtn.style.display = 'none';
            }
        }

        let html = `<div class="question-title">${currentIndex + 1}. <span class="tag" style="vertical-align:middle; margin-right:8px;">${escapeHTML(q.type || 'æœªçŸ¥')}</span>${escapeHTML(q.title)}</div>`;

        // è¾…åŠ©ï¼šè·å–å›æ˜¾çš„ç­”æ¡ˆ
        const savedAns = userAnswersMap[currentIndex] || '';

        if(q.options && q.options.length > 0) {
            // é€‰æ‹©é¢˜
            const inputType = (q.type === 'å¤šé€‰é¢˜') ? 'checkbox' : 'radio';
            html += `<ul class="options">`;
            q.options.forEach(opt => {
                // å›æ˜¾é€‰ä¸­çŠ¶æ€
                let checkedAttr = '';
                let labelClass = '';
                if (inputType === 'radio' && savedAns === opt.label) {
                    checkedAttr = 'checked';
                    labelClass = 'selected';
                } else if (inputType === 'checkbox' && savedAns.includes(opt.label)) {
                    checkedAttr = 'checked';
                    labelClass = 'selected';
                }

                html += `
                    <li class="option-item">
                        <label class="${labelClass}" onclick="selectOption(this, '${inputType}')">
                            <input type="${inputType}" name="q" value="${escapeHTML(opt.label)}" ${checkedAttr}>
                            <span><strong style="color:var(--primary-color)">${escapeHTML(opt.label)}.</strong> ${escapeHTML(opt.content)}</span>
                        </label>
                    </li>`;
            });
            html += `</ul>`;
        } else if (q.type === 'åˆ¤æ–­é¢˜' || q.answer === 'æ­£ç¡®' || q.answer === 'é”™è¯¯' || 
                   q.answer === 'å¯¹' || q.answer === 'é”™' || q.answer === 'æ˜¯' || q.answer === 'å¦') {
            // è§„èŒƒåŒ–ä¿å­˜çš„ç­”æ¡ˆç”¨äºå›æ˜¾ï¼ˆåªæœ‰å·²ä¿å­˜ç­”æ¡ˆæ—¶æ‰å›æ˜¾ï¼‰
            let isCorrect = false;
            let isWrong = false;
            if (savedAns && savedAns.trim()) {
                const normalizedSavedAns = normalizeJudgementAnswer(savedAns);
                isCorrect = (normalizedSavedAns === 'æ­£ç¡®' || normalizedSavedAns === 'å¯¹');
                isWrong = (normalizedSavedAns === 'é”™è¯¯' || normalizedSavedAns === 'é”™');
            }
            html += `
                <ul class="options">
                    <li class="option-item"><label class="${isCorrect?'selected':''}" onclick="selectOption(this, 'radio')"><input type="radio" name="q" value="æ­£ç¡®" ${isCorrect?'checked':''}><span>æ­£ç¡® (âˆš)</span></label></li>
                    <li class="option-item"><label class="${isWrong?'selected':''}" onclick="selectOption(this, 'radio')"><input type="radio" name="q" value="é”™è¯¯" ${isWrong?'checked':''}><span>é”™è¯¯ (Ã—)</span></label></li>
                </ul>`;
        } else {
            // ç®€ç­”
            html += `<textarea id="text-answer" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ...">${escapeHTML(savedAns)}</textarea>`;
        }

        html += `<div id="explanation-area"></div>`;
        container.innerHTML = html;

        // æ˜¾ç¤ºå¿«æ·é”®æç¤ºï¼ˆåœ¨ç­”é¢˜å’ŒæŸ¥çœ‹æ¨¡å¼ä¸‹éƒ½æ˜¾ç¤ºï¼‰
        const hints = document.getElementById('keyboard-hints');
        if (hints) {
            hints.style.display = 'block';
        }

        // å¦‚æœå·²ç­”ï¼Œç›´æ¥æ˜¾ç¤ºè§£æå¹¶ç¦ç”¨è¾“å…¥
        if (isAnswered) {
            // å»¶è¿Ÿä¸€ç‚¹æ˜¾ç¤ºè§£æï¼Œç¡®ä¿ DOM æ¸²æŸ“å®Œæ¯•
            setTimeout(() => {
                // åˆ¤æ–­é¢˜éœ€è¦è§„èŒƒåŒ–æ¯”è¾ƒ
                let isCorrect;
                if (q.type === 'åˆ¤æ–­é¢˜' || q.answer === 'æ­£ç¡®' || q.answer === 'é”™è¯¯' || 
                    q.answer === 'å¯¹' || q.answer === 'é”™' || q.answer === 'æ˜¯' || q.answer === 'å¦') {
                    const normalizedSavedAns = normalizeJudgementAnswer(savedAns);
                    const normalizedCorrectAns = normalizeJudgementAnswer(q.answer);
                    isCorrect = (normalizedSavedAns === normalizedCorrectAns);
                } else {
                    isCorrect = (savedAns === q.answer);
                }
                showFeedback(isCorrect, q.answer, savedAns);
                // ç¦ç”¨æ‰€æœ‰è¾“å…¥
                container.querySelectorAll('input, textarea').forEach(el => {
                    el.disabled = true;
                    el.parentElement.onclick = null; // ç§»é™¤ç‚¹å‡»äº‹ä»¶
                });
            }, 0);
        }
    }

    window.selectOption = function(label, type) {
        if(currentStep !== 'answering') return;
        
        if (type === 'radio') {
            label.closest('ul').querySelectorAll('label').forEach(l => l.classList.remove('selected'));
            label.classList.add('selected');
            label.querySelector('input').checked = true;
        } else {
            // checkbox å¤šé€‰é€»è¾‘
            const checkbox = label.querySelector('input');
            checkbox.checked = !checkbox.checked;
            if (checkbox.checked) {
                label.classList.add('selected');
            } else {
                label.classList.remove('selected');
            }
        }
    }

    window.handleAction = function() {
        const btn = document.getElementById('btn-action');
        const q = currentQuestions[currentIndex];

        if(currentStep === 'answering') {
            // æäº¤é€»è¾‘
            let userAns = '';
            const inputs = document.querySelectorAll('input[name="q"]');
            
            if(inputs.length > 0) {
                const checked = Array.from(inputs).filter(i => i.checked);
                if(checked.length === 0) return alert('è¯·é€‰æ‹©ç­”æ¡ˆ');
                
                // æ’åºå¹¶åˆå¹¶ç­”æ¡ˆ (é’ˆå¯¹å¤šé€‰é¢˜ï¼Œå¦‚ ABC)
                userAns = checked.map(i => i.value).sort().join('');
            } else {
                userAns = document.getElementById('text-answer').value;
            }

            // åˆ¤æ–­é¢˜éœ€è¦è§„èŒƒåŒ–ç­”æ¡ˆæ ¼å¼
            let isCorrect;
            if (q.type === 'åˆ¤æ–­é¢˜' || q.answer === 'æ­£ç¡®' || q.answer === 'é”™è¯¯' || 
                q.answer === 'å¯¹' || q.answer === 'é”™' || q.answer === 'æ˜¯' || q.answer === 'å¦') {
                // åˆ¤æ–­é¢˜ï¼šè§„èŒƒåŒ–åæ¯”è¾ƒ
                const normalizedUserAns = normalizeJudgementAnswer(userAns);
                const normalizedCorrectAns = normalizeJudgementAnswer(q.answer);
                isCorrect = (normalizedUserAns === normalizedCorrectAns);
            } else {
                // å…¶ä»–é¢˜å‹ï¼šç›´æ¥æ¯”è¾ƒï¼ˆå¤šé€‰é¢˜éœ€è¦æ’åºåæ¯”è¾ƒï¼‰
                isCorrect = (userAns === q.answer);
            }
            
            if(isCorrect) score++;

            // æ ‡è®°ä¸ºå·²ä½œç­”
            answeredIndices.add(currentIndex);
            userAnswersMap[currentIndex] = userAns;
            questionStatusMap[currentIndex] = isCorrect ? 'correct' : 'wrong'; // è®°å½•å¯¹é”™çŠ¶æ€
            
            // æ˜¾ç¤ºåé¦ˆ
            showFeedback(isCorrect, q.answer, userAns);
            
            currentStep = 'reviewed';
            btn.innerText = (currentIndex === currentQuestions.length - 1) ? 'æŸ¥çœ‹ç»“æœ' : 'ä¸‹ä¸€é¢˜';
            
            const addWrongBtn = document.getElementById('btn-add-wrong');
            if (addWrongBtn) {
                addWrongBtn.style.display = 'inline-block';
            }
            
            // æ˜¾ç¤ºä¸Šä¸€é¢˜æŒ‰é’®ï¼ˆå¦‚æœä¸æ˜¯ç¬¬ä¸€é¢˜ï¼‰
            const prevBtn = document.getElementById('btn-prev');
            if (prevBtn) {
                prevBtn.style.display = currentIndex > 0 ? 'inline-block' : 'none';
            }
            
            // æ›´æ–°å¿«æ·é”®æç¤ºæ˜¾ç¤ºçŠ¶æ€
            const hints = document.getElementById('keyboard-hints');
            if (hints) {
                hints.style.display = 'block';
            }
            
            renderNavGrid();
            if (!isChallengeMode) {
                saveProgress();
            }
            
        } else {
            const addWrongBtn = document.getElementById('btn-add-wrong');
            if (addWrongBtn) {
                addWrongBtn.style.display = 'none';
            }
            
            // æ›´æ–°å¿«æ·é”®æç¤ºæ˜¾ç¤ºçŠ¶æ€
            const hints = document.getElementById('keyboard-hints');
            if (hints) {
                hints.style.display = 'block';
            }
            
            if(currentIndex < currentQuestions.length - 1) {
                currentIndex++;
                if (!isChallengeMode) {
                    saveProgress();
                }
                loadQuestion();
            } else {
                showResult();
            }
        }
    }
    
    // ä¸Šä¸€é¢˜åŠŸèƒ½
    window.goToPreviousQuestion = function() {
        if (currentIndex > 0) {
            currentIndex--;
            if (!isChallengeMode) {
                saveProgress();
            }
            loadQuestion();
        }
    }

    function showFeedback(isCorrect, rightAns, userAns) {
        const area = document.getElementById('explanation-area');
        const color = isCorrect ? '#48bb78' : '#f56565';
        
        const q = currentQuestions[currentIndex];
        
        let displayRightAns = rightAns;
        let displayUserAns = userAns;
        if (q.type === 'åˆ¤æ–­é¢˜' || rightAns === 'æ­£ç¡®' || rightAns === 'é”™è¯¯' || 
            rightAns === 'å¯¹' || rightAns === 'é”™' || rightAns === 'æ˜¯' || rightAns === 'å¦') {
            displayRightAns = normalizeJudgementAnswer(rightAns);
            displayUserAns = normalizeJudgementAnswer(userAns);
        }
        
        document.querySelectorAll('input[name="q"]').forEach(input => {
            const label = input.parentElement;
            const val = input.value;
            
            const isJudgement = q.type === 'åˆ¤æ–­é¢˜' || rightAns === 'æ­£ç¡®' || rightAns === 'é”™è¯¯' || 
                               rightAns === 'å¯¹' || rightAns === 'é”™' || rightAns === 'æ˜¯' || rightAns === 'å¦';
            
            if (isJudgement) {
                const normalizedRightAns = normalizeJudgementAnswer(rightAns);
                const normalizedUserAns = normalizeJudgementAnswer(userAns);
                
                if (normalizedRightAns === val) {
                    label.classList.add('correct');
                }
                
                if (normalizedUserAns === val && normalizedRightAns !== val) {
                    label.classList.add('wrong');
                }
            } else {
                const safeRightAns = String(rightAns || '');
                const safeUserAns = String(userAns || '');

                if (safeRightAns.includes(val)) {
                    label.classList.add('correct');
                }
                
                if (safeUserAns.includes(val) && !safeRightAns.includes(val)) {
                    label.classList.add('wrong');
                }
            }
            
            input.disabled = true;
        });

        const explanation = q.explanation ? `<div style="margin-top:10px; border-top:1px dashed #e2e8f0; padding-top:10px; font-size:0.9rem;"><strong>è§£æï¼š<br></strong>${escapeHTML(q.explanation)}</div>` : '';

        area.innerHTML = `
            <div class="explanation-box" style="border-left-color:${color}">
                <strong style="color:${color}">${isCorrect ? 'å›ç­”æ­£ç¡®' : 'å›ç­”é”™è¯¯'}</strong>
                <div style="margin-top:5px; color:var(--text-secondary)">æ­£ç¡®ç­”æ¡ˆï¼š<br>${escapeHTMLWithLineBreaks(displayRightAns)}</div>
                ${explanation}
                <button class="ai-btn" onclick="askAI(this)">âœ¨é—®AI</button>
            </div>
        `;
        
        // å¦‚æœç­”é”™äº†ä¸”å¼€å¯äº†è‡ªåŠ¨æ·»åŠ é”™é¢˜æœ¬ï¼Œåˆ™è‡ªåŠ¨æ·»åŠ 
        if (!isCorrect && getAutoAddWrongBookSetting()) {
            autoAddToWrongBook(q, userAns);
        }
    }

    async function askAI(btn) {
        const q = currentQuestions[currentIndex];
        const userAns = userAnswersMap[currentIndex] || 'æœªä½œç­”';
        
        // ç•Œé¢çŠ¶æ€æ›´æ–°
        btn.disabled = true;
        btn.classList.add('thinking'); // æ·»åŠ åŠ¨ç”»ç±»
        btn.innerHTML = '<span class="thinking-icon">âœ¨</span> <span class="thinking-text">æ­£åœ¨æ€è€ƒ</span><span class="thinking-dots"><span class="thinking-dot"></span><span class="thinking-dot"></span><span class="thinking-dot"></span></span>';
        
        const feedbackBox = btn.parentElement;
        
        // åˆ›å»ºæˆ–è·å– AI å®¹å™¨
        let aiContainer = feedbackBox.querySelector('.ai-box');
        if (!aiContainer) {
            aiContainer = document.createElement('div');
            aiContainer.className = 'ai-box hidden';
            feedbackBox.appendChild(aiContainer);
        }
        
        try {
            const res = await fetch('/api/ask-ai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question: q,
                    userAnswer: userAns
                })
            });
            const data = await res.json();
            
            if (data.error) throw new Error(data.error);
            
            aiContainer.innerHTML = `
                <div class="ai-title">âœ¨ AIè§£æ</div>
                <div class="ai-content">${escapeHTML(data.reply)}</div>
            `;
            aiContainer.classList.remove('hidden');
            btn.innerHTML = 'âœ¨ é‡æ–°æé—®';
            btn.classList.remove('thinking'); // ç§»é™¤åŠ¨ç”»ç±»
            btn.disabled = false;
            
        } catch (e) {
            alert('AI è¯·æ±‚å¤±è´¥: ' + e.message);
            btn.innerHTML = 'âœ¨ é—® AI';
            btn.classList.remove('thinking'); // ç§»é™¤åŠ¨ç”»ç±»
            btn.disabled = false;
        }
    }

    // è‡ªåŠ¨æ·»åŠ é”™é¢˜æœ¬ï¼ˆå¸¦é‡å¤æ£€æŸ¥ï¼‰
    function autoAddToWrongBook(q, userAns) {
        if (!q) return;
        
        const wrongQuestions = JSON.parse(localStorage.getItem('wrongbook') || '[]');
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒçš„é¢˜ç›®ï¼ˆé€šè¿‡é¢˜ç›®æ ‡é¢˜å’Œç­”æ¡ˆæ¥åˆ¤æ–­ï¼‰
        const isDuplicate = wrongQuestions.some(wq => 
            wq.title === q.title && 
            wq.answer === q.answer &&
            wq.type === (q.type || 'æœªçŸ¥')
        );
        
        if (isDuplicate) {
            // å¦‚æœå·²å­˜åœ¨ï¼Œä¸é‡å¤æ·»åŠ ï¼Œé™é»˜å¤„ç†
            return;
        }
        
        const questionData = {
            id: Date.now() + Math.random(),
            title: q.title,
            type: q.type || 'æœªçŸ¥',
            options: q.options || [],
            answer: q.answer,
            explanation: q.explanation || '',
            userAnswer: userAns || '',
            addedAt: new Date().toISOString()
        };
        
        wrongQuestions.push(questionData);
        localStorage.setItem('wrongbook', JSON.stringify(wrongQuestions));
        
        // é™é»˜æ·»åŠ ï¼Œä¸æ˜¾ç¤ºæç¤ºï¼ˆå› ä¸ºæ˜¯è‡ªåŠ¨çš„ï¼‰
    }
    
    function addToWrongBook() {
        if (!currentQuestions || currentIndex >= currentQuestions.length) return;
        
        const q = currentQuestions[currentIndex];
        if (!q) return;
        
        const wrongQuestions = JSON.parse(localStorage.getItem('wrongbook') || '[]');
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒçš„é¢˜ç›®
        const isDuplicate = wrongQuestions.some(wq => 
            wq.title === q.title && 
            wq.answer === q.answer &&
            wq.type === (q.type || 'æœªçŸ¥')
        );
        
        if (isDuplicate) {
            showToast('è¯¥é¢˜ç›®å·²åœ¨é”™é¢˜æœ¬ä¸­');
            return;
        }
        
        const questionData = {
            id: Date.now() + Math.random(),
            title: q.title,
            type: q.type || 'æœªçŸ¥',
            options: q.options || [],
            answer: q.answer,
            explanation: q.explanation || '',
            userAnswer: userAnswersMap[currentIndex] || '',
            addedAt: new Date().toISOString()
        };
        
        wrongQuestions.push(questionData);
        localStorage.setItem('wrongbook', JSON.stringify(wrongQuestions));
        
        showToast('å·²åŠ å…¥é”™é¢˜æœ¬');
    }
    
    function showToast(message, duration = 3000) {
        const container = document.getElementById('toast-container');
        if (!container) return;
        
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'toastFadeOut 0.3s ease-in';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, duration);
    }
    
    function loadWrongBook() {
        const container = document.getElementById('wrongbook-list');
        if (!container) return;
        
        const wrongQuestions = JSON.parse(localStorage.getItem('wrongbook') || '[]');
        const redoAllBtn = document.getElementById('btn-redo-all');
        const deleteAllBtn = document.getElementById('btn-delete-all');
        const batchActions = document.getElementById('batch-actions');
        
        if (redoAllBtn) {
            redoAllBtn.style.display = wrongQuestions.length > 0 ? 'inline-block' : 'none';
        }
        
        if (deleteAllBtn) {
            deleteAllBtn.style.display = wrongQuestions.length > 0 ? 'inline-block' : 'none';
        }
        
        if (batchActions) {
            batchActions.style.display = wrongQuestions.length > 0 ? 'flex' : 'none';
        }
        
        if (wrongQuestions.length === 0) {
            container.innerHTML = '<p style="color: #718096; grid-column: 1/-1; text-align: center; padding: 40px;">æš‚æ— é”™é¢˜</p>';
            updateDeleteSelectedButton();
            return;
        }
        
        container.innerHTML = wrongQuestions.map(q => `
            <div class="exam-card" style="position: relative;">
                <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 12px;">
                    <input type="checkbox" class="wrong-question-checkbox" data-question-id="${q.id}" onchange="handleCheckboxChange()" style="margin-top: 4px; cursor: pointer; flex-shrink: 0;">
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <h3 style="margin: 0; font-size: 1.1rem; color: var(--text-main); flex: 1;">${escapeHTML(q.title)}</h3>
                            <button class="btn btn-secondary" onclick="deleteWrongQuestion(${q.id})" style="padding: 4px 12px; font-size: 0.85rem; margin-left: 10px;">åˆ é™¤</button>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span class="tag" style="font-size: 0.8rem;">${escapeHTML(q.type)}</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">
                            <div>æ­£ç¡®ç­”æ¡ˆ:<br> <strong style="color: var(--success-color);">${escapeHTMLWithLineBreaks(q.answer)}</strong></div>
                            <div>ä½ çš„ç­”æ¡ˆ: <br><strong style="color: var(--error-color);">${escapeHTMLWithLineBreaks(q.userAnswer || 'æœªä½œç­”')}</strong></div>
                        </div>
                        <button class="btn btn-primary" onclick="startWrongQuestion(${q.id})" style="width: 100%;">é‡æ–°ç­”é¢˜</button>
                    </div>
                </div>
            </div>
        `).join('');
        
        updateDeleteSelectedButton();
        updateSelectAllCheckbox();
        
        // åˆå§‹åŒ–è‡ªåŠ¨æ·»åŠ é”™é¢˜æœ¬å¼€å…³çŠ¶æ€
        initAutoAddWrongBookToggle();
    }
    
    // åˆå§‹åŒ–è‡ªåŠ¨æ·»åŠ é”™é¢˜æœ¬å¼€å…³
    function initAutoAddWrongBookToggle() {
        const toggle = document.getElementById('auto-add-wrongbook-toggle');
        if (toggle) {
            const isEnabled = getAutoAddWrongBookSetting();
            toggle.checked = isEnabled;
        }
    }
    
    // è·å–è‡ªåŠ¨æ·»åŠ é”™é¢˜æœ¬é…ç½®
    function getAutoAddWrongBookSetting() {
        const saved = localStorage.getItem('auto_add_wrongbook');
        // é»˜è®¤å…³é—­ï¼Œå¦‚æœæœªè®¾ç½®åˆ™è¿”å› false
        return saved === 'true';
    }
    
    // åˆ‡æ¢è‡ªåŠ¨æ·»åŠ é”™é¢˜æœ¬é…ç½®
    function toggleAutoAddWrongBook() {
        const toggle = document.getElementById('auto-add-wrongbook-toggle');
        if (toggle) {
            const isEnabled = toggle.checked;
            localStorage.setItem('auto_add_wrongbook', isEnabled ? 'true' : 'false');
            showToast(isEnabled ? 'å·²å¼€å¯è‡ªåŠ¨æ·»åŠ é”™é¢˜æœ¬' : 'å·²å…³é—­è‡ªåŠ¨æ·»åŠ é”™é¢˜æœ¬', 2000);
        }
    }
    
    function deleteWrongQuestion(questionId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™é“é”™é¢˜å—ï¼Ÿ')) return;
        
        const wrongQuestions = JSON.parse(localStorage.getItem('wrongbook') || '[]');
        const filtered = wrongQuestions.filter(q => q.id !== questionId);
        localStorage.setItem('wrongbook', JSON.stringify(filtered));
        
        loadWrongBook();
    }
    
    function deleteAllWrongQuestions() {
        const wrongQuestions = JSON.parse(localStorage.getItem('wrongbook') || '[]');
        if (wrongQuestions.length === 0) {
            showToast('é”™é¢˜æœ¬å·²ç»æ˜¯ç©ºçš„äº†');
            return;
        }
        
        if (!confirm(`âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦åˆ é™¤æ‰€æœ‰ ${wrongQuestions.length} é“é”™é¢˜å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼`)) {
            return;
        }
        
        localStorage.setItem('wrongbook', JSON.stringify([]));
        showToast('å·²æ¸…ç©ºæ‰€æœ‰é”™é¢˜');
        loadWrongBook();
    }
    
    // å¤„ç†å•ä¸ªå¤é€‰æ¡†å˜åŒ–
    function handleCheckboxChange() {
        updateDeleteSelectedButton();
        updateSelectAllCheckbox();
    }
    
    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const checkboxes = document.querySelectorAll('.wrong-question-checkbox');
        const isChecked = selectAllCheckbox.checked;
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        
        updateDeleteSelectedButton();
    }
    
    // åé€‰
    function invertSelection() {
        const checkboxes = document.querySelectorAll('.wrong-question-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = !checkbox.checked;
        });
        
        updateDeleteSelectedButton();
        updateSelectAllCheckbox();
    }
    
    // åˆ é™¤é€‰ä¸­çš„é”™é¢˜
    function deleteSelectedWrongQuestions() {
        const checkboxes = document.querySelectorAll('.wrong-question-checkbox:checked');
        if (checkboxes.length === 0) {
            showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é”™é¢˜');
            return;
        }
        
        const selectedIds = Array.from(checkboxes).map(cb => {
            const id = parseFloat(cb.getAttribute('data-question-id'));
            return isNaN(id) ? null : id;
        }).filter(id => id !== null);
        
        if (selectedIds.length === 0) {
            showToast('æœªæ‰¾åˆ°æœ‰æ•ˆçš„é”™é¢˜ID');
            return;
        }
        
        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedIds.length} é“é”™é¢˜å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
            return;
        }
        
        const wrongQuestions = JSON.parse(localStorage.getItem('wrongbook') || '[]');
        const filtered = wrongQuestions.filter(q => !selectedIds.includes(q.id));
        localStorage.setItem('wrongbook', JSON.stringify(filtered));
        
        showToast(`å·²åˆ é™¤ ${selectedIds.length} é“é”™é¢˜`);
        loadWrongBook();
    }
    
    // æ›´æ–°åˆ é™¤é€‰ä¸­æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
    function updateDeleteSelectedButton() {
        const deleteSelectedBtn = document.getElementById('btn-delete-selected');
        const checkboxes = document.querySelectorAll('.wrong-question-checkbox:checked');
        const hasSelected = checkboxes.length > 0;
        
        if (deleteSelectedBtn) {
            deleteSelectedBtn.style.display = hasSelected ? 'inline-block' : 'none';
            if (hasSelected) {
                deleteSelectedBtn.textContent = `åˆ é™¤é€‰ä¸­ (${checkboxes.length})`;
            }
        }
    }
    
    // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çš„çŠ¶æ€
    function updateSelectAllCheckbox() {
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const checkboxes = document.querySelectorAll('.wrong-question-checkbox');
        
        if (selectAllCheckbox && checkboxes.length > 0) {
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }
    }
    
    function startWrongQuestion(questionId) {
        const wrongQuestions = JSON.parse(localStorage.getItem('wrongbook') || '[]');
        const q = wrongQuestions.find(item => item.id === questionId);
        if (!q) return;
        currentQuestions = [{
            title: q.title,
            type: q.type,
            options: q.options,
            answer: q.answer,
            explanation: q.explanation
        }];
        
        currentIndex = 0;
        score = 0;
        answeredIndices = new Set();
        userAnswersMap = {};
        questionStatusMap = {};
        currentExamId = null;
        isChallengeMode = false;
        
        toggleView('quiz');
        loadQuestion();
    }
    
    function startAllWrongQuestions() {
        const wrongQuestions = JSON.parse(localStorage.getItem('wrongbook') || '[]');
        if (wrongQuestions.length === 0) {
            alert('é”™é¢˜æœ¬ä¸ºç©º');
            return;
        }
        
        currentQuestions = wrongQuestions.map(q => ({
            title: q.title,
            type: q.type,
            options: q.options,
            answer: q.answer,
            explanation: q.explanation
        }));
        
        currentIndex = 0;
        score = 0;
        answeredIndices = new Set();
        userAnswersMap = {};
        questionStatusMap = {};
        currentExamId = null;
        isChallengeMode = false;
        
        toggleView('quiz');
        loadQuestion();
    }

    function showResult() {
        if (isChallengeMode) {
            saveChallengeResult();
        }
        toggleView('result');
        document.getElementById('score-display').innerText = score;
        const rate = Math.round((score / currentQuestions.length) * 100);
        document.getElementById('score-detail').innerText = `æ­£ç¡®ç‡ ${rate}% Â· å…± ${currentQuestions.length} é¢˜`;
    }

    window.restartQuiz = function() {
        if (!confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿå½“å‰è¿›åº¦å°†è¢«æ¸…ç©ºã€‚')) return;
        
        clearProgress(); // æ¸…é™¤ç¼“å­˜
        currentIndex = 0;
        score = 0;
        answeredIndices.clear();
        userAnswersMap = {};
        questionStatusMap = {};
        
        toggleView('quiz');
        document.getElementById('progress-container').style.display = 'flex';
        renderNavGrid();
        loadQuestion();
    }

    function toggleTheme() {
        const checkbox = document.getElementById('theme-toggle-checkbox');
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        
        if (checkbox && checkbox.checked !== isDark) {
            checkbox.checked = isDark;
        }

        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    (function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        const isDark = savedTheme === 'dark' || (!savedTheme && prefersDark);
        
        if (isDark) {
            document.body.classList.add('dark-mode');
        }
        
        // åˆå§‹åŒ– checkbox çŠ¶æ€
        const checkbox = document.getElementById('theme-toggle-checkbox');
        if (checkbox) checkbox.checked = isDark;
    })();
</script>

</body>
</html>
